(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))t(r);new MutationObserver(r=>{for(const l of r)if(l.type==="childList")for(const o of l.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&t(o)}).observe(document,{childList:!0,subtree:!0});function e(r){const l={};return r.integrity&&(l.integrity=r.integrity),r.referrerPolicy&&(l.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?l.credentials="include":r.crossOrigin==="anonymous"?l.credentials="omit":l.credentials="same-origin",l}function t(r){if(r.ep)return;r.ep=!0;const l=e(r);fetch(r.href,l)}})();let EventEmitter$1=class{constructor(){this.handlers={}}on(n,e,t){if((t==null?void 0:t.once)===!0){const r=this.on(n,(l,o)=>{r(),e(l,o)});return r}else{const r=this.handlers[n]=this.handlers[n]??new Set([e]);return r.add(e),()=>r.delete(e)}}emit(n,e){for(const t of this.handlers[n]??[])try{t(e,this)}catch(r){console.error(`Error in Collabs event handler:
`,r)}}};function isRuntime(s){return typeof s=="object"&&s.isRuntime===!0}class InitToken{constructor(n,e){this.name=n,this.parent=e,this.isInitToken=!0}}class Collab extends EventEmitter$1{constructor(n){super(),this.runtime=isRuntime(n.parent)?n.parent:n.parent.runtime,this.parent=n.parent,this.name=n.name}emit(n,e,t){super.emit(n,e),!(t!=null&&t.skipAnyEvent)&&n!=="Any"&&super.emit("Any",{meta:e.meta})}send(n,e){this.parent.childSend(this,n,e)}canGC(){return!1}finalize(){}}class AbstractRuntime extends EventEmitter$1{constructor(n){if(super(),this.isRuntime=!0,n==="")throw new Error('replicaID must not be ""');this.replicaID=n}setRootCollab(n){const e=n(new InitToken("",this));return this.rootCollab=e,e}idOf(n){if(n.runtime!==this)throw new Error("idOf called with Collab from different Runtime");return this.rootCollab.idOf(n)}fromID(n){return this.rootCollab.fromID(n)}}function collabIDOf(s,n){let e=s;const t=[];for(;e!==n;){if(t.push(e.name),isRuntime(e.parent))throw new Error("collabIDOf called on non-descendant");e=e.parent}return{collabIDPath:t}}class ReplicaIDs{constructor(){}static random(length=this.DEFAULT_LENGTH){const arr=new Array(length);let randomValues=new Uint8Array(length);if(typeof window>"u"){const cryptoReal=eval("require")("crypto"),randomBuffer=cryptoReal.randomBytes(length);randomValues=new Uint8Array(randomBuffer)}else window.crypto.getRandomValues(randomValues);for(let s=0;s<length;s++)arr[s]=this.CHARS[randomValues[s]%64];return arr.join("")}static pseudoRandom(s,n=this.DEFAULT_LENGTH){const e=new Array(n);for(let t=0;t<e.length;t++)e[t]=this.CHARS[Math.floor(s()*64)];return e.join("")}}ReplicaIDs.CHARS="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";ReplicaIDs.DEFAULT_LENGTH=10;function nonNull(s){if(s==null)throw new Error("Internal error: non-null assertion failed");return s}class CObject extends Collab{constructor(){super(...arguments),this.children=new Map}registerCollab(n,e){if(this.children.has(n))throw new Error('Duplicate child name: "'+n+'"');const t=e(new InitToken(n,this));return this.children.set(n,t),t}childSend(n,e,t){if(n.parent!==this)throw new Error(`childSend called by non-child: ${n}`);e.push(n.name),this.send(e,t)}receive(n,e){if(n.length===0)throw new Error("CObject received message for itself");const t=this.children.get(n.pop());t!==void 0&&t.receive(n,e)}save(){const n=new Map;for(const[e,t]of this.children)n.set(e,t.save());return{children:n}}load(n,e){if(n===null){for(const t of this.children.values())t.canGC()||t.load(null,e);return}for(const[t,r]of nonNull(n.children)){const l=this.children.get(t);l!==void 0&&l.load(r,e)}}idOf(n){return collabIDOf(n,this)}fromID(n,e=0){const t=n.collabIDPath[e],r=this.children.get(t);if(r!==void 0){if(e===n.collabIDPath.length-1)return r;if(r.fromID===void 0)throw new Error("child is not a parent, but CollabID is its descendant");return r.fromID(n,e+1)}}canGC(){for(const n of this.children.values())if(!n.canGC())return!1;return!0}finalize(){for(const n of this.children.values())n.finalize()}}class CPrimitive extends Collab{sendPrimitive(n,e){this.send([n],e===void 0?[]:[e])}receive(n,e){if(n.length!==1)throw new Error("CPrimitive received message for child");this.receivePrimitive(n[0],e)}save(){return{self:this.savePrimitive()}}load(n,e){this.loadPrimitive(n===null?null:nonNull(n.self),e)}}function MakeAbstractList(s){class n extends s{constructor(...t){super(...t)}hasPosition(t){return this.indexOfPosition(t)!==-1}getByPosition(t){const r=this.indexOfPosition(t);return r===-1?void 0:this.get(r)}positionOf(t){const r=this.indexOf(t);return r===-1?void 0:this.getPosition(r)}clear(){for(let t=this.length-1;t>=0;t--)this.delete(t)}[Symbol.iterator](){return this.values()}*values(){for(const[,t]of this.entries())yield t}*positions(){for(const[,,t]of this.entries())yield t}toString(){return[...this.values()].toString()}push(...t){return this.insert(this.length,...t)}unshift(...t){return this.insert(0,...t)}forEach(t,r){for(const[l,o]of this.entries())t.call(r,o,l,this)}map(t,r){const l=new Array(this.length);for(const[o,a]of this.entries())l[o]=t.call(r,a,o,this);return l}slice(t,r){const l=this.length;if(t===void 0||t<-l)t=0;else if(t<0)t+=l;else if(t>=l)return[];if(r===void 0||r>=l?r=l:r<-l?r=0:r<0&&(r+=l),r<=t)return[];if(t===0&&r===l)return[...this.values()];{const o=new Array(r-t);for(let a=0;a<r-t;a++)o[a]=this.get(t+a);return o}}indexOf(t,r=0){if(r<0&&(r+=this.length),r<0&&(r=0),r===0){for(const[l,o]of this.entries())if(o===t)return l}else for(let l=r;l<this.length;l++)if(this.get(l)===t)return l;return-1}}return n}const AbstractList_Collab=MakeAbstractList(Collab),AbstractList_CObject=MakeAbstractList(CObject),AbstractList_CPrimitive=MakeAbstractList(CPrimitive);function MakeAbstractMap(s){class n extends s{constructor(...t){super(...t)}clear(){for(const t of this.keys())this.delete(t)}forEach(t,r){for(const[l,o]of this)t.call(r,o,l,this)}[Symbol.iterator](){return this.entries()}*keys(){for(const[t]of this)yield t}*values(){for(const[,t]of this)yield t}toString(){return[...this].toString()}keyOf(t){for(const[r,l]of this)if(l===t)return r}}return n}const AbstractMap_Collab=MakeAbstractMap(Collab),AbstractMap_CObject=MakeAbstractMap(CObject),AbstractMap_CPrimitive=MakeAbstractMap(CPrimitive);function MakeAbstractSet(s){class n extends s{constructor(...t){super(...t)}clear(){for(const t of this)this.delete(t)}forEach(t,r){for(const l of this)t.call(r,l,l,this)}[Symbol.iterator](){return this.values()}toString(){return[...this].toString()}}return n}const AbstractSet_Collab=MakeAbstractSet(Collab),AbstractSet_CObject=MakeAbstractSet(CObject),AbstractSet_CPrimitive=MakeAbstractSet(CPrimitive);class CConst extends CPrimitive{constructor(n,e){super(n),this.value=e}receivePrimitive(){}savePrimitive(){return new Uint8Array}loadPrimitive(){}canGC(){return!0}}var commonjsGlobal=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},toByteArray_1=toByteArray,fromByteArray_1=fromByteArray,lookup=[],revLookup=[],Arr=typeof Uint8Array<"u"?Uint8Array:Array,code="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";for(var i=0,len=code.length;i<len;++i)lookup[i]=code[i],revLookup[code.charCodeAt(i)]=i;revLookup[45]=62;revLookup[95]=63;function getLens(s){var n=s.length;if(n%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var e=s.indexOf("=");e===-1&&(e=n);var t=e===n?0:4-e%4;return[e,t]}function _byteLength(s,n,e){return(n+e)*3/4-e}function toByteArray(s){var n,e=getLens(s),t=e[0],r=e[1],l=new Arr(_byteLength(s,t,r)),o=0,a=r>0?t-4:t,u;for(u=0;u<a;u+=4)n=revLookup[s.charCodeAt(u)]<<18|revLookup[s.charCodeAt(u+1)]<<12|revLookup[s.charCodeAt(u+2)]<<6|revLookup[s.charCodeAt(u+3)],l[o++]=n>>16&255,l[o++]=n>>8&255,l[o++]=n&255;return r===2&&(n=revLookup[s.charCodeAt(u)]<<2|revLookup[s.charCodeAt(u+1)]>>4,l[o++]=n&255),r===1&&(n=revLookup[s.charCodeAt(u)]<<10|revLookup[s.charCodeAt(u+1)]<<4|revLookup[s.charCodeAt(u+2)]>>2,l[o++]=n>>8&255,l[o++]=n&255),l}function tripletToBase64(s){return lookup[s>>18&63]+lookup[s>>12&63]+lookup[s>>6&63]+lookup[s&63]}function encodeChunk(s,n,e){for(var t,r=[],l=n;l<e;l+=3)t=(s[l]<<16&16711680)+(s[l+1]<<8&65280)+(s[l+2]&255),r.push(tripletToBase64(t));return r.join("")}function fromByteArray(s){for(var n,e=s.length,t=e%3,r=[],l=16383,o=0,a=e-t;o<a;o+=l)r.push(encodeChunk(s,o,o+l>a?a:o+l));return t===1?(n=s[e-1],r.push(lookup[n>>2]+lookup[n<<4&63]+"==")):t===2&&(n=(s[e-2]<<8)+s[e-1],r.push(lookup[n>>10]+lookup[n>>4&63]+lookup[n<<2&63]+"=")),r.join("")}class Cursors{constructor(){}static fromIndex(n,e){return n===0?"START":e.getPosition(n-1)}static toIndex(n,e){return n==="START"?0:e.indexOfPosition(n,"left")+1}}var indexMinimal={},minimal$1={},aspromise=asPromise;function asPromise(s,n){for(var e=new Array(arguments.length-1),t=0,r=2,l=!0;r<arguments.length;)e[t++]=arguments[r++];return new Promise(function(a,u){e[t]=function(f){if(l)if(l=!1,f)u(f);else{for(var d=new Array(arguments.length-1),h=0;h<d.length;)d[h++]=arguments[h];a.apply(null,d)}};try{s.apply(n||null,e)}catch(c){l&&(l=!1,u(c))}})}var base64$1={};(function(s){var n=s;n.length=function(a){var u=a.length;if(!u)return 0;for(var c=0;--u%4>1&&a.charAt(u)==="=";)++c;return Math.ceil(a.length*3)/4-c};for(var e=new Array(64),t=new Array(123),r=0;r<64;)t[e[r]=r<26?r+65:r<52?r+71:r<62?r-4:r-59|43]=r++;n.encode=function(a,u,c){for(var f=null,d=[],h=0,p=0,y;u<c;){var b=a[u++];switch(p){case 0:d[h++]=e[b>>2],y=(b&3)<<4,p=1;break;case 1:d[h++]=e[y|b>>4],y=(b&15)<<2,p=2;break;case 2:d[h++]=e[y|b>>6],d[h++]=e[b&63],p=0;break}h>8191&&((f||(f=[])).push(String.fromCharCode.apply(String,d)),h=0)}return p&&(d[h++]=e[y],d[h++]=61,p===1&&(d[h++]=61)),f?(h&&f.push(String.fromCharCode.apply(String,d.slice(0,h))),f.join("")):String.fromCharCode.apply(String,d.slice(0,h))};var l="invalid encoding";n.decode=function(a,u,c){for(var f=c,d=0,h,p=0;p<a.length;){var y=a.charCodeAt(p++);if(y===61&&d>1)break;if((y=t[y])===void 0)throw Error(l);switch(d){case 0:h=y,d=1;break;case 1:u[c++]=h<<2|(y&48)>>4,h=y,d=2;break;case 2:u[c++]=(h&15)<<4|(y&60)>>2,h=y,d=3;break;case 3:u[c++]=(h&3)<<6|y,d=0;break}}if(d===1)throw Error(l);return c-f},n.test=function(a){return/^(?:[A-Za-z0-9+/]{4})*(?:[A-Za-z0-9+/]{2}==|[A-Za-z0-9+/]{3}=)?$/.test(a)}})(base64$1);var eventemitter=EventEmitter;function EventEmitter(){this._listeners={}}EventEmitter.prototype.on=function s(n,e,t){return(this._listeners[n]||(this._listeners[n]=[])).push({fn:e,ctx:t||this}),this};EventEmitter.prototype.off=function s(n,e){if(n===void 0)this._listeners={};else if(e===void 0)this._listeners[n]=[];else for(var t=this._listeners[n],r=0;r<t.length;)t[r].fn===e?t.splice(r,1):++r;return this};EventEmitter.prototype.emit=function s(n){var e=this._listeners[n];if(e){for(var t=[],r=1;r<arguments.length;)t.push(arguments[r++]);for(r=0;r<e.length;)e[r].fn.apply(e[r++].ctx,t)}return this};var float=factory(factory);function factory(s){return typeof Float32Array<"u"?function(){var n=new Float32Array([-0]),e=new Uint8Array(n.buffer),t=e[3]===128;function r(u,c,f){n[0]=u,c[f]=e[0],c[f+1]=e[1],c[f+2]=e[2],c[f+3]=e[3]}function l(u,c,f){n[0]=u,c[f]=e[3],c[f+1]=e[2],c[f+2]=e[1],c[f+3]=e[0]}s.writeFloatLE=t?r:l,s.writeFloatBE=t?l:r;function o(u,c){return e[0]=u[c],e[1]=u[c+1],e[2]=u[c+2],e[3]=u[c+3],n[0]}function a(u,c){return e[3]=u[c],e[2]=u[c+1],e[1]=u[c+2],e[0]=u[c+3],n[0]}s.readFloatLE=t?o:a,s.readFloatBE=t?a:o}():function(){function n(t,r,l,o){var a=r<0?1:0;if(a&&(r=-r),r===0)t(1/r>0?0:2147483648,l,o);else if(isNaN(r))t(2143289344,l,o);else if(r>34028234663852886e22)t((a<<31|2139095040)>>>0,l,o);else if(r<11754943508222875e-54)t((a<<31|Math.round(r/1401298464324817e-60))>>>0,l,o);else{var u=Math.floor(Math.log(r)/Math.LN2),c=Math.round(r*Math.pow(2,-u)*8388608)&8388607;t((a<<31|u+127<<23|c)>>>0,l,o)}}s.writeFloatLE=n.bind(null,writeUintLE),s.writeFloatBE=n.bind(null,writeUintBE);function e(t,r,l){var o=t(r,l),a=(o>>31)*2+1,u=o>>>23&255,c=o&8388607;return u===255?c?NaN:a*(1/0):u===0?a*1401298464324817e-60*c:a*Math.pow(2,u-150)*(c+8388608)}s.readFloatLE=e.bind(null,readUintLE),s.readFloatBE=e.bind(null,readUintBE)}(),typeof Float64Array<"u"?function(){var n=new Float64Array([-0]),e=new Uint8Array(n.buffer),t=e[7]===128;function r(u,c,f){n[0]=u,c[f]=e[0],c[f+1]=e[1],c[f+2]=e[2],c[f+3]=e[3],c[f+4]=e[4],c[f+5]=e[5],c[f+6]=e[6],c[f+7]=e[7]}function l(u,c,f){n[0]=u,c[f]=e[7],c[f+1]=e[6],c[f+2]=e[5],c[f+3]=e[4],c[f+4]=e[3],c[f+5]=e[2],c[f+6]=e[1],c[f+7]=e[0]}s.writeDoubleLE=t?r:l,s.writeDoubleBE=t?l:r;function o(u,c){return e[0]=u[c],e[1]=u[c+1],e[2]=u[c+2],e[3]=u[c+3],e[4]=u[c+4],e[5]=u[c+5],e[6]=u[c+6],e[7]=u[c+7],n[0]}function a(u,c){return e[7]=u[c],e[6]=u[c+1],e[5]=u[c+2],e[4]=u[c+3],e[3]=u[c+4],e[2]=u[c+5],e[1]=u[c+6],e[0]=u[c+7],n[0]}s.readDoubleLE=t?o:a,s.readDoubleBE=t?a:o}():function(){function n(t,r,l,o,a,u){var c=o<0?1:0;if(c&&(o=-o),o===0)t(0,a,u+r),t(1/o>0?0:2147483648,a,u+l);else if(isNaN(o))t(0,a,u+r),t(2146959360,a,u+l);else if(o>17976931348623157e292)t(0,a,u+r),t((c<<31|2146435072)>>>0,a,u+l);else{var f;if(o<22250738585072014e-324)f=o/5e-324,t(f>>>0,a,u+r),t((c<<31|f/4294967296)>>>0,a,u+l);else{var d=Math.floor(Math.log(o)/Math.LN2);d===1024&&(d=1023),f=o*Math.pow(2,-d),t(f*4503599627370496>>>0,a,u+r),t((c<<31|d+1023<<20|f*1048576&1048575)>>>0,a,u+l)}}}s.writeDoubleLE=n.bind(null,writeUintLE,0,4),s.writeDoubleBE=n.bind(null,writeUintBE,4,0);function e(t,r,l,o,a){var u=t(o,a+r),c=t(o,a+l),f=(c>>31)*2+1,d=c>>>20&2047,h=4294967296*(c&1048575)+u;return d===2047?h?NaN:f*(1/0):d===0?f*5e-324*h:f*Math.pow(2,d-1075)*(h+4503599627370496)}s.readDoubleLE=e.bind(null,readUintLE,0,4),s.readDoubleBE=e.bind(null,readUintBE,4,0)}(),s}function writeUintLE(s,n,e){n[e]=s&255,n[e+1]=s>>>8&255,n[e+2]=s>>>16&255,n[e+3]=s>>>24}function writeUintBE(s,n,e){n[e]=s>>>24,n[e+1]=s>>>16&255,n[e+2]=s>>>8&255,n[e+3]=s&255}function readUintLE(s,n){return(s[n]|s[n+1]<<8|s[n+2]<<16|s[n+3]<<24)>>>0}function readUintBE(s,n){return(s[n]<<24|s[n+1]<<16|s[n+2]<<8|s[n+3])>>>0}var inquire_1=inquire;function inquire(moduleName){try{var mod=eval("quire".replace(/^/,"re"))(moduleName);if(mod&&(mod.length||Object.keys(mod).length))return mod}catch(s){}return null}var utf8$2={};(function(s){var n=s;n.length=function(t){for(var r=0,l=0,o=0;o<t.length;++o)l=t.charCodeAt(o),l<128?r+=1:l<2048?r+=2:(l&64512)===55296&&(t.charCodeAt(o+1)&64512)===56320?(++o,r+=4):r+=3;return r},n.read=function(t,r,l){var o=l-r;if(o<1)return"";for(var a=null,u=[],c=0,f;r<l;)f=t[r++],f<128?u[c++]=f:f>191&&f<224?u[c++]=(f&31)<<6|t[r++]&63:f>239&&f<365?(f=((f&7)<<18|(t[r++]&63)<<12|(t[r++]&63)<<6|t[r++]&63)-65536,u[c++]=55296+(f>>10),u[c++]=56320+(f&1023)):u[c++]=(f&15)<<12|(t[r++]&63)<<6|t[r++]&63,c>8191&&((a||(a=[])).push(String.fromCharCode.apply(String,u)),c=0);return a?(c&&a.push(String.fromCharCode.apply(String,u.slice(0,c))),a.join("")):String.fromCharCode.apply(String,u.slice(0,c))},n.write=function(t,r,l){for(var o=l,a,u,c=0;c<t.length;++c)a=t.charCodeAt(c),a<128?r[l++]=a:a<2048?(r[l++]=a>>6|192,r[l++]=a&63|128):(a&64512)===55296&&((u=t.charCodeAt(c+1))&64512)===56320?(a=65536+((a&1023)<<10)+(u&1023),++c,r[l++]=a>>18|240,r[l++]=a>>12&63|128,r[l++]=a>>6&63|128,r[l++]=a&63|128):(r[l++]=a>>12|224,r[l++]=a>>6&63|128,r[l++]=a&63|128);return l-o}})(utf8$2);var pool_1=pool;function pool(s,n,e){var t=e||8192,r=t>>>1,l=null,o=t;return function(u){if(u<1||u>r)return s(u);o+u>t&&(l=s(t),o=0);var c=n.call(l,o,o+=u);return o&7&&(o=(o|7)+1),c}}var longbits,hasRequiredLongbits;function requireLongbits(){if(hasRequiredLongbits)return longbits;hasRequiredLongbits=1,longbits=n;var s=requireMinimal();function n(l,o){this.lo=l>>>0,this.hi=o>>>0}var e=n.zero=new n(0,0);e.toNumber=function(){return 0},e.zzEncode=e.zzDecode=function(){return this},e.length=function(){return 1};var t=n.zeroHash="\0\0\0\0\0\0\0\0";n.fromNumber=function(o){if(o===0)return e;var a=o<0;a&&(o=-o);var u=o>>>0,c=(o-u)/4294967296>>>0;return a&&(c=~c>>>0,u=~u>>>0,++u>4294967295&&(u=0,++c>4294967295&&(c=0))),new n(u,c)},n.from=function(o){if(typeof o=="number")return n.fromNumber(o);if(s.isString(o))if(s.Long)o=s.Long.fromString(o);else return n.fromNumber(parseInt(o,10));return o.low||o.high?new n(o.low>>>0,o.high>>>0):e},n.prototype.toNumber=function(o){if(!o&&this.hi>>>31){var a=~this.lo+1>>>0,u=~this.hi>>>0;return a||(u=u+1>>>0),-(a+u*4294967296)}return this.lo+this.hi*4294967296},n.prototype.toLong=function(o){return s.Long?new s.Long(this.lo|0,this.hi|0,!!o):{low:this.lo|0,high:this.hi|0,unsigned:!!o}};var r=String.prototype.charCodeAt;return n.fromHash=function(o){return o===t?e:new n((r.call(o,0)|r.call(o,1)<<8|r.call(o,2)<<16|r.call(o,3)<<24)>>>0,(r.call(o,4)|r.call(o,5)<<8|r.call(o,6)<<16|r.call(o,7)<<24)>>>0)},n.prototype.toHash=function(){return String.fromCharCode(this.lo&255,this.lo>>>8&255,this.lo>>>16&255,this.lo>>>24,this.hi&255,this.hi>>>8&255,this.hi>>>16&255,this.hi>>>24)},n.prototype.zzEncode=function(){var o=this.hi>>31;return this.hi=((this.hi<<1|this.lo>>>31)^o)>>>0,this.lo=(this.lo<<1^o)>>>0,this},n.prototype.zzDecode=function(){var o=-(this.lo&1);return this.lo=((this.lo>>>1|this.hi<<31)^o)>>>0,this.hi=(this.hi>>>1^o)>>>0,this},n.prototype.length=function(){var o=this.lo,a=(this.lo>>>28|this.hi<<4)>>>0,u=this.hi>>>24;return u===0?a===0?o<16384?o<128?1:2:o<2097152?3:4:a<16384?a<128?5:6:a<2097152?7:8:u<128?9:10},longbits}var hasRequiredMinimal;function requireMinimal(){return hasRequiredMinimal||(hasRequiredMinimal=1,function(s){var n=s;n.asPromise=aspromise,n.base64=base64$1,n.EventEmitter=eventemitter,n.float=float,n.inquire=inquire_1,n.utf8=utf8$2,n.pool=pool_1,n.LongBits=requireLongbits(),n.global=typeof window<"u"&&window||typeof commonjsGlobal<"u"&&commonjsGlobal||typeof self<"u"&&self||commonjsGlobal,n.emptyArray=Object.freeze?Object.freeze([]):[],n.emptyObject=Object.freeze?Object.freeze({}):{},n.isNode=!!(n.global.process&&n.global.process.versions&&n.global.process.versions.node),n.isInteger=Number.isInteger||function(l){return typeof l=="number"&&isFinite(l)&&Math.floor(l)===l},n.isString=function(l){return typeof l=="string"||l instanceof String},n.isObject=function(l){return l&&typeof l=="object"},n.isset=n.isSet=function(l,o){var a=l[o];return a!=null&&l.hasOwnProperty(o)?typeof a!="object"||(Array.isArray(a)?a.length:Object.keys(a).length)>0:!1},n.Buffer=function(){try{var r=n.inquire("buffer").Buffer;return r.prototype.utf8Write?r:null}catch{return null}}(),n._Buffer_from=null,n._Buffer_allocUnsafe=null,n.newBuffer=function(l){return typeof l=="number"?n.Buffer?n._Buffer_allocUnsafe(l):new n.Array(l):n.Buffer?n._Buffer_from(l):typeof Uint8Array>"u"?l:new Uint8Array(l)},n.Array=typeof Uint8Array<"u"?Uint8Array:Array,n.Long=n.global.dcodeIO&&n.global.dcodeIO.Long||n.global.Long||n.inquire("long"),n.key2Re=/^true|false|0|1$/,n.key32Re=/^-?(?:0|[1-9][0-9]*)$/,n.key64Re=/^(?:[\\x00-\\xff]{8}|-?(?:0|[1-9][0-9]*))$/,n.longToHash=function(l){return l?n.LongBits.from(l).toHash():n.LongBits.zeroHash},n.longFromHash=function(l,o){var a=n.LongBits.fromHash(l);return n.Long?n.Long.fromBits(a.lo,a.hi,o):a.toNumber(!!o)};function e(r,l,o){for(var a=Object.keys(l),u=0;u<a.length;++u)(r[a[u]]===void 0||!o)&&(r[a[u]]=l[a[u]]);return r}n.merge=e,n.lcFirst=function(l){return l.charAt(0).toLowerCase()+l.substring(1)};function t(r){function l(o,a){if(!(this instanceof l))return new l(o,a);Object.defineProperty(this,"message",{get:function(){return o}}),Error.captureStackTrace?Error.captureStackTrace(this,l):Object.defineProperty(this,"stack",{value:new Error().stack||""}),a&&e(this,a)}return(l.prototype=Object.create(Error.prototype)).constructor=l,Object.defineProperty(l.prototype,"name",{get:function(){return r}}),l.prototype.toString=function(){return this.name+": "+this.message},l}n.newError=t,n.ProtocolError=t("ProtocolError"),n.oneOfGetter=function(l){for(var o={},a=0;a<l.length;++a)o[l[a]]=1;return function(){for(var u=Object.keys(this),c=u.length-1;c>-1;--c)if(o[u[c]]===1&&this[u[c]]!==void 0&&this[u[c]]!==null)return u[c]}},n.oneOfSetter=function(l){return function(o){for(var a=0;a<l.length;++a)l[a]!==o&&delete this[l[a]]}},n.toJSONOptions={longs:String,enums:String,bytes:String,json:!0},n._configure=function(){var r=n.Buffer;if(!r){n._Buffer_from=n._Buffer_allocUnsafe=null;return}n._Buffer_from=r.from!==Uint8Array.from&&r.from||function(o,a){return new r(o,a)},n._Buffer_allocUnsafe=r.allocUnsafe||function(o){return new r(o)}}}(minimal$1)),minimal$1}var writer=Writer$1,util$4=requireMinimal(),BufferWriter$1,LongBits$1=util$4.LongBits,base64=util$4.base64,utf8$1=util$4.utf8;function Op(s,n,e){this.fn=s,this.len=n,this.next=void 0,this.val=e}function noop(){}function State(s){this.head=s.head,this.tail=s.tail,this.len=s.len,this.next=s.states}function Writer$1(){this.len=0,this.head=new Op(noop,0,0),this.tail=this.head,this.states=null}var create$1=function s(){return util$4.Buffer?function(){return(Writer$1.create=function(){return new BufferWriter$1})()}:function(){return new Writer$1}};Writer$1.create=create$1();Writer$1.alloc=function s(n){return new util$4.Array(n)};util$4.Array!==Array&&(Writer$1.alloc=util$4.pool(Writer$1.alloc,util$4.Array.prototype.subarray));Writer$1.prototype._push=function s(n,e,t){return this.tail=this.tail.next=new Op(n,e,t),this.len+=e,this};function writeByte(s,n,e){n[e]=s&255}function writeVarint32(s,n,e){for(;s>127;)n[e++]=s&127|128,s>>>=7;n[e]=s}function VarintOp(s,n){this.len=s,this.next=void 0,this.val=n}VarintOp.prototype=Object.create(Op.prototype);VarintOp.prototype.fn=writeVarint32;Writer$1.prototype.uint32=function s(n){return this.len+=(this.tail=this.tail.next=new VarintOp((n=n>>>0)<128?1:n<16384?2:n<2097152?3:n<268435456?4:5,n)).len,this};Writer$1.prototype.int32=function s(n){return n<0?this._push(writeVarint64,10,LongBits$1.fromNumber(n)):this.uint32(n)};Writer$1.prototype.sint32=function s(n){return this.uint32((n<<1^n>>31)>>>0)};function writeVarint64(s,n,e){for(;s.hi;)n[e++]=s.lo&127|128,s.lo=(s.lo>>>7|s.hi<<25)>>>0,s.hi>>>=7;for(;s.lo>127;)n[e++]=s.lo&127|128,s.lo=s.lo>>>7;n[e++]=s.lo}Writer$1.prototype.uint64=function s(n){var e=LongBits$1.from(n);return this._push(writeVarint64,e.length(),e)};Writer$1.prototype.int64=Writer$1.prototype.uint64;Writer$1.prototype.sint64=function s(n){var e=LongBits$1.from(n).zzEncode();return this._push(writeVarint64,e.length(),e)};Writer$1.prototype.bool=function s(n){return this._push(writeByte,1,n?1:0)};function writeFixed32(s,n,e){n[e]=s&255,n[e+1]=s>>>8&255,n[e+2]=s>>>16&255,n[e+3]=s>>>24}Writer$1.prototype.fixed32=function s(n){return this._push(writeFixed32,4,n>>>0)};Writer$1.prototype.sfixed32=Writer$1.prototype.fixed32;Writer$1.prototype.fixed64=function s(n){var e=LongBits$1.from(n);return this._push(writeFixed32,4,e.lo)._push(writeFixed32,4,e.hi)};Writer$1.prototype.sfixed64=Writer$1.prototype.fixed64;Writer$1.prototype.float=function s(n){return this._push(util$4.float.writeFloatLE,4,n)};Writer$1.prototype.double=function s(n){return this._push(util$4.float.writeDoubleLE,8,n)};var writeBytes=util$4.Array.prototype.set?function s(n,e,t){e.set(n,t)}:function s(n,e,t){for(var r=0;r<n.length;++r)e[t+r]=n[r]};Writer$1.prototype.bytes=function s(n){var e=n.length>>>0;if(!e)return this._push(writeByte,1,0);if(util$4.isString(n)){var t=Writer$1.alloc(e=base64.length(n));base64.decode(n,t,0),n=t}return this.uint32(e)._push(writeBytes,e,n)};Writer$1.prototype.string=function s(n){var e=utf8$1.length(n);return e?this.uint32(e)._push(utf8$1.write,e,n):this._push(writeByte,1,0)};Writer$1.prototype.fork=function s(){return this.states=new State(this),this.head=this.tail=new Op(noop,0,0),this.len=0,this};Writer$1.prototype.reset=function s(){return this.states?(this.head=this.states.head,this.tail=this.states.tail,this.len=this.states.len,this.states=this.states.next):(this.head=this.tail=new Op(noop,0,0),this.len=0),this};Writer$1.prototype.ldelim=function s(){var n=this.head,e=this.tail,t=this.len;return this.reset().uint32(t),t&&(this.tail.next=n.next,this.tail=e,this.len+=t),this};Writer$1.prototype.finish=function s(){for(var n=this.head.next,e=this.constructor.alloc(this.len),t=0;n;)n.fn(n.val,e,t),t+=n.len,n=n.next;return e};Writer$1._configure=function(s){BufferWriter$1=s,Writer$1.create=create$1(),BufferWriter$1._configure()};var writer_buffer=BufferWriter,Writer=writer;(BufferWriter.prototype=Object.create(Writer.prototype)).constructor=BufferWriter;var util$3=requireMinimal();function BufferWriter(){Writer.call(this)}BufferWriter._configure=function(){BufferWriter.alloc=util$3._Buffer_allocUnsafe,BufferWriter.writeBytesBuffer=util$3.Buffer&&util$3.Buffer.prototype instanceof Uint8Array&&util$3.Buffer.prototype.set.name==="set"?function(n,e,t){e.set(n,t)}:function(n,e,t){if(n.copy)n.copy(e,t,0,n.length);else for(var r=0;r<n.length;)e[t++]=n[r++]}};BufferWriter.prototype.bytes=function s(n){util$3.isString(n)&&(n=util$3._Buffer_from(n,"base64"));var e=n.length>>>0;return this.uint32(e),e&&this._push(BufferWriter.writeBytesBuffer,e,n),this};function writeStringBuffer(s,n,e){s.length<40?util$3.utf8.write(s,n,e):n.utf8Write?n.utf8Write(s,e):n.write(s,e)}BufferWriter.prototype.string=function s(n){var e=util$3.Buffer.byteLength(n);return this.uint32(e),e&&this._push(writeStringBuffer,e,n),this};BufferWriter._configure();var reader=Reader$1,util$2=requireMinimal(),BufferReader$1,LongBits=util$2.LongBits,utf8=util$2.utf8;function indexOutOfRange(s,n){return RangeError("index out of range: "+s.pos+" + "+(n||1)+" > "+s.len)}function Reader$1(s){this.buf=s,this.pos=0,this.len=s.length}var create_array=typeof Uint8Array<"u"?function s(n){if(n instanceof Uint8Array||Array.isArray(n))return new Reader$1(n);throw Error("illegal buffer")}:function s(n){if(Array.isArray(n))return new Reader$1(n);throw Error("illegal buffer")},create=function s(){return util$2.Buffer?function(e){return(Reader$1.create=function(r){return util$2.Buffer.isBuffer(r)?new BufferReader$1(r):create_array(r)})(e)}:create_array};Reader$1.create=create();Reader$1.prototype._slice=util$2.Array.prototype.subarray||util$2.Array.prototype.slice;Reader$1.prototype.uint32=function s(){var n=4294967295;return function(){if(n=(this.buf[this.pos]&127)>>>0,this.buf[this.pos++]<128||(n=(n|(this.buf[this.pos]&127)<<7)>>>0,this.buf[this.pos++]<128)||(n=(n|(this.buf[this.pos]&127)<<14)>>>0,this.buf[this.pos++]<128)||(n=(n|(this.buf[this.pos]&127)<<21)>>>0,this.buf[this.pos++]<128)||(n=(n|(this.buf[this.pos]&15)<<28)>>>0,this.buf[this.pos++]<128))return n;if((this.pos+=5)>this.len)throw this.pos=this.len,indexOutOfRange(this,10);return n}}();Reader$1.prototype.int32=function s(){return this.uint32()|0};Reader$1.prototype.sint32=function s(){var n=this.uint32();return n>>>1^-(n&1)|0};function readLongVarint(){var s=new LongBits(0,0),n=0;if(this.len-this.pos>4){for(;n<4;++n)if(s.lo=(s.lo|(this.buf[this.pos]&127)<<n*7)>>>0,this.buf[this.pos++]<128)return s;if(s.lo=(s.lo|(this.buf[this.pos]&127)<<28)>>>0,s.hi=(s.hi|(this.buf[this.pos]&127)>>4)>>>0,this.buf[this.pos++]<128)return s;n=0}else{for(;n<3;++n){if(this.pos>=this.len)throw indexOutOfRange(this);if(s.lo=(s.lo|(this.buf[this.pos]&127)<<n*7)>>>0,this.buf[this.pos++]<128)return s}return s.lo=(s.lo|(this.buf[this.pos++]&127)<<n*7)>>>0,s}if(this.len-this.pos>4){for(;n<5;++n)if(s.hi=(s.hi|(this.buf[this.pos]&127)<<n*7+3)>>>0,this.buf[this.pos++]<128)return s}else for(;n<5;++n){if(this.pos>=this.len)throw indexOutOfRange(this);if(s.hi=(s.hi|(this.buf[this.pos]&127)<<n*7+3)>>>0,this.buf[this.pos++]<128)return s}throw Error("invalid varint encoding")}Reader$1.prototype.bool=function s(){return this.uint32()!==0};function readFixed32_end(s,n){return(s[n-4]|s[n-3]<<8|s[n-2]<<16|s[n-1]<<24)>>>0}Reader$1.prototype.fixed32=function s(){if(this.pos+4>this.len)throw indexOutOfRange(this,4);return readFixed32_end(this.buf,this.pos+=4)};Reader$1.prototype.sfixed32=function s(){if(this.pos+4>this.len)throw indexOutOfRange(this,4);return readFixed32_end(this.buf,this.pos+=4)|0};function readFixed64(){if(this.pos+8>this.len)throw indexOutOfRange(this,8);return new LongBits(readFixed32_end(this.buf,this.pos+=4),readFixed32_end(this.buf,this.pos+=4))}Reader$1.prototype.float=function s(){if(this.pos+4>this.len)throw indexOutOfRange(this,4);var n=util$2.float.readFloatLE(this.buf,this.pos);return this.pos+=4,n};Reader$1.prototype.double=function s(){if(this.pos+8>this.len)throw indexOutOfRange(this,4);var n=util$2.float.readDoubleLE(this.buf,this.pos);return this.pos+=8,n};Reader$1.prototype.bytes=function s(){var n=this.uint32(),e=this.pos,t=this.pos+n;if(t>this.len)throw indexOutOfRange(this,n);return this.pos+=n,Array.isArray(this.buf)?this.buf.slice(e,t):e===t?new this.buf.constructor(0):this._slice.call(this.buf,e,t)};Reader$1.prototype.string=function s(){var n=this.bytes();return utf8.read(n,0,n.length)};Reader$1.prototype.skip=function s(n){if(typeof n=="number"){if(this.pos+n>this.len)throw indexOutOfRange(this,n);this.pos+=n}else do if(this.pos>=this.len)throw indexOutOfRange(this);while(this.buf[this.pos++]&128);return this};Reader$1.prototype.skipType=function(s){switch(s){case 0:this.skip();break;case 1:this.skip(8);break;case 2:this.skip(this.uint32());break;case 3:for(;(s=this.uint32()&7)!==4;)this.skipType(s);break;case 5:this.skip(4);break;default:throw Error("invalid wire type "+s+" at offset "+this.pos)}return this};Reader$1._configure=function(s){BufferReader$1=s,Reader$1.create=create(),BufferReader$1._configure();var n=util$2.Long?"toLong":"toNumber";util$2.merge(Reader$1.prototype,{int64:function(){return readLongVarint.call(this)[n](!1)},uint64:function(){return readLongVarint.call(this)[n](!0)},sint64:function(){return readLongVarint.call(this).zzDecode()[n](!1)},fixed64:function(){return readFixed64.call(this)[n](!0)},sfixed64:function(){return readFixed64.call(this)[n](!1)}})};var reader_buffer=BufferReader,Reader=reader;(BufferReader.prototype=Object.create(Reader.prototype)).constructor=BufferReader;var util$1=requireMinimal();function BufferReader(s){Reader.call(this,s)}BufferReader._configure=function(){util$1.Buffer&&(BufferReader.prototype._slice=util$1.Buffer.prototype.slice)};BufferReader.prototype.string=function s(){var n=this.uint32();return this.buf.utf8Slice?this.buf.utf8Slice(this.pos,this.pos=Math.min(this.pos+n,this.len)):this.buf.toString("utf-8",this.pos,this.pos=Math.min(this.pos+n,this.len))};BufferReader._configure();var rpc={},service=Service,util=requireMinimal();(Service.prototype=Object.create(util.EventEmitter.prototype)).constructor=Service;function Service(s,n,e){if(typeof s!="function")throw TypeError("rpcImpl must be a function");util.EventEmitter.call(this),this.rpcImpl=s,this.requestDelimited=!!n,this.responseDelimited=!!e}Service.prototype.rpcCall=function s(n,e,t,r,l){if(!r)throw TypeError("request must be specified");var o=this;if(!l)return util.asPromise(s,o,n,e,t,r);if(!o.rpcImpl){setTimeout(function(){l(Error("already ended"))},0);return}try{return o.rpcImpl(n,e[o.requestDelimited?"encodeDelimited":"encode"](r).finish(),function(u,c){if(u)return o.emit("error",u,n),l(u);if(c===null){o.end(!0);return}if(!(c instanceof t))try{c=t[o.responseDelimited?"decodeDelimited":"decode"](c)}catch(f){return o.emit("error",f,n),l(f)}return o.emit("data",c,n),l(null,c)})}catch(a){o.emit("error",a,n),setTimeout(function(){l(a)},0);return}};Service.prototype.end=function s(n){return this.rpcImpl&&(n||this.rpcImpl(null,null,null),this.rpcImpl=null,this.emit("end").off()),this};(function(s){var n=s;n.Service=service})(rpc);var roots={};(function(s){var n=s;n.build="minimal",n.Writer=writer,n.BufferWriter=writer_buffer,n.Reader=reader,n.BufferReader=reader_buffer,n.util=requireMinimal(),n.rpc=rpc,n.roots=roots,n.configure=e;function e(){n.util._configure(),n.Writer._configure(n.BufferWriter),n.Reader._configure(n.BufferReader)}e()})(indexMinimal);var minimal=indexMinimal;const $Reader$2=minimal.Reader,$Writer$2=minimal.Writer,$util$2=minimal.util;minimal.roots.default||(minimal.roots.default={});const MessageStacksMessage=(()=>{function s(n){if(this.edgeLabelLengths=[],this.edgeParents=[],this.messageStackIDs=[],n)for(let e=Object.keys(n),t=0;t<e.length;++t)n[e[t]]!=null&&(this[e[t]]=n[e[t]])}return s.prototype.edgeLabelsPacked=$util$2.newBuffer([]),s.prototype.edgeLabelLengths=$util$2.emptyArray,s.prototype.edgeParents=$util$2.emptyArray,s.prototype.messageStackIDs=$util$2.emptyArray,s.create=function(e){return new s(e)},s.encode=function(e,t){if(t||(t=$Writer$2.create()),t.uint32(10).bytes(e.edgeLabelsPacked),e.edgeLabelLengths!=null&&e.edgeLabelLengths.length){t.uint32(18).fork();for(let r=0;r<e.edgeLabelLengths.length;++r)t.sint32(e.edgeLabelLengths[r]);t.ldelim()}if(e.edgeParents!=null&&e.edgeParents.length){t.uint32(26).fork();for(let r=0;r<e.edgeParents.length;++r)t.uint32(e.edgeParents[r]);t.ldelim()}if(e.messageStackIDs!=null&&e.messageStackIDs.length){t.uint32(34).fork();for(let r=0;r<e.messageStackIDs.length;++r)t.uint32(e.messageStackIDs[r]);t.ldelim()}return t},s.encodeDelimited=function(e,t){return this.encode(e,t).ldelim()},s.decode=function(e,t){e instanceof $Reader$2||(e=$Reader$2.create(e));let r=t===void 0?e.len:e.pos+t,l=new s;for(;e.pos<r;){let o=e.uint32();switch(o>>>3){case 1:l.edgeLabelsPacked=e.bytes();break;case 2:if(l.edgeLabelLengths&&l.edgeLabelLengths.length||(l.edgeLabelLengths=[]),(o&7)===2){let a=e.uint32()+e.pos;for(;e.pos<a;)l.edgeLabelLengths.push(e.sint32())}else l.edgeLabelLengths.push(e.sint32());break;case 3:if(l.edgeParents&&l.edgeParents.length||(l.edgeParents=[]),(o&7)===2){let a=e.uint32()+e.pos;for(;e.pos<a;)l.edgeParents.push(e.uint32())}else l.edgeParents.push(e.uint32());break;case 4:if(l.messageStackIDs&&l.messageStackIDs.length||(l.messageStackIDs=[]),(o&7)===2){let a=e.uint32()+e.pos;for(;e.pos<a;)l.messageStackIDs.push(e.uint32())}else l.messageStackIDs.push(e.uint32());break;default:e.skipType(o&7);break}}if(!l.hasOwnProperty("edgeLabelsPacked"))throw $util$2.ProtocolError("missing required 'edgeLabelsPacked'",{instance:l});return l},s.decodeDelimited=function(e){return e instanceof $Reader$2||(e=new $Reader$2(e)),this.decode(e,e.uint32())},s.verify=function(e){if(typeof e!="object"||e===null)return"object expected";if(!(e.edgeLabelsPacked&&typeof e.edgeLabelsPacked.length=="number"||$util$2.isString(e.edgeLabelsPacked)))return"edgeLabelsPacked: buffer expected";if(e.edgeLabelLengths!=null&&e.hasOwnProperty("edgeLabelLengths")){if(!Array.isArray(e.edgeLabelLengths))return"edgeLabelLengths: array expected";for(let t=0;t<e.edgeLabelLengths.length;++t)if(!$util$2.isInteger(e.edgeLabelLengths[t]))return"edgeLabelLengths: integer[] expected"}if(e.edgeParents!=null&&e.hasOwnProperty("edgeParents")){if(!Array.isArray(e.edgeParents))return"edgeParents: array expected";for(let t=0;t<e.edgeParents.length;++t)if(!$util$2.isInteger(e.edgeParents[t]))return"edgeParents: integer[] expected"}if(e.messageStackIDs!=null&&e.hasOwnProperty("messageStackIDs")){if(!Array.isArray(e.messageStackIDs))return"messageStackIDs: array expected";for(let t=0;t<e.messageStackIDs.length;++t)if(!$util$2.isInteger(e.messageStackIDs[t]))return"messageStackIDs: integer[] expected"}return null},s.fromObject=function(e){if(e instanceof s)return e;let t=new s;if(e.edgeLabelsPacked!=null&&(typeof e.edgeLabelsPacked=="string"?$util$2.base64.decode(e.edgeLabelsPacked,t.edgeLabelsPacked=$util$2.newBuffer($util$2.base64.length(e.edgeLabelsPacked)),0):e.edgeLabelsPacked.length&&(t.edgeLabelsPacked=e.edgeLabelsPacked)),e.edgeLabelLengths){if(!Array.isArray(e.edgeLabelLengths))throw TypeError(".MessageStacksMessage.edgeLabelLengths: array expected");t.edgeLabelLengths=[];for(let r=0;r<e.edgeLabelLengths.length;++r)t.edgeLabelLengths[r]=e.edgeLabelLengths[r]|0}if(e.edgeParents){if(!Array.isArray(e.edgeParents))throw TypeError(".MessageStacksMessage.edgeParents: array expected");t.edgeParents=[];for(let r=0;r<e.edgeParents.length;++r)t.edgeParents[r]=e.edgeParents[r]>>>0}if(e.messageStackIDs){if(!Array.isArray(e.messageStackIDs))throw TypeError(".MessageStacksMessage.messageStackIDs: array expected");t.messageStackIDs=[];for(let r=0;r<e.messageStackIDs.length;++r)t.messageStackIDs[r]=e.messageStackIDs[r]>>>0}return t},s.toObject=function(e,t){t||(t={});let r={};if((t.arrays||t.defaults)&&(r.edgeLabelLengths=[],r.edgeParents=[],r.messageStackIDs=[]),t.defaults&&(t.bytes===String?r.edgeLabelsPacked="":(r.edgeLabelsPacked=[],t.bytes!==Array&&(r.edgeLabelsPacked=$util$2.newBuffer(r.edgeLabelsPacked)))),e.edgeLabelsPacked!=null&&e.hasOwnProperty("edgeLabelsPacked")&&(r.edgeLabelsPacked=t.bytes===String?$util$2.base64.encode(e.edgeLabelsPacked,0,e.edgeLabelsPacked.length):t.bytes===Array?Array.prototype.slice.call(e.edgeLabelsPacked):e.edgeLabelsPacked),e.edgeLabelLengths&&e.edgeLabelLengths.length){r.edgeLabelLengths=[];for(let l=0;l<e.edgeLabelLengths.length;++l)r.edgeLabelLengths[l]=e.edgeLabelLengths[l]}if(e.edgeParents&&e.edgeParents.length){r.edgeParents=[];for(let l=0;l<e.edgeParents.length;++l)r.edgeParents[l]=e.edgeParents[l]}if(e.messageStackIDs&&e.messageStackIDs.length){r.messageStackIDs=[];for(let l=0;l<e.messageStackIDs.length;++l)r.messageStackIDs[l]=e.messageStackIDs[l]}return r},s.prototype.toJSON=function(){return this.constructor.toObject(this,minimal.util.toJSONOptions)},s})(),SavedStateTreeMessage=(()=>{function s(n){if(this.childrenKeys=[],this.childrenValues=[],n)for(let e=Object.keys(n),t=0;t<e.length;++t)n[e[t]]!=null&&(this[e[t]]=n[e[t]])}return s.prototype.self=$util$2.newBuffer([]),s.prototype.childrenKeys=$util$2.emptyArray,s.prototype.childrenValues=$util$2.emptyArray,s.create=function(e){return new s(e)},s.encode=function(e,t){if(t||(t=$Writer$2.create()),e.self!=null&&Object.hasOwnProperty.call(e,"self")&&t.uint32(10).bytes(e.self),e.childrenKeys!=null&&e.childrenKeys.length)for(let r=0;r<e.childrenKeys.length;++r)t.uint32(18).string(e.childrenKeys[r]);if(e.childrenValues!=null&&e.childrenValues.length)for(let r=0;r<e.childrenValues.length;++r)s.encode(e.childrenValues[r],t.uint32(26).fork()).ldelim();return t},s.encodeDelimited=function(e,t){return this.encode(e,t).ldelim()},s.decode=function(e,t){e instanceof $Reader$2||(e=$Reader$2.create(e));let r=t===void 0?e.len:e.pos+t,l=new s;for(;e.pos<r;){let o=e.uint32();switch(o>>>3){case 1:l.self=e.bytes();break;case 2:l.childrenKeys&&l.childrenKeys.length||(l.childrenKeys=[]),l.childrenKeys.push(e.string());break;case 3:l.childrenValues&&l.childrenValues.length||(l.childrenValues=[]),l.childrenValues.push(s.decode(e,e.uint32()));break;default:e.skipType(o&7);break}}return l},s.decodeDelimited=function(e){return e instanceof $Reader$2||(e=new $Reader$2(e)),this.decode(e,e.uint32())},s.verify=function(e){if(typeof e!="object"||e===null)return"object expected";if(e.self!=null&&e.hasOwnProperty("self")&&!(e.self&&typeof e.self.length=="number"||$util$2.isString(e.self)))return"self: buffer expected";if(e.childrenKeys!=null&&e.hasOwnProperty("childrenKeys")){if(!Array.isArray(e.childrenKeys))return"childrenKeys: array expected";for(let t=0;t<e.childrenKeys.length;++t)if(!$util$2.isString(e.childrenKeys[t]))return"childrenKeys: string[] expected"}if(e.childrenValues!=null&&e.hasOwnProperty("childrenValues")){if(!Array.isArray(e.childrenValues))return"childrenValues: array expected";for(let t=0;t<e.childrenValues.length;++t){let r=s.verify(e.childrenValues[t]);if(r)return"childrenValues."+r}}return null},s.fromObject=function(e){if(e instanceof s)return e;let t=new s;if(e.self!=null&&(typeof e.self=="string"?$util$2.base64.decode(e.self,t.self=$util$2.newBuffer($util$2.base64.length(e.self)),0):e.self.length&&(t.self=e.self)),e.childrenKeys){if(!Array.isArray(e.childrenKeys))throw TypeError(".SavedStateTreeMessage.childrenKeys: array expected");t.childrenKeys=[];for(let r=0;r<e.childrenKeys.length;++r)t.childrenKeys[r]=String(e.childrenKeys[r])}if(e.childrenValues){if(!Array.isArray(e.childrenValues))throw TypeError(".SavedStateTreeMessage.childrenValues: array expected");t.childrenValues=[];for(let r=0;r<e.childrenValues.length;++r){if(typeof e.childrenValues[r]!="object")throw TypeError(".SavedStateTreeMessage.childrenValues: object expected");t.childrenValues[r]=s.fromObject(e.childrenValues[r])}}return t},s.toObject=function(e,t){t||(t={});let r={};if((t.arrays||t.defaults)&&(r.childrenKeys=[],r.childrenValues=[]),t.defaults&&(t.bytes===String?r.self="":(r.self=[],t.bytes!==Array&&(r.self=$util$2.newBuffer(r.self)))),e.self!=null&&e.hasOwnProperty("self")&&(r.self=t.bytes===String?$util$2.base64.encode(e.self,0,e.self.length):t.bytes===Array?Array.prototype.slice.call(e.self):e.self),e.childrenKeys&&e.childrenKeys.length){r.childrenKeys=[];for(let l=0;l<e.childrenKeys.length;++l)r.childrenKeys[l]=e.childrenKeys[l]}if(e.childrenValues&&e.childrenValues.length){r.childrenValues=[];for(let l=0;l<e.childrenValues.length;++l)r.childrenValues[l]=s.toObject(e.childrenValues[l],t)}return r},s.prototype.toJSON=function(){return this.constructor.toObject(this,minimal.util.toJSONOptions)},s})(),ArrayMessage=(()=>{function s(n){if(this.elements=[],n)for(let e=Object.keys(n),t=0;t<e.length;++t)n[e[t]]!=null&&(this[e[t]]=n[e[t]])}return s.prototype.elements=$util$2.emptyArray,s.create=function(e){return new s(e)},s.encode=function(e,t){if(t||(t=$Writer$2.create()),e.elements!=null&&e.elements.length)for(let r=0;r<e.elements.length;++r)t.uint32(10).bytes(e.elements[r]);return t},s.encodeDelimited=function(e,t){return this.encode(e,t).ldelim()},s.decode=function(e,t){e instanceof $Reader$2||(e=$Reader$2.create(e));let r=t===void 0?e.len:e.pos+t,l=new s;for(;e.pos<r;){let o=e.uint32();switch(o>>>3){case 1:l.elements&&l.elements.length||(l.elements=[]),l.elements.push(e.bytes());break;default:e.skipType(o&7);break}}return l},s.decodeDelimited=function(e){return e instanceof $Reader$2||(e=new $Reader$2(e)),this.decode(e,e.uint32())},s.verify=function(e){if(typeof e!="object"||e===null)return"object expected";if(e.elements!=null&&e.hasOwnProperty("elements")){if(!Array.isArray(e.elements))return"elements: array expected";for(let t=0;t<e.elements.length;++t)if(!(e.elements[t]&&typeof e.elements[t].length=="number"||$util$2.isString(e.elements[t])))return"elements: buffer[] expected"}return null},s.fromObject=function(e){if(e instanceof s)return e;let t=new s;if(e.elements){if(!Array.isArray(e.elements))throw TypeError(".ArrayMessage.elements: array expected");t.elements=[];for(let r=0;r<e.elements.length;++r)typeof e.elements[r]=="string"?$util$2.base64.decode(e.elements[r],t.elements[r]=$util$2.newBuffer($util$2.base64.length(e.elements[r])),0):e.elements[r].length&&(t.elements[r]=e.elements[r])}return t},s.toObject=function(e,t){t||(t={});let r={};if((t.arrays||t.defaults)&&(r.elements=[]),e.elements&&e.elements.length){r.elements=[];for(let l=0;l<e.elements.length;++l)r.elements[l]=t.bytes===String?$util$2.base64.encode(e.elements[l],0,e.elements[l].length):t.bytes===Array?Array.prototype.slice.call(e.elements[l]):e.elements[l]}return r},s.prototype.toJSON=function(){return this.constructor.toObject(this,minimal.util.toJSONOptions)},s})(),ObjectMessage=(()=>{function s(n){if(this.properties={},n)for(let e=Object.keys(n),t=0;t<e.length;++t)n[e[t]]!=null&&(this[e[t]]=n[e[t]])}return s.prototype.properties=$util$2.emptyObject,s.create=function(e){return new s(e)},s.encode=function(e,t){if(t||(t=$Writer$2.create()),e.properties!=null&&Object.hasOwnProperty.call(e,"properties"))for(let r=Object.keys(e.properties),l=0;l<r.length;++l)t.uint32(10).fork().uint32(10).string(r[l]).uint32(18).bytes(e.properties[r[l]]).ldelim();return t},s.encodeDelimited=function(e,t){return this.encode(e,t).ldelim()},s.decode=function(e,t){e instanceof $Reader$2||(e=$Reader$2.create(e));let r=t===void 0?e.len:e.pos+t,l=new s,o;for(;e.pos<r;){let a=e.uint32();switch(a>>>3){case 1:e.skip().pos++,l.properties===$util$2.emptyObject&&(l.properties={}),o=e.string(),e.pos++,l.properties[o]=e.bytes();break;default:e.skipType(a&7);break}}return l},s.decodeDelimited=function(e){return e instanceof $Reader$2||(e=new $Reader$2(e)),this.decode(e,e.uint32())},s.verify=function(e){if(typeof e!="object"||e===null)return"object expected";if(e.properties!=null&&e.hasOwnProperty("properties")){if(!$util$2.isObject(e.properties))return"properties: object expected";let t=Object.keys(e.properties);for(let r=0;r<t.length;++r)if(!(e.properties[t[r]]&&typeof e.properties[t[r]].length=="number"||$util$2.isString(e.properties[t[r]])))return"properties: buffer{k:string} expected"}return null},s.fromObject=function(e){if(e instanceof s)return e;let t=new s;if(e.properties){if(typeof e.properties!="object")throw TypeError(".ObjectMessage.properties: object expected");t.properties={};for(let r=Object.keys(e.properties),l=0;l<r.length;++l)typeof e.properties[r[l]]=="string"?$util$2.base64.decode(e.properties[r[l]],t.properties[r[l]]=$util$2.newBuffer($util$2.base64.length(e.properties[r[l]])),0):e.properties[r[l]].length&&(t.properties[r[l]]=e.properties[r[l]])}return t},s.toObject=function(e,t){t||(t={});let r={};(t.objects||t.defaults)&&(r.properties={});let l;if(e.properties&&(l=Object.keys(e.properties)).length){r.properties={};for(let o=0;o<l.length;++o)r.properties[l[o]]=t.bytes===String?$util$2.base64.encode(e.properties[l[o]],0,e.properties[l[o]].length):t.bytes===Array?Array.prototype.slice.call(e.properties[l[o]]):e.properties[l[o]]}return r},s.prototype.toJSON=function(){return this.constructor.toObject(this,minimal.util.toJSONOptions)},s})(),DefaultSerializerMessage=(()=>{function s(e){if(e)for(let t=Object.keys(e),r=0;r<t.length;++r)e[t[r]]!=null&&(this[t[r]]=e[t[r]])}s.prototype.stringValue="",s.prototype.intValue=$util$2.Long?$util$2.Long.fromBits(0,0,!1):0,s.prototype.doubleValue=0,s.prototype.booleanValue=!1,s.prototype.undefinedValue=!1,s.prototype.nullValue=!1,s.prototype.arrayValue=null,s.prototype.objectValue=null,s.prototype.bytesValue=$util$2.newBuffer([]),s.prototype.optionalValue=null;let n;return Object.defineProperty(s.prototype,"value",{get:$util$2.oneOfGetter(n=["stringValue","intValue","doubleValue","booleanValue","undefinedValue","nullValue","arrayValue","objectValue","bytesValue","optionalValue"]),set:$util$2.oneOfSetter(n)}),s.create=function(t){return new s(t)},s.encode=function(t,r){return r||(r=$Writer$2.create()),t.stringValue!=null&&Object.hasOwnProperty.call(t,"stringValue")&&r.uint32(10).string(t.stringValue),t.intValue!=null&&Object.hasOwnProperty.call(t,"intValue")&&r.uint32(16).sint64(t.intValue),t.doubleValue!=null&&Object.hasOwnProperty.call(t,"doubleValue")&&r.uint32(25).double(t.doubleValue),t.booleanValue!=null&&Object.hasOwnProperty.call(t,"booleanValue")&&r.uint32(32).bool(t.booleanValue),t.undefinedValue!=null&&Object.hasOwnProperty.call(t,"undefinedValue")&&r.uint32(40).bool(t.undefinedValue),t.nullValue!=null&&Object.hasOwnProperty.call(t,"nullValue")&&r.uint32(48).bool(t.nullValue),t.arrayValue!=null&&Object.hasOwnProperty.call(t,"arrayValue")&&ArrayMessage.encode(t.arrayValue,r.uint32(58).fork()).ldelim(),t.objectValue!=null&&Object.hasOwnProperty.call(t,"objectValue")&&ObjectMessage.encode(t.objectValue,r.uint32(66).fork()).ldelim(),t.bytesValue!=null&&Object.hasOwnProperty.call(t,"bytesValue")&&r.uint32(74).bytes(t.bytesValue),t.optionalValue!=null&&Object.hasOwnProperty.call(t,"optionalValue")&&OptionalMessage.encode(t.optionalValue,r.uint32(82).fork()).ldelim(),r},s.encodeDelimited=function(t,r){return this.encode(t,r).ldelim()},s.decode=function(t,r){t instanceof $Reader$2||(t=$Reader$2.create(t));let l=r===void 0?t.len:t.pos+r,o=new s;for(;t.pos<l;){let a=t.uint32();switch(a>>>3){case 1:o.stringValue=t.string();break;case 2:o.intValue=t.sint64();break;case 3:o.doubleValue=t.double();break;case 4:o.booleanValue=t.bool();break;case 5:o.undefinedValue=t.bool();break;case 6:o.nullValue=t.bool();break;case 7:o.arrayValue=ArrayMessage.decode(t,t.uint32());break;case 8:o.objectValue=ObjectMessage.decode(t,t.uint32());break;case 9:o.bytesValue=t.bytes();break;case 10:o.optionalValue=OptionalMessage.decode(t,t.uint32());break;default:t.skipType(a&7);break}}return o},s.decodeDelimited=function(t){return t instanceof $Reader$2||(t=new $Reader$2(t)),this.decode(t,t.uint32())},s.verify=function(t){if(typeof t!="object"||t===null)return"object expected";let r={};if(t.stringValue!=null&&t.hasOwnProperty("stringValue")&&(r.value=1,!$util$2.isString(t.stringValue)))return"stringValue: string expected";if(t.intValue!=null&&t.hasOwnProperty("intValue")){if(r.value===1)return"value: multiple values";if(r.value=1,!$util$2.isInteger(t.intValue)&&!(t.intValue&&$util$2.isInteger(t.intValue.low)&&$util$2.isInteger(t.intValue.high)))return"intValue: integer|Long expected"}if(t.doubleValue!=null&&t.hasOwnProperty("doubleValue")){if(r.value===1)return"value: multiple values";if(r.value=1,typeof t.doubleValue!="number")return"doubleValue: number expected"}if(t.booleanValue!=null&&t.hasOwnProperty("booleanValue")){if(r.value===1)return"value: multiple values";if(r.value=1,typeof t.booleanValue!="boolean")return"booleanValue: boolean expected"}if(t.undefinedValue!=null&&t.hasOwnProperty("undefinedValue")){if(r.value===1)return"value: multiple values";if(r.value=1,typeof t.undefinedValue!="boolean")return"undefinedValue: boolean expected"}if(t.nullValue!=null&&t.hasOwnProperty("nullValue")){if(r.value===1)return"value: multiple values";if(r.value=1,typeof t.nullValue!="boolean")return"nullValue: boolean expected"}if(t.arrayValue!=null&&t.hasOwnProperty("arrayValue")){if(r.value===1)return"value: multiple values";r.value=1;{let l=ArrayMessage.verify(t.arrayValue);if(l)return"arrayValue."+l}}if(t.objectValue!=null&&t.hasOwnProperty("objectValue")){if(r.value===1)return"value: multiple values";r.value=1;{let l=ObjectMessage.verify(t.objectValue);if(l)return"objectValue."+l}}if(t.bytesValue!=null&&t.hasOwnProperty("bytesValue")){if(r.value===1)return"value: multiple values";if(r.value=1,!(t.bytesValue&&typeof t.bytesValue.length=="number"||$util$2.isString(t.bytesValue)))return"bytesValue: buffer expected"}if(t.optionalValue!=null&&t.hasOwnProperty("optionalValue")){if(r.value===1)return"value: multiple values";r.value=1;{let l=OptionalMessage.verify(t.optionalValue);if(l)return"optionalValue."+l}}return null},s.fromObject=function(t){if(t instanceof s)return t;let r=new s;if(t.stringValue!=null&&(r.stringValue=String(t.stringValue)),t.intValue!=null&&($util$2.Long?(r.intValue=$util$2.Long.fromValue(t.intValue)).unsigned=!1:typeof t.intValue=="string"?r.intValue=parseInt(t.intValue,10):typeof t.intValue=="number"?r.intValue=t.intValue:typeof t.intValue=="object"&&(r.intValue=new $util$2.LongBits(t.intValue.low>>>0,t.intValue.high>>>0).toNumber())),t.doubleValue!=null&&(r.doubleValue=Number(t.doubleValue)),t.booleanValue!=null&&(r.booleanValue=!!t.booleanValue),t.undefinedValue!=null&&(r.undefinedValue=!!t.undefinedValue),t.nullValue!=null&&(r.nullValue=!!t.nullValue),t.arrayValue!=null){if(typeof t.arrayValue!="object")throw TypeError(".DefaultSerializerMessage.arrayValue: object expected");r.arrayValue=ArrayMessage.fromObject(t.arrayValue)}if(t.objectValue!=null){if(typeof t.objectValue!="object")throw TypeError(".DefaultSerializerMessage.objectValue: object expected");r.objectValue=ObjectMessage.fromObject(t.objectValue)}if(t.bytesValue!=null&&(typeof t.bytesValue=="string"?$util$2.base64.decode(t.bytesValue,r.bytesValue=$util$2.newBuffer($util$2.base64.length(t.bytesValue)),0):t.bytesValue.length&&(r.bytesValue=t.bytesValue)),t.optionalValue!=null){if(typeof t.optionalValue!="object")throw TypeError(".DefaultSerializerMessage.optionalValue: object expected");r.optionalValue=OptionalMessage.fromObject(t.optionalValue)}return r},s.toObject=function(t,r){r||(r={});let l={};return t.stringValue!=null&&t.hasOwnProperty("stringValue")&&(l.stringValue=t.stringValue,r.oneofs&&(l.value="stringValue")),t.intValue!=null&&t.hasOwnProperty("intValue")&&(typeof t.intValue=="number"?l.intValue=r.longs===String?String(t.intValue):t.intValue:l.intValue=r.longs===String?$util$2.Long.prototype.toString.call(t.intValue):r.longs===Number?new $util$2.LongBits(t.intValue.low>>>0,t.intValue.high>>>0).toNumber():t.intValue,r.oneofs&&(l.value="intValue")),t.doubleValue!=null&&t.hasOwnProperty("doubleValue")&&(l.doubleValue=r.json&&!isFinite(t.doubleValue)?String(t.doubleValue):t.doubleValue,r.oneofs&&(l.value="doubleValue")),t.booleanValue!=null&&t.hasOwnProperty("booleanValue")&&(l.booleanValue=t.booleanValue,r.oneofs&&(l.value="booleanValue")),t.undefinedValue!=null&&t.hasOwnProperty("undefinedValue")&&(l.undefinedValue=t.undefinedValue,r.oneofs&&(l.value="undefinedValue")),t.nullValue!=null&&t.hasOwnProperty("nullValue")&&(l.nullValue=t.nullValue,r.oneofs&&(l.value="nullValue")),t.arrayValue!=null&&t.hasOwnProperty("arrayValue")&&(l.arrayValue=ArrayMessage.toObject(t.arrayValue,r),r.oneofs&&(l.value="arrayValue")),t.objectValue!=null&&t.hasOwnProperty("objectValue")&&(l.objectValue=ObjectMessage.toObject(t.objectValue,r),r.oneofs&&(l.value="objectValue")),t.bytesValue!=null&&t.hasOwnProperty("bytesValue")&&(l.bytesValue=r.bytes===String?$util$2.base64.encode(t.bytesValue,0,t.bytesValue.length):r.bytes===Array?Array.prototype.slice.call(t.bytesValue):t.bytesValue,r.oneofs&&(l.value="bytesValue")),t.optionalValue!=null&&t.hasOwnProperty("optionalValue")&&(l.optionalValue=OptionalMessage.toObject(t.optionalValue,r),r.oneofs&&(l.value="optionalValue")),l},s.prototype.toJSON=function(){return this.constructor.toObject(this,minimal.util.toJSONOptions)},s})(),PairSerializerMessage=(()=>{function s(n){if(n)for(let e=Object.keys(n),t=0;t<e.length;++t)n[e[t]]!=null&&(this[e[t]]=n[e[t]])}return s.prototype.one=$util$2.newBuffer([]),s.prototype.two=$util$2.newBuffer([]),s.create=function(e){return new s(e)},s.encode=function(e,t){return t||(t=$Writer$2.create()),t.uint32(10).bytes(e.one),t.uint32(18).bytes(e.two),t},s.encodeDelimited=function(e,t){return this.encode(e,t).ldelim()},s.decode=function(e,t){e instanceof $Reader$2||(e=$Reader$2.create(e));let r=t===void 0?e.len:e.pos+t,l=new s;for(;e.pos<r;){let o=e.uint32();switch(o>>>3){case 1:l.one=e.bytes();break;case 2:l.two=e.bytes();break;default:e.skipType(o&7);break}}if(!l.hasOwnProperty("one"))throw $util$2.ProtocolError("missing required 'one'",{instance:l});if(!l.hasOwnProperty("two"))throw $util$2.ProtocolError("missing required 'two'",{instance:l});return l},s.decodeDelimited=function(e){return e instanceof $Reader$2||(e=new $Reader$2(e)),this.decode(e,e.uint32())},s.verify=function(e){return typeof e!="object"||e===null?"object expected":e.one&&typeof e.one.length=="number"||$util$2.isString(e.one)?e.two&&typeof e.two.length=="number"||$util$2.isString(e.two)?null:"two: buffer expected":"one: buffer expected"},s.fromObject=function(e){if(e instanceof s)return e;let t=new s;return e.one!=null&&(typeof e.one=="string"?$util$2.base64.decode(e.one,t.one=$util$2.newBuffer($util$2.base64.length(e.one)),0):e.one.length&&(t.one=e.one)),e.two!=null&&(typeof e.two=="string"?$util$2.base64.decode(e.two,t.two=$util$2.newBuffer($util$2.base64.length(e.two)),0):e.two.length&&(t.two=e.two)),t},s.toObject=function(e,t){t||(t={});let r={};return t.defaults&&(t.bytes===String?r.one="":(r.one=[],t.bytes!==Array&&(r.one=$util$2.newBuffer(r.one))),t.bytes===String?r.two="":(r.two=[],t.bytes!==Array&&(r.two=$util$2.newBuffer(r.two)))),e.one!=null&&e.hasOwnProperty("one")&&(r.one=t.bytes===String?$util$2.base64.encode(e.one,0,e.one.length):t.bytes===Array?Array.prototype.slice.call(e.one):e.one),e.two!=null&&e.hasOwnProperty("two")&&(r.two=t.bytes===String?$util$2.base64.encode(e.two,0,e.two.length):t.bytes===Array?Array.prototype.slice.call(e.two):e.two),r},s.prototype.toJSON=function(){return this.constructor.toObject(this,minimal.util.toJSONOptions)},s})(),CollabIDMessage=(()=>{function s(n){if(this.collabIDPath=[],n)for(let e=Object.keys(n),t=0;t<e.length;++t)n[e[t]]!=null&&(this[e[t]]=n[e[t]])}return s.prototype.collabIDPath=$util$2.emptyArray,s.create=function(e){return new s(e)},s.encode=function(e,t){if(t||(t=$Writer$2.create()),e.collabIDPath!=null&&e.collabIDPath.length)for(let r=0;r<e.collabIDPath.length;++r)t.uint32(10).string(e.collabIDPath[r]);return t},s.encodeDelimited=function(e,t){return this.encode(e,t).ldelim()},s.decode=function(e,t){e instanceof $Reader$2||(e=$Reader$2.create(e));let r=t===void 0?e.len:e.pos+t,l=new s;for(;e.pos<r;){let o=e.uint32();switch(o>>>3){case 1:l.collabIDPath&&l.collabIDPath.length||(l.collabIDPath=[]),l.collabIDPath.push(e.string());break;default:e.skipType(o&7);break}}return l},s.decodeDelimited=function(e){return e instanceof $Reader$2||(e=new $Reader$2(e)),this.decode(e,e.uint32())},s.verify=function(e){if(typeof e!="object"||e===null)return"object expected";if(e.collabIDPath!=null&&e.hasOwnProperty("collabIDPath")){if(!Array.isArray(e.collabIDPath))return"collabIDPath: array expected";for(let t=0;t<e.collabIDPath.length;++t)if(!$util$2.isString(e.collabIDPath[t]))return"collabIDPath: string[] expected"}return null},s.fromObject=function(e){if(e instanceof s)return e;let t=new s;if(e.collabIDPath){if(!Array.isArray(e.collabIDPath))throw TypeError(".CollabIDMessage.collabIDPath: array expected");t.collabIDPath=[];for(let r=0;r<e.collabIDPath.length;++r)t.collabIDPath[r]=String(e.collabIDPath[r])}return t},s.toObject=function(e,t){t||(t={});let r={};if((t.arrays||t.defaults)&&(r.collabIDPath=[]),e.collabIDPath&&e.collabIDPath.length){r.collabIDPath=[];for(let l=0;l<e.collabIDPath.length;++l)r.collabIDPath[l]=e.collabIDPath[l]}return r},s.prototype.toJSON=function(){return this.constructor.toObject(this,minimal.util.toJSONOptions)},s})(),OptionalMessage=(()=>{function s(n){if(n)for(let e=Object.keys(n),t=0;t<e.length;++t)n[e[t]]!=null&&(this[e[t]]=n[e[t]])}return s.prototype.valueIfPresent=$util$2.newBuffer([]),s.create=function(e){return new s(e)},s.encode=function(e,t){return t||(t=$Writer$2.create()),e.valueIfPresent!=null&&Object.hasOwnProperty.call(e,"valueIfPresent")&&t.uint32(10).bytes(e.valueIfPresent),t},s.encodeDelimited=function(e,t){return this.encode(e,t).ldelim()},s.decode=function(e,t){e instanceof $Reader$2||(e=$Reader$2.create(e));let r=t===void 0?e.len:e.pos+t,l=new s;for(;e.pos<r;){let o=e.uint32();switch(o>>>3){case 1:l.valueIfPresent=e.bytes();break;default:e.skipType(o&7);break}}return l},s.decodeDelimited=function(e){return e instanceof $Reader$2||(e=new $Reader$2(e)),this.decode(e,e.uint32())},s.verify=function(e){return typeof e!="object"||e===null?"object expected":e.valueIfPresent!=null&&e.hasOwnProperty("valueIfPresent")&&!(e.valueIfPresent&&typeof e.valueIfPresent.length=="number"||$util$2.isString(e.valueIfPresent))?"valueIfPresent: buffer expected":null},s.fromObject=function(e){if(e instanceof s)return e;let t=new s;return e.valueIfPresent!=null&&(typeof e.valueIfPresent=="string"?$util$2.base64.decode(e.valueIfPresent,t.valueIfPresent=$util$2.newBuffer($util$2.base64.length(e.valueIfPresent)),0):e.valueIfPresent.length&&(t.valueIfPresent=e.valueIfPresent)),t},s.toObject=function(e,t){t||(t={});let r={};return t.defaults&&(t.bytes===String?r.valueIfPresent="":(r.valueIfPresent=[],t.bytes!==Array&&(r.valueIfPresent=$util$2.newBuffer(r.valueIfPresent)))),e.valueIfPresent!=null&&e.hasOwnProperty("valueIfPresent")&&(r.valueIfPresent=t.bytes===String?$util$2.base64.encode(e.valueIfPresent,0,e.valueIfPresent.length):t.bytes===Array?Array.prototype.slice.call(e.valueIfPresent):e.valueIfPresent),r},s.prototype.toJSON=function(){return this.constructor.toObject(this,minimal.util.toJSONOptions)},s})();var _a$3;class FakeWeakRef{constructor(n){this.targetObject=n,this[_a$3]="WeakRef"}deref(){return this.targetObject}}_a$3=Symbol.toStringTag;const SafeWeakRef=typeof WeakRef>"u"?FakeWeakRef:WeakRef;var _a$2,_b$1;class DefaultSerializer{constructor(){}static getInstance(){return this.instance}serialize(n){let e;switch(typeof n){case"string":e={stringValue:n};break;case"number":Number.isSafeInteger(n)?e={intValue:n}:e={doubleValue:n};break;case"boolean":e={booleanValue:n};break;case"undefined":e={undefinedValue:!0};break;case"object":if(n===null)e={nullValue:!0};else if(n instanceof Uint8Array)e={bytesValue:n};else if(Array.isArray(n))e={arrayValue:ArrayMessage.create({elements:n.map(t=>this.serialize(t))})};else if(n instanceof Optional)e={optionalValue:{valueIfPresent:n.isPresent?this.serialize(n.get()):void 0}};else{const t=n.constructor;if(t===Object){const r={};for(const[l,o]of Object.entries(n))r[l]=this.serialize(o);e={objectValue:ObjectMessage.create({properties:r})}}else throw n instanceof Collab?new Error("Collab serialization is not supported; serialize a CollabID instead"):new Error(`Unsupported class type for DefaultSerializer: ${t.name}; you must use a custom serializer or a plain (non-class) Object`)}break;default:throw new Error(`Unsupported type for DefaultSerializer: ${typeof n}; you must use a custom Serializer`)}return DefaultSerializerMessage.encode(e).finish()}deserialize(n){const e=DefaultSerializerMessage.decode(n);let t;switch(e.value){case"stringValue":t=e.stringValue;break;case"intValue":t=int64AsNumber(e.intValue);break;case"doubleValue":t=e.doubleValue;break;case"booleanValue":t=e.booleanValue;break;case"undefinedValue":t=void 0;break;case"nullValue":t=null;break;case"arrayValue":t=nonNull(nonNull(e.arrayValue).elements).map(r=>this.deserialize(r));break;case"objectValue":t={};for(const[r,l]of Object.entries(nonNull(nonNull(e.objectValue).properties)))t[r]=this.deserialize(l);break;case"bytesValue":t=e.bytesValue;break;case"optionalValue":{const r=nonNull(e.optionalValue);protobufHas(r,"valueIfPresent")?t=Optional.of(this.deserialize(nonNull(r.valueIfPresent))):t=Optional.empty();break}default:throw new Error(`Bad message format: decoded.value=${e.value}`)}return t}}_a$2=DefaultSerializer;DefaultSerializer.instance=new _a$2;class Uint8ArraySerializer{constructor(){}serialize(n){return n}deserialize(n){return n}}Uint8ArraySerializer.instance=new Uint8ArraySerializer;class StringSerializer{constructor(){}serialize(n){const e=new Uint8Array(utf8$2.length(n));return utf8$2.write(n,e,0),e}deserialize(n){return utf8$2.read(n,0,n.length)}}StringSerializer.instance=new StringSerializer;class ArraySerializer{constructor(n){this.valueSerializer=n}serialize(n){const e=ArrayMessage.create({elements:n.map(t=>this.valueSerializer.serialize(t))});return ArrayMessage.encode(e).finish()}deserialize(n){return ArrayMessage.decode(n).elements.map(t=>this.valueSerializer.deserialize(t))}static getInstance(n){const e=this.cache.get(n);if(e!==void 0){const r=e.deref();if(r!==void 0)return r}const t=new ArraySerializer(n);return this.cache.set(n,new SafeWeakRef(t)),t}}ArraySerializer.cache=new WeakMap;class PairSerializer{constructor(n,e){this.oneSerializer=n,this.twoSerializer=e}serialize(n){const e=PairSerializerMessage.create({one:this.oneSerializer.serialize(n[0]),two:this.twoSerializer.serialize(n[1])});return PairSerializerMessage.encode(e).finish()}deserialize(n){const e=PairSerializerMessage.decode(n);return[this.oneSerializer.deserialize(e.one),this.twoSerializer.deserialize(e.two)]}}const emptyUint8Array=new Uint8Array;class ConstSerializer{constructor(n){this.value=n}serialize(n){return emptyUint8Array}deserialize(n){return this.value}}class CollabIDSerializer{constructor(){}static getInstance(){return this.instance}serialize(n){const e=CollabIDMessage.create({collabIDPath:n.collabIDPath});return CollabIDMessage.encode(e).finish()}deserialize(n){return{collabIDPath:CollabIDMessage.decode(n).collabIDPath}}}_b$1=CollabIDSerializer;CollabIDSerializer.instance=new _b$1;function int64AsNumber(s){return typeof s=="number"?s:s.toNumber()}function protobufHas(s,n){return Object.prototype.hasOwnProperty.call(s,n)}class Optional{constructor(n,e){this.isPresent=n,this.valueIfPresent=e}get(){if(!this.isPresent)throw new Error("Optional.get() called but isPresent is false");return this.valueIfPresent}orElse(n){return this.isPresent?this.valueIfPresent:n}map(n){return this.isPresent?Optional.of(n(this.valueIfPresent)):Optional.empty()}toString(){return this.isPresent?`Optional.of(${this.get()})`:"Optional.empty()"}static empty(){return Optional.emptyInstance}static of(n){return new Optional(!0,n)}}Optional.emptyInstance=new Optional(!1,void 0);var _a$1,_b;class MessageStacksSerializer{constructor(){}serialize(n){if(n.length===1){const e=MessageStacksMessage.create(this.serializeEdgeLabels(n[0]));return MessageStacksMessage.encode(e).finish()}else{const e=new Map,t=[],r=[],l=[];for(const a of n){let u=0,c=!0;for(let f=a.length-1;f>=0;f--){const d=a[f];if(c&&typeof d=="string"){let h=e.get(u);const p=h==null?void 0:h.get(d);p!==void 0?u=p:(t.push(d),r.push(u),h===void 0&&(h=new Map,e.set(u,h)),h.set(d,t.length),u=t.length)}else c=!1,t.push(d),r.push(u),u=t.length}l.push(u)}const o=MessageStacksMessage.create({...this.serializeEdgeLabels(t),edgeParents:r,messageStackIDs:l});return MessageStacksMessage.encode(o).finish()}}deserialize(n){const e=MessageStacksMessage.decode(n),t=this.deserializeEdgeLabels(e);if(e.messageStackIDs.length===0)return[t];{const r=new Array(e.messageStackIDs.length);for(let l=0;l<r.length;l++){const o=[];let a=e.messageStackIDs[l];for(;a!==0;)o.push(t[a-1]),a=e.edgeParents[a-1];r[l]=o}return r}}serializeEdgeLabels(n){const e=new Array(n.length);let t=0;for(let o=0;o<n.length;o++){const a=n[o];if(typeof a=="string"){const u=minimal.util.utf8.length(a);e[o]=~u,t+=u}else e[o]=a.length,t+=a.length}const r=new Uint8Array(t);let l=0;for(let o=0;o<n.length;o++){const a=n[o];typeof a=="string"?minimal.util.utf8.write(a,r,l):r.set(a,l),l+=a.length}return{edgeLabelsPacked:r,edgeLabelLengths:e}}deserializeEdgeLabels(n){const e=new Array(n.edgeLabelLengths.length);let t=0;for(let r=0;r<n.edgeLabelLengths.length;r++){const l=n.edgeLabelLengths[r];if(l<0){const o=~l;e[r]=minimal.util.utf8.read(n.edgeLabelsPacked,t,t+o),t+=o}else e[r]=new Uint8Array(n.edgeLabelsPacked.buffer,t+n.edgeLabelsPacked.byteOffset,l),t+=l}return e}}_a$1=MessageStacksSerializer;MessageStacksSerializer.instance=new _a$1;class SavedStateTreeSerializer{constructor(){}serialize(n){const e=this.toMessage(n);return SavedStateTreeMessage.encode(e).finish()}deserialize(n){const e=SavedStateTreeMessage.decode(n);return this.fromMessage(e)}toMessage(n){if(n.children===void 0)return{self:n.self};const e=new Array(n.children.size),t=new Array(n.children.size);let r=0;for(const[l,o]of n.children)e[r]=l,t[r]=this.toMessage(o),r++;return{self:n.self,childrenKeys:e,childrenValues:t}}fromMessage(n){const e=new Map;for(let t=0;t<n.childrenKeys.length;t++)e.set(n.childrenKeys[t],this.fromMessage(n.childrenValues[t]));return{self:n.self,children:e}}}_b=SavedStateTreeSerializer;SavedStateTreeSerializer.instance=new _b;class WeakValueMap{constructor(){this.internalMap=new Map,typeof FinalizationRegistry<"u"&&(this.registry=new FinalizationRegistry(n=>this.checkKey(n)))}clear(){this.internalMap.clear()}delete(n){this.internalMap.delete(n)}get(n){const e=this.internalMap.get(n);if(e===void 0)return;const t=e.deref();return t===void 0&&this.delete(n),t}set(n,e){this.internalMap.set(n,new SafeWeakRef(e)),this.registry&&this.registry.register(e,n)}*[Symbol.iterator](){for(const n of this.internalMap.entries()){const e=n[1].deref();e!==void 0&&(yield[n[0],e])}}checkKey(n){const e=this.internalMap.get(n);e!==void 0&&e.deref()===void 0&&this.delete(n)}}class CLazyMap extends AbstractMap_Collab{constructor(n,e,t={}){super(n),this.valueConstructor=e,this.nontrivialMap=new Map,this.trivialMap=new WeakValueMap,this.inUpdateData=void 0,this.keySerializer=t.keySerializer??DefaultSerializer.getInstance()}keyAsString(n){return fromByteArray_1(this.keySerializer.serialize(n))}stringAsKey(n){return this.keySerializer.deserialize(toByteArray_1(n))}getInternal(n,e){let t=this.nontrivialMap.get(e);return t===void 0?(t=this.trivialMap.get(e),t===void 0&&(t=this.valueConstructor(new InitToken(e,this),n),this.trivialMap.set(e,t)),[t,!1]):[t,!0]}applyUpdate(n,e,t){const r=this.stringAsKey(n),[l,o]=this.getInternal(r,n);try{this.inUpdateData={keyString:n,value:l,nontrivialStart:o},e(l)}finally{this.inUpdateData=void 0}o&&l.canGC()?(this.nontrivialMap.delete(n),this.trivialMap.set(n,l),this.emit("Delete",{key:r,value:l,meta:t})):!o&&!l.canGC()&&(this.trivialMap.delete(n),this.nontrivialMap.set(n,l),this.emit("Set",{key:r,value:l,previousValue:Optional.empty(),meta:t}))}childSend(n,e,t){if(n.parent!==this)throw new Error(`childSend called by non-child: ${n}`);e.push(n.name),this.send(e,t)}receive(n,e){const t=n.pop();this.applyUpdate(t,r=>r.receive(n,e),e)}set(n){return this.get(n)}delete(n){throw new Error("Unsupported operation: delete")}clear(){throw new Error("Unsupported operation: delete")}get(n){return this.getInternal(n,this.keyAsString(n))[0]}getIfPresent(n){var t;const e=this.keyAsString(n);return((t=this.inUpdateData)==null?void 0:t.keyString)===e?this.inUpdateData.value.canGC()?void 0:this.inUpdateData.value:this.nontrivialMap.get(this.keyAsString(n))}has(n){var t;const e=this.keyAsString(n);return((t=this.inUpdateData)==null?void 0:t.keyString)===e?!this.inUpdateData.value.canGC():this.nontrivialMap.has(e)}get size(){let n=0;return this.inUpdateData!==void 0&&(this.inUpdateData.nontrivialStart&&this.inUpdateData.value.canGC()?n=-1:!this.inUpdateData.nontrivialStart&&!this.inUpdateData.value.canGC()&&(n=1)),this.nontrivialMap.size+n}*entries(){var n;for(const[e,t]of this.nontrivialMap)((n=this.inUpdateData)==null?void 0:n.value)===t&&this.inUpdateData.value.canGC()||(yield[this.stringAsKey(e),t]);this.inUpdateData!==void 0&&!this.inUpdateData.nontrivialStart&&!this.inUpdateData.value.canGC()&&(yield[this.stringAsKey(this.inUpdateData.keyString),this.inUpdateData.value])}*values(){var n;for(const e of this.nontrivialMap.values())((n=this.inUpdateData)==null?void 0:n.value)===e&&this.inUpdateData.value.canGC()||(yield e);this.inUpdateData!==void 0&&!this.inUpdateData.nontrivialStart&&!this.inUpdateData.value.canGC()&&(yield this.inUpdateData.value)}keyOf(n){if(n.parent===this)return this.stringAsKey(n.name)}save(){const n=new Map;for(const[e,t]of this.nontrivialMap)n.set(e,t.save());return{children:n}}load(n,e){if(n===null){for(const r of this.nontrivialMap.values())r.load(null,e);return}const t=nonNull(n.children);for(const[r,l]of t)this.applyUpdate(r,o=>o.load(l,e),e);for(const r of this.nontrivialMap.keys())t.has(r)||this.applyUpdate(r,l=>l.load(null,e),e)}idOf(n){return collabIDOf(n,this)}fromID(n,e=0){const t=n.collabIDPath[e],r=this.getInternal(this.stringAsKey(t),t)[0];if(e===n.collabIDPath.length-1)return r;if(r.fromID===void 0)throw new Error("child is not a parent, but CollabID is its descendant");return r.fromID(n,e+1)}canGC(){return this.inUpdateData!==void 0&&!this.inUpdateData.value.canGC()?!1:this.nontrivialMap.size===0}}class CMessenger extends CPrimitive{constructor(n,e={}){super(n),this.messageSerializer=e.messageSerializer??DefaultSerializer.getInstance()}sendMessage(n){const e=this.messageSerializer.serialize(n);super.sendPrimitive(e)}receivePrimitive(n,e){const t=this.messageSerializer.deserialize(n);this.emit("Message",{message:t,meta:e})}savePrimitive(){return new Uint8Array}loadPrimitive(){}canGC(){return!0}}class PrimitiveCRDT extends CPrimitive{constructor(n){if(super(n),this.runtime.isCRDTRuntime!==!0)throw new Error("this.runtime must be CRuntime or compatible")}sendCRDT(n,e){super.sendPrimitive(n,e)}receivePrimitive(n,e){this.receiveCRDT(n,e,e.runtimeExtra)}savePrimitive(){return this.saveCRDT()}loadPrimitive(n,e){this.loadCRDT(n,e,e.runtimeExtra)}}const AbstractList_PrimitiveCRDT=MakeAbstractList(PrimitiveCRDT),AbstractMap_PrimitiveCRDT=MakeAbstractMap(PrimitiveCRDT),AbstractSet_PrimitiveCRDT=MakeAbstractSet(PrimitiveCRDT),$Reader$1=minimal.Reader,$Writer$1=minimal.Writer,$util$1=minimal.util;minimal.roots.default||(minimal.roots.default={});const CSetMessage=(()=>{function s(e){if(e)for(let t=Object.keys(e),r=0;r<t.length;++r)e[t[r]]!=null&&(this[t[r]]=e[t[r]])}s.prototype.add=$util$1.newBuffer([]),s.prototype.delete="";let n;return Object.defineProperty(s.prototype,"op",{get:$util$1.oneOfGetter(n=["add","delete"]),set:$util$1.oneOfSetter(n)}),s.create=function(t){return new s(t)},s.encode=function(t,r){return r||(r=$Writer$1.create()),t.add!=null&&Object.hasOwnProperty.call(t,"add")&&r.uint32(10).bytes(t.add),t.delete!=null&&Object.hasOwnProperty.call(t,"delete")&&r.uint32(18).string(t.delete),r},s.encodeDelimited=function(t,r){return this.encode(t,r).ldelim()},s.decode=function(t,r){t instanceof $Reader$1||(t=$Reader$1.create(t));let l=r===void 0?t.len:t.pos+r,o=new s;for(;t.pos<l;){let a=t.uint32();switch(a>>>3){case 1:o.add=t.bytes();break;case 2:o.delete=t.string();break;default:t.skipType(a&7);break}}return o},s.decodeDelimited=function(t){return t instanceof $Reader$1||(t=new $Reader$1(t)),this.decode(t,t.uint32())},s.verify=function(t){if(typeof t!="object"||t===null)return"object expected";let r={};if(t.add!=null&&t.hasOwnProperty("add")&&(r.op=1,!(t.add&&typeof t.add.length=="number"||$util$1.isString(t.add))))return"add: buffer expected";if(t.delete!=null&&t.hasOwnProperty("delete")){if(r.op===1)return"op: multiple values";if(r.op=1,!$util$1.isString(t.delete))return"delete: string expected"}return null},s.fromObject=function(t){if(t instanceof s)return t;let r=new s;return t.add!=null&&(typeof t.add=="string"?$util$1.base64.decode(t.add,r.add=$util$1.newBuffer($util$1.base64.length(t.add)),0):t.add.length&&(r.add=t.add)),t.delete!=null&&(r.delete=String(t.delete)),r},s.toObject=function(t,r){r||(r={});let l={};return t.add!=null&&t.hasOwnProperty("add")&&(l.add=r.bytes===String?$util$1.base64.encode(t.add,0,t.add.length):r.bytes===Array?Array.prototype.slice.call(t.add):t.add,r.oneofs&&(l.op="add")),t.delete!=null&&t.hasOwnProperty("delete")&&(l.delete=t.delete,r.oneofs&&(l.op="delete")),l},s.prototype.toJSON=function(){return this.constructor.toObject(this,minimal.util.toJSONOptions)},s})(),CSetSave=(()=>{function s(n){if(this.args=[],n)for(let e=Object.keys(n),t=0;t<e.length;++t)n[e[t]]!=null&&(this[e[t]]=n[e[t]])}return s.prototype.args=$util$1.emptyArray,s.create=function(e){return new s(e)},s.encode=function(e,t){if(t||(t=$Writer$1.create()),e.args!=null&&e.args.length)for(let r=0;r<e.args.length;++r)t.uint32(10).bytes(e.args[r]);return t},s.encodeDelimited=function(e,t){return this.encode(e,t).ldelim()},s.decode=function(e,t){e instanceof $Reader$1||(e=$Reader$1.create(e));let r=t===void 0?e.len:e.pos+t,l=new s;for(;e.pos<r;){let o=e.uint32();switch(o>>>3){case 1:l.args&&l.args.length||(l.args=[]),l.args.push(e.bytes());break;default:e.skipType(o&7);break}}return l},s.decodeDelimited=function(e){return e instanceof $Reader$1||(e=new $Reader$1(e)),this.decode(e,e.uint32())},s.verify=function(e){if(typeof e!="object"||e===null)return"object expected";if(e.args!=null&&e.hasOwnProperty("args")){if(!Array.isArray(e.args))return"args: array expected";for(let t=0;t<e.args.length;++t)if(!(e.args[t]&&typeof e.args[t].length=="number"||$util$1.isString(e.args[t])))return"args: buffer[] expected"}return null},s.fromObject=function(e){if(e instanceof s)return e;let t=new s;if(e.args){if(!Array.isArray(e.args))throw TypeError(".CSetSave.args: array expected");t.args=[];for(let r=0;r<e.args.length;++r)typeof e.args[r]=="string"?$util$1.base64.decode(e.args[r],t.args[r]=$util$1.newBuffer($util$1.base64.length(e.args[r])),0):e.args[r].length&&(t.args[r]=e.args[r])}return t},s.toObject=function(e,t){t||(t={});let r={};if((t.arrays||t.defaults)&&(r.args=[]),e.args&&e.args.length){r.args=[];for(let l=0;l<e.args.length;++l)r.args[l]=t.bytes===String?$util$1.base64.encode(e.args[l],0,e.args[l].length):t.bytes===Array?Array.prototype.slice.call(e.args[l]):e.args[l]}return r},s.prototype.toJSON=function(){return this.constructor.toObject(this,minimal.util.toJSONOptions)},s})(),TotalOrderCreateMessage=(()=>{function s(n){if(n)for(let e=Object.keys(n),t=0;t<e.length;++t)n[e[t]]!=null&&(this[e[t]]=n[e[t]])}return s.prototype.parentWaypointSenderID="",s.prototype.parentWaypointCounterAndSide=0,s.prototype.parentValueIndex=0,s.create=function(e){return new s(e)},s.encode=function(e,t){return t||(t=$Writer$1.create()),e.parentWaypointSenderID!=null&&Object.hasOwnProperty.call(e,"parentWaypointSenderID")&&t.uint32(10).string(e.parentWaypointSenderID),t.uint32(16).sint32(e.parentWaypointCounterAndSide),t.uint32(24).uint32(e.parentValueIndex),t},s.encodeDelimited=function(e,t){return this.encode(e,t).ldelim()},s.decode=function(e,t){e instanceof $Reader$1||(e=$Reader$1.create(e));let r=t===void 0?e.len:e.pos+t,l=new s;for(;e.pos<r;){let o=e.uint32();switch(o>>>3){case 1:l.parentWaypointSenderID=e.string();break;case 2:l.parentWaypointCounterAndSide=e.sint32();break;case 3:l.parentValueIndex=e.uint32();break;default:e.skipType(o&7);break}}if(!l.hasOwnProperty("parentWaypointCounterAndSide"))throw $util$1.ProtocolError("missing required 'parentWaypointCounterAndSide'",{instance:l});if(!l.hasOwnProperty("parentValueIndex"))throw $util$1.ProtocolError("missing required 'parentValueIndex'",{instance:l});return l},s.decodeDelimited=function(e){return e instanceof $Reader$1||(e=new $Reader$1(e)),this.decode(e,e.uint32())},s.verify=function(e){return typeof e!="object"||e===null?"object expected":e.parentWaypointSenderID!=null&&e.hasOwnProperty("parentWaypointSenderID")&&!$util$1.isString(e.parentWaypointSenderID)?"parentWaypointSenderID: string expected":$util$1.isInteger(e.parentWaypointCounterAndSide)?$util$1.isInteger(e.parentValueIndex)?null:"parentValueIndex: integer expected":"parentWaypointCounterAndSide: integer expected"},s.fromObject=function(e){if(e instanceof s)return e;let t=new s;return e.parentWaypointSenderID!=null&&(t.parentWaypointSenderID=String(e.parentWaypointSenderID)),e.parentWaypointCounterAndSide!=null&&(t.parentWaypointCounterAndSide=e.parentWaypointCounterAndSide|0),e.parentValueIndex!=null&&(t.parentValueIndex=e.parentValueIndex>>>0),t},s.toObject=function(e,t){t||(t={});let r={};return t.defaults&&(r.parentWaypointSenderID="",r.parentWaypointCounterAndSide=0,r.parentValueIndex=0),e.parentWaypointSenderID!=null&&e.hasOwnProperty("parentWaypointSenderID")&&(r.parentWaypointSenderID=e.parentWaypointSenderID),e.parentWaypointCounterAndSide!=null&&e.hasOwnProperty("parentWaypointCounterAndSide")&&(r.parentWaypointCounterAndSide=e.parentWaypointCounterAndSide),e.parentValueIndex!=null&&e.hasOwnProperty("parentValueIndex")&&(r.parentValueIndex=e.parentValueIndex),r},s.prototype.toJSON=function(){return this.constructor.toObject(this,minimal.util.toJSONOptions)},s})(),TotalOrderSave=(()=>{function s(n){if(this.replicaIDs=[],this.replicaCounts=[],this.parentWaypoints=[],this.parentValueIndexAndSides=[],n)for(let e=Object.keys(n),t=0;t<e.length;++t)n[e[t]]!=null&&(this[e[t]]=n[e[t]])}return s.prototype.replicaIDs=$util$1.emptyArray,s.prototype.replicaCounts=$util$1.emptyArray,s.prototype.parentWaypoints=$util$1.emptyArray,s.prototype.parentValueIndexAndSides=$util$1.emptyArray,s.create=function(e){return new s(e)},s.encode=function(e,t){if(t||(t=$Writer$1.create()),e.replicaIDs!=null&&e.replicaIDs.length)for(let r=0;r<e.replicaIDs.length;++r)t.uint32(10).string(e.replicaIDs[r]);if(e.replicaCounts!=null&&e.replicaCounts.length){t.uint32(18).fork();for(let r=0;r<e.replicaCounts.length;++r)t.uint32(e.replicaCounts[r]);t.ldelim()}if(e.parentWaypoints!=null&&e.parentWaypoints.length){t.uint32(26).fork();for(let r=0;r<e.parentWaypoints.length;++r)t.uint32(e.parentWaypoints[r]);t.ldelim()}if(e.parentValueIndexAndSides!=null&&e.parentValueIndexAndSides.length){t.uint32(34).fork();for(let r=0;r<e.parentValueIndexAndSides.length;++r)t.sint32(e.parentValueIndexAndSides[r]);t.ldelim()}return t},s.encodeDelimited=function(e,t){return this.encode(e,t).ldelim()},s.decode=function(e,t){e instanceof $Reader$1||(e=$Reader$1.create(e));let r=t===void 0?e.len:e.pos+t,l=new s;for(;e.pos<r;){let o=e.uint32();switch(o>>>3){case 1:l.replicaIDs&&l.replicaIDs.length||(l.replicaIDs=[]),l.replicaIDs.push(e.string());break;case 2:if(l.replicaCounts&&l.replicaCounts.length||(l.replicaCounts=[]),(o&7)===2){let a=e.uint32()+e.pos;for(;e.pos<a;)l.replicaCounts.push(e.uint32())}else l.replicaCounts.push(e.uint32());break;case 3:if(l.parentWaypoints&&l.parentWaypoints.length||(l.parentWaypoints=[]),(o&7)===2){let a=e.uint32()+e.pos;for(;e.pos<a;)l.parentWaypoints.push(e.uint32())}else l.parentWaypoints.push(e.uint32());break;case 4:if(l.parentValueIndexAndSides&&l.parentValueIndexAndSides.length||(l.parentValueIndexAndSides=[]),(o&7)===2){let a=e.uint32()+e.pos;for(;e.pos<a;)l.parentValueIndexAndSides.push(e.sint32())}else l.parentValueIndexAndSides.push(e.sint32());break;default:e.skipType(o&7);break}}return l},s.decodeDelimited=function(e){return e instanceof $Reader$1||(e=new $Reader$1(e)),this.decode(e,e.uint32())},s.verify=function(e){if(typeof e!="object"||e===null)return"object expected";if(e.replicaIDs!=null&&e.hasOwnProperty("replicaIDs")){if(!Array.isArray(e.replicaIDs))return"replicaIDs: array expected";for(let t=0;t<e.replicaIDs.length;++t)if(!$util$1.isString(e.replicaIDs[t]))return"replicaIDs: string[] expected"}if(e.replicaCounts!=null&&e.hasOwnProperty("replicaCounts")){if(!Array.isArray(e.replicaCounts))return"replicaCounts: array expected";for(let t=0;t<e.replicaCounts.length;++t)if(!$util$1.isInteger(e.replicaCounts[t]))return"replicaCounts: integer[] expected"}if(e.parentWaypoints!=null&&e.hasOwnProperty("parentWaypoints")){if(!Array.isArray(e.parentWaypoints))return"parentWaypoints: array expected";for(let t=0;t<e.parentWaypoints.length;++t)if(!$util$1.isInteger(e.parentWaypoints[t]))return"parentWaypoints: integer[] expected"}if(e.parentValueIndexAndSides!=null&&e.hasOwnProperty("parentValueIndexAndSides")){if(!Array.isArray(e.parentValueIndexAndSides))return"parentValueIndexAndSides: array expected";for(let t=0;t<e.parentValueIndexAndSides.length;++t)if(!$util$1.isInteger(e.parentValueIndexAndSides[t]))return"parentValueIndexAndSides: integer[] expected"}return null},s.fromObject=function(e){if(e instanceof s)return e;let t=new s;if(e.replicaIDs){if(!Array.isArray(e.replicaIDs))throw TypeError(".TotalOrderSave.replicaIDs: array expected");t.replicaIDs=[];for(let r=0;r<e.replicaIDs.length;++r)t.replicaIDs[r]=String(e.replicaIDs[r])}if(e.replicaCounts){if(!Array.isArray(e.replicaCounts))throw TypeError(".TotalOrderSave.replicaCounts: array expected");t.replicaCounts=[];for(let r=0;r<e.replicaCounts.length;++r)t.replicaCounts[r]=e.replicaCounts[r]>>>0}if(e.parentWaypoints){if(!Array.isArray(e.parentWaypoints))throw TypeError(".TotalOrderSave.parentWaypoints: array expected");t.parentWaypoints=[];for(let r=0;r<e.parentWaypoints.length;++r)t.parentWaypoints[r]=e.parentWaypoints[r]>>>0}if(e.parentValueIndexAndSides){if(!Array.isArray(e.parentValueIndexAndSides))throw TypeError(".TotalOrderSave.parentValueIndexAndSides: array expected");t.parentValueIndexAndSides=[];for(let r=0;r<e.parentValueIndexAndSides.length;++r)t.parentValueIndexAndSides[r]=e.parentValueIndexAndSides[r]|0}return t},s.toObject=function(e,t){t||(t={});let r={};if((t.arrays||t.defaults)&&(r.replicaIDs=[],r.replicaCounts=[],r.parentWaypoints=[],r.parentValueIndexAndSides=[]),e.replicaIDs&&e.replicaIDs.length){r.replicaIDs=[];for(let l=0;l<e.replicaIDs.length;++l)r.replicaIDs[l]=e.replicaIDs[l]}if(e.replicaCounts&&e.replicaCounts.length){r.replicaCounts=[];for(let l=0;l<e.replicaCounts.length;++l)r.replicaCounts[l]=e.replicaCounts[l]}if(e.parentWaypoints&&e.parentWaypoints.length){r.parentWaypoints=[];for(let l=0;l<e.parentWaypoints.length;++l)r.parentWaypoints[l]=e.parentWaypoints[l]}if(e.parentValueIndexAndSides&&e.parentValueIndexAndSides.length){r.parentValueIndexAndSides=[];for(let l=0;l<e.parentValueIndexAndSides.length;++l)r.parentValueIndexAndSides[l]=e.parentValueIndexAndSides[l]}return r},s.prototype.toJSON=function(){return this.constructor.toObject(this,minimal.util.toJSONOptions)},s})(),LocalListSave=(()=>{function s(n){if(this.replicaIDs=[],this.replicaIDIndices=[],this.counters=[],this.totals=[],this.seens=[],this.itemsLengths=[],this.itemSizes=[],n)for(let e=Object.keys(n),t=0;t<e.length;++t)n[e[t]]!=null&&(this[e[t]]=n[e[t]])}return s.prototype.replicaIDs=$util$1.emptyArray,s.prototype.replicaIDIndices=$util$1.emptyArray,s.prototype.counters=$util$1.emptyArray,s.prototype.totals=$util$1.emptyArray,s.prototype.seens=$util$1.emptyArray,s.prototype.itemsLengths=$util$1.emptyArray,s.prototype.itemSizes=$util$1.emptyArray,s.prototype.values=$util$1.newBuffer([]),s.create=function(e){return new s(e)},s.encode=function(e,t){if(t||(t=$Writer$1.create()),e.replicaIDs!=null&&e.replicaIDs.length)for(let r=0;r<e.replicaIDs.length;++r)t.uint32(10).string(e.replicaIDs[r]);if(e.replicaIDIndices!=null&&e.replicaIDIndices.length){t.uint32(18).fork();for(let r=0;r<e.replicaIDIndices.length;++r)t.uint32(e.replicaIDIndices[r]);t.ldelim()}if(e.counters!=null&&e.counters.length){t.uint32(26).fork();for(let r=0;r<e.counters.length;++r)t.uint32(e.counters[r]);t.ldelim()}if(e.totals!=null&&e.totals.length){t.uint32(34).fork();for(let r=0;r<e.totals.length;++r)t.uint32(e.totals[r]);t.ldelim()}if(e.seens!=null&&e.seens.length){t.uint32(42).fork();for(let r=0;r<e.seens.length;++r)t.uint32(e.seens[r]);t.ldelim()}if(e.itemsLengths!=null&&e.itemsLengths.length){t.uint32(50).fork();for(let r=0;r<e.itemsLengths.length;++r)t.uint32(e.itemsLengths[r]);t.ldelim()}if(e.itemSizes!=null&&e.itemSizes.length){t.uint32(58).fork();for(let r=0;r<e.itemSizes.length;++r)t.sint32(e.itemSizes[r]);t.ldelim()}return t.uint32(66).bytes(e.values),t},s.encodeDelimited=function(e,t){return this.encode(e,t).ldelim()},s.decode=function(e,t){e instanceof $Reader$1||(e=$Reader$1.create(e));let r=t===void 0?e.len:e.pos+t,l=new s;for(;e.pos<r;){let o=e.uint32();switch(o>>>3){case 1:l.replicaIDs&&l.replicaIDs.length||(l.replicaIDs=[]),l.replicaIDs.push(e.string());break;case 2:if(l.replicaIDIndices&&l.replicaIDIndices.length||(l.replicaIDIndices=[]),(o&7)===2){let a=e.uint32()+e.pos;for(;e.pos<a;)l.replicaIDIndices.push(e.uint32())}else l.replicaIDIndices.push(e.uint32());break;case 3:if(l.counters&&l.counters.length||(l.counters=[]),(o&7)===2){let a=e.uint32()+e.pos;for(;e.pos<a;)l.counters.push(e.uint32())}else l.counters.push(e.uint32());break;case 4:if(l.totals&&l.totals.length||(l.totals=[]),(o&7)===2){let a=e.uint32()+e.pos;for(;e.pos<a;)l.totals.push(e.uint32())}else l.totals.push(e.uint32());break;case 5:if(l.seens&&l.seens.length||(l.seens=[]),(o&7)===2){let a=e.uint32()+e.pos;for(;e.pos<a;)l.seens.push(e.uint32())}else l.seens.push(e.uint32());break;case 6:if(l.itemsLengths&&l.itemsLengths.length||(l.itemsLengths=[]),(o&7)===2){let a=e.uint32()+e.pos;for(;e.pos<a;)l.itemsLengths.push(e.uint32())}else l.itemsLengths.push(e.uint32());break;case 7:if(l.itemSizes&&l.itemSizes.length||(l.itemSizes=[]),(o&7)===2){let a=e.uint32()+e.pos;for(;e.pos<a;)l.itemSizes.push(e.sint32())}else l.itemSizes.push(e.sint32());break;case 8:l.values=e.bytes();break;default:e.skipType(o&7);break}}if(!l.hasOwnProperty("values"))throw $util$1.ProtocolError("missing required 'values'",{instance:l});return l},s.decodeDelimited=function(e){return e instanceof $Reader$1||(e=new $Reader$1(e)),this.decode(e,e.uint32())},s.verify=function(e){if(typeof e!="object"||e===null)return"object expected";if(e.replicaIDs!=null&&e.hasOwnProperty("replicaIDs")){if(!Array.isArray(e.replicaIDs))return"replicaIDs: array expected";for(let t=0;t<e.replicaIDs.length;++t)if(!$util$1.isString(e.replicaIDs[t]))return"replicaIDs: string[] expected"}if(e.replicaIDIndices!=null&&e.hasOwnProperty("replicaIDIndices")){if(!Array.isArray(e.replicaIDIndices))return"replicaIDIndices: array expected";for(let t=0;t<e.replicaIDIndices.length;++t)if(!$util$1.isInteger(e.replicaIDIndices[t]))return"replicaIDIndices: integer[] expected"}if(e.counters!=null&&e.hasOwnProperty("counters")){if(!Array.isArray(e.counters))return"counters: array expected";for(let t=0;t<e.counters.length;++t)if(!$util$1.isInteger(e.counters[t]))return"counters: integer[] expected"}if(e.totals!=null&&e.hasOwnProperty("totals")){if(!Array.isArray(e.totals))return"totals: array expected";for(let t=0;t<e.totals.length;++t)if(!$util$1.isInteger(e.totals[t]))return"totals: integer[] expected"}if(e.seens!=null&&e.hasOwnProperty("seens")){if(!Array.isArray(e.seens))return"seens: array expected";for(let t=0;t<e.seens.length;++t)if(!$util$1.isInteger(e.seens[t]))return"seens: integer[] expected"}if(e.itemsLengths!=null&&e.hasOwnProperty("itemsLengths")){if(!Array.isArray(e.itemsLengths))return"itemsLengths: array expected";for(let t=0;t<e.itemsLengths.length;++t)if(!$util$1.isInteger(e.itemsLengths[t]))return"itemsLengths: integer[] expected"}if(e.itemSizes!=null&&e.hasOwnProperty("itemSizes")){if(!Array.isArray(e.itemSizes))return"itemSizes: array expected";for(let t=0;t<e.itemSizes.length;++t)if(!$util$1.isInteger(e.itemSizes[t]))return"itemSizes: integer[] expected"}return e.values&&typeof e.values.length=="number"||$util$1.isString(e.values)?null:"values: buffer expected"},s.fromObject=function(e){if(e instanceof s)return e;let t=new s;if(e.replicaIDs){if(!Array.isArray(e.replicaIDs))throw TypeError(".LocalListSave.replicaIDs: array expected");t.replicaIDs=[];for(let r=0;r<e.replicaIDs.length;++r)t.replicaIDs[r]=String(e.replicaIDs[r])}if(e.replicaIDIndices){if(!Array.isArray(e.replicaIDIndices))throw TypeError(".LocalListSave.replicaIDIndices: array expected");t.replicaIDIndices=[];for(let r=0;r<e.replicaIDIndices.length;++r)t.replicaIDIndices[r]=e.replicaIDIndices[r]>>>0}if(e.counters){if(!Array.isArray(e.counters))throw TypeError(".LocalListSave.counters: array expected");t.counters=[];for(let r=0;r<e.counters.length;++r)t.counters[r]=e.counters[r]>>>0}if(e.totals){if(!Array.isArray(e.totals))throw TypeError(".LocalListSave.totals: array expected");t.totals=[];for(let r=0;r<e.totals.length;++r)t.totals[r]=e.totals[r]>>>0}if(e.seens){if(!Array.isArray(e.seens))throw TypeError(".LocalListSave.seens: array expected");t.seens=[];for(let r=0;r<e.seens.length;++r)t.seens[r]=e.seens[r]>>>0}if(e.itemsLengths){if(!Array.isArray(e.itemsLengths))throw TypeError(".LocalListSave.itemsLengths: array expected");t.itemsLengths=[];for(let r=0;r<e.itemsLengths.length;++r)t.itemsLengths[r]=e.itemsLengths[r]>>>0}if(e.itemSizes){if(!Array.isArray(e.itemSizes))throw TypeError(".LocalListSave.itemSizes: array expected");t.itemSizes=[];for(let r=0;r<e.itemSizes.length;++r)t.itemSizes[r]=e.itemSizes[r]|0}return e.values!=null&&(typeof e.values=="string"?$util$1.base64.decode(e.values,t.values=$util$1.newBuffer($util$1.base64.length(e.values)),0):e.values.length&&(t.values=e.values)),t},s.toObject=function(e,t){t||(t={});let r={};if((t.arrays||t.defaults)&&(r.replicaIDs=[],r.replicaIDIndices=[],r.counters=[],r.totals=[],r.seens=[],r.itemsLengths=[],r.itemSizes=[]),t.defaults&&(t.bytes===String?r.values="":(r.values=[],t.bytes!==Array&&(r.values=$util$1.newBuffer(r.values)))),e.replicaIDs&&e.replicaIDs.length){r.replicaIDs=[];for(let l=0;l<e.replicaIDs.length;++l)r.replicaIDs[l]=e.replicaIDs[l]}if(e.replicaIDIndices&&e.replicaIDIndices.length){r.replicaIDIndices=[];for(let l=0;l<e.replicaIDIndices.length;++l)r.replicaIDIndices[l]=e.replicaIDIndices[l]}if(e.counters&&e.counters.length){r.counters=[];for(let l=0;l<e.counters.length;++l)r.counters[l]=e.counters[l]}if(e.totals&&e.totals.length){r.totals=[];for(let l=0;l<e.totals.length;++l)r.totals[l]=e.totals[l]}if(e.seens&&e.seens.length){r.seens=[];for(let l=0;l<e.seens.length;++l)r.seens[l]=e.seens[l]}if(e.itemsLengths&&e.itemsLengths.length){r.itemsLengths=[];for(let l=0;l<e.itemsLengths.length;++l)r.itemsLengths[l]=e.itemsLengths[l]}if(e.itemSizes&&e.itemSizes.length){r.itemSizes=[];for(let l=0;l<e.itemSizes.length;++l)r.itemSizes[l]=e.itemSizes[l]}return e.values!=null&&e.hasOwnProperty("values")&&(r.values=t.bytes===String?$util$1.base64.encode(e.values,0,e.values.length):t.bytes===Array?Array.prototype.slice.call(e.values):e.values),r},s.prototype.toJSON=function(){return this.constructor.toObject(this,minimal.util.toJSONOptions)},s})(),SpanLogPartialSpanMessage=(()=>{function s(n){if(n)for(let e=Object.keys(n),t=0;t<e.length;++t)n[e[t]]!=null&&(this[e[t]]=n[e[t]])}return s.prototype.key="",s.prototype.value=$util$1.newBuffer([]),s.prototype.startPosition="",s.prototype.endPosition="",s.prototype.endClosed=!1,s.create=function(e){return new s(e)},s.encode=function(e,t){return t||(t=$Writer$1.create()),t.uint32(10).string(e.key),e.value!=null&&Object.hasOwnProperty.call(e,"value")&&t.uint32(18).bytes(e.value),t.uint32(26).string(e.startPosition),e.endPosition!=null&&Object.hasOwnProperty.call(e,"endPosition")&&t.uint32(34).string(e.endPosition),e.endClosed!=null&&Object.hasOwnProperty.call(e,"endClosed")&&t.uint32(40).bool(e.endClosed),t},s.encodeDelimited=function(e,t){return this.encode(e,t).ldelim()},s.decode=function(e,t){e instanceof $Reader$1||(e=$Reader$1.create(e));let r=t===void 0?e.len:e.pos+t,l=new s;for(;e.pos<r;){let o=e.uint32();switch(o>>>3){case 1:l.key=e.string();break;case 2:l.value=e.bytes();break;case 3:l.startPosition=e.string();break;case 4:l.endPosition=e.string();break;case 5:l.endClosed=e.bool();break;default:e.skipType(o&7);break}}if(!l.hasOwnProperty("key"))throw $util$1.ProtocolError("missing required 'key'",{instance:l});if(!l.hasOwnProperty("startPosition"))throw $util$1.ProtocolError("missing required 'startPosition'",{instance:l});return l},s.decodeDelimited=function(e){return e instanceof $Reader$1||(e=new $Reader$1(e)),this.decode(e,e.uint32())},s.verify=function(e){return typeof e!="object"||e===null?"object expected":$util$1.isString(e.key)?e.value!=null&&e.hasOwnProperty("value")&&!(e.value&&typeof e.value.length=="number"||$util$1.isString(e.value))?"value: buffer expected":$util$1.isString(e.startPosition)?e.endPosition!=null&&e.hasOwnProperty("endPosition")&&!$util$1.isString(e.endPosition)?"endPosition: string expected":e.endClosed!=null&&e.hasOwnProperty("endClosed")&&typeof e.endClosed!="boolean"?"endClosed: boolean expected":null:"startPosition: string expected":"key: string expected"},s.fromObject=function(e){if(e instanceof s)return e;let t=new s;return e.key!=null&&(t.key=String(e.key)),e.value!=null&&(typeof e.value=="string"?$util$1.base64.decode(e.value,t.value=$util$1.newBuffer($util$1.base64.length(e.value)),0):e.value.length&&(t.value=e.value)),e.startPosition!=null&&(t.startPosition=String(e.startPosition)),e.endPosition!=null&&(t.endPosition=String(e.endPosition)),e.endClosed!=null&&(t.endClosed=!!e.endClosed),t},s.toObject=function(e,t){t||(t={});let r={};return t.defaults&&(r.key="",t.bytes===String?r.value="":(r.value=[],t.bytes!==Array&&(r.value=$util$1.newBuffer(r.value))),r.startPosition="",r.endPosition="",r.endClosed=!1),e.key!=null&&e.hasOwnProperty("key")&&(r.key=e.key),e.value!=null&&e.hasOwnProperty("value")&&(r.value=t.bytes===String?$util$1.base64.encode(e.value,0,e.value.length):t.bytes===Array?Array.prototype.slice.call(e.value):e.value),e.startPosition!=null&&e.hasOwnProperty("startPosition")&&(r.startPosition=e.startPosition),e.endPosition!=null&&e.hasOwnProperty("endPosition")&&(r.endPosition=e.endPosition),e.endClosed!=null&&e.hasOwnProperty("endClosed")&&(r.endClosed=e.endClosed),r},s.prototype.toJSON=function(){return this.constructor.toObject(this,minimal.util.toJSONOptions)},s})(),SpanLogSaveMessage=(()=>{function s(n){if(this.senderIDs=[],this.lengths=[],this.spans=[],this.lamports=[],n)for(let e=Object.keys(n),t=0;t<e.length;++t)n[e[t]]!=null&&(this[e[t]]=n[e[t]])}return s.prototype.senderIDs=$util$1.emptyArray,s.prototype.lengths=$util$1.emptyArray,s.prototype.spans=$util$1.emptyArray,s.prototype.lamports=$util$1.emptyArray,s.create=function(e){return new s(e)},s.encode=function(e,t){if(t||(t=$Writer$1.create()),e.senderIDs!=null&&e.senderIDs.length)for(let r=0;r<e.senderIDs.length;++r)t.uint32(10).string(e.senderIDs[r]);if(e.lengths!=null&&e.lengths.length){t.uint32(18).fork();for(let r=0;r<e.lengths.length;++r)t.uint32(e.lengths[r]);t.ldelim()}if(e.spans!=null&&e.spans.length)for(let r=0;r<e.spans.length;++r)t.uint32(26).bytes(e.spans[r]);if(e.lamports!=null&&e.lamports.length){t.uint32(34).fork();for(let r=0;r<e.lamports.length;++r)t.uint64(e.lamports[r]);t.ldelim()}return t},s.encodeDelimited=function(e,t){return this.encode(e,t).ldelim()},s.decode=function(e,t){e instanceof $Reader$1||(e=$Reader$1.create(e));let r=t===void 0?e.len:e.pos+t,l=new s;for(;e.pos<r;){let o=e.uint32();switch(o>>>3){case 1:l.senderIDs&&l.senderIDs.length||(l.senderIDs=[]),l.senderIDs.push(e.string());break;case 2:if(l.lengths&&l.lengths.length||(l.lengths=[]),(o&7)===2){let a=e.uint32()+e.pos;for(;e.pos<a;)l.lengths.push(e.uint32())}else l.lengths.push(e.uint32());break;case 3:l.spans&&l.spans.length||(l.spans=[]),l.spans.push(e.bytes());break;case 4:if(l.lamports&&l.lamports.length||(l.lamports=[]),(o&7)===2){let a=e.uint32()+e.pos;for(;e.pos<a;)l.lamports.push(e.uint64())}else l.lamports.push(e.uint64());break;default:e.skipType(o&7);break}}return l},s.decodeDelimited=function(e){return e instanceof $Reader$1||(e=new $Reader$1(e)),this.decode(e,e.uint32())},s.verify=function(e){if(typeof e!="object"||e===null)return"object expected";if(e.senderIDs!=null&&e.hasOwnProperty("senderIDs")){if(!Array.isArray(e.senderIDs))return"senderIDs: array expected";for(let t=0;t<e.senderIDs.length;++t)if(!$util$1.isString(e.senderIDs[t]))return"senderIDs: string[] expected"}if(e.lengths!=null&&e.hasOwnProperty("lengths")){if(!Array.isArray(e.lengths))return"lengths: array expected";for(let t=0;t<e.lengths.length;++t)if(!$util$1.isInteger(e.lengths[t]))return"lengths: integer[] expected"}if(e.spans!=null&&e.hasOwnProperty("spans")){if(!Array.isArray(e.spans))return"spans: array expected";for(let t=0;t<e.spans.length;++t)if(!(e.spans[t]&&typeof e.spans[t].length=="number"||$util$1.isString(e.spans[t])))return"spans: buffer[] expected"}if(e.lamports!=null&&e.hasOwnProperty("lamports")){if(!Array.isArray(e.lamports))return"lamports: array expected";for(let t=0;t<e.lamports.length;++t)if(!$util$1.isInteger(e.lamports[t])&&!(e.lamports[t]&&$util$1.isInteger(e.lamports[t].low)&&$util$1.isInteger(e.lamports[t].high)))return"lamports: integer|Long[] expected"}return null},s.fromObject=function(e){if(e instanceof s)return e;let t=new s;if(e.senderIDs){if(!Array.isArray(e.senderIDs))throw TypeError(".SpanLogSaveMessage.senderIDs: array expected");t.senderIDs=[];for(let r=0;r<e.senderIDs.length;++r)t.senderIDs[r]=String(e.senderIDs[r])}if(e.lengths){if(!Array.isArray(e.lengths))throw TypeError(".SpanLogSaveMessage.lengths: array expected");t.lengths=[];for(let r=0;r<e.lengths.length;++r)t.lengths[r]=e.lengths[r]>>>0}if(e.spans){if(!Array.isArray(e.spans))throw TypeError(".SpanLogSaveMessage.spans: array expected");t.spans=[];for(let r=0;r<e.spans.length;++r)typeof e.spans[r]=="string"?$util$1.base64.decode(e.spans[r],t.spans[r]=$util$1.newBuffer($util$1.base64.length(e.spans[r])),0):e.spans[r].length&&(t.spans[r]=e.spans[r])}if(e.lamports){if(!Array.isArray(e.lamports))throw TypeError(".SpanLogSaveMessage.lamports: array expected");t.lamports=[];for(let r=0;r<e.lamports.length;++r)$util$1.Long?(t.lamports[r]=$util$1.Long.fromValue(e.lamports[r])).unsigned=!0:typeof e.lamports[r]=="string"?t.lamports[r]=parseInt(e.lamports[r],10):typeof e.lamports[r]=="number"?t.lamports[r]=e.lamports[r]:typeof e.lamports[r]=="object"&&(t.lamports[r]=new $util$1.LongBits(e.lamports[r].low>>>0,e.lamports[r].high>>>0).toNumber(!0))}return t},s.toObject=function(e,t){t||(t={});let r={};if((t.arrays||t.defaults)&&(r.senderIDs=[],r.lengths=[],r.spans=[],r.lamports=[]),e.senderIDs&&e.senderIDs.length){r.senderIDs=[];for(let l=0;l<e.senderIDs.length;++l)r.senderIDs[l]=e.senderIDs[l]}if(e.lengths&&e.lengths.length){r.lengths=[];for(let l=0;l<e.lengths.length;++l)r.lengths[l]=e.lengths[l]}if(e.spans&&e.spans.length){r.spans=[];for(let l=0;l<e.spans.length;++l)r.spans[l]=t.bytes===String?$util$1.base64.encode(e.spans[l],0,e.spans[l].length):t.bytes===Array?Array.prototype.slice.call(e.spans[l]):e.spans[l]}if(e.lamports&&e.lamports.length){r.lamports=[];for(let l=0;l<e.lamports.length;++l)typeof e.lamports[l]=="number"?r.lamports[l]=t.longs===String?String(e.lamports[l]):e.lamports[l]:r.lamports[l]=t.longs===String?$util$1.Long.prototype.toString.call(e.lamports[l]):t.longs===Number?new $util$1.LongBits(e.lamports[l].low>>>0,e.lamports[l].high>>>0).toNumber(!0):e.lamports[l]}return r},s.prototype.toJSON=function(){return this.constructor.toObject(this,minimal.util.toJSONOptions)},s})(),ValueListInsertMessage=(()=>{function s(e){if(e)for(let t=Object.keys(e),r=0;r<t.length;++r)e[t[r]]!=null&&(this[t[r]]=e[t[r]])}s.prototype.counter=0,s.prototype.valueIndex=0,s.prototype.value=$util$1.newBuffer([]),s.prototype.valueArray=$util$1.newBuffer([]);let n;return Object.defineProperty(s.prototype,"data",{get:$util$1.oneOfGetter(n=["value","valueArray"]),set:$util$1.oneOfSetter(n)}),s.create=function(t){return new s(t)},s.encode=function(t,r){return r||(r=$Writer$1.create()),r.uint32(8).uint32(t.counter),t.valueIndex!=null&&Object.hasOwnProperty.call(t,"valueIndex")&&r.uint32(16).uint32(t.valueIndex),t.value!=null&&Object.hasOwnProperty.call(t,"value")&&r.uint32(26).bytes(t.value),t.valueArray!=null&&Object.hasOwnProperty.call(t,"valueArray")&&r.uint32(34).bytes(t.valueArray),r},s.encodeDelimited=function(t,r){return this.encode(t,r).ldelim()},s.decode=function(t,r){t instanceof $Reader$1||(t=$Reader$1.create(t));let l=r===void 0?t.len:t.pos+r,o=new s;for(;t.pos<l;){let a=t.uint32();switch(a>>>3){case 1:o.counter=t.uint32();break;case 2:o.valueIndex=t.uint32();break;case 3:o.value=t.bytes();break;case 4:o.valueArray=t.bytes();break;default:t.skipType(a&7);break}}if(!o.hasOwnProperty("counter"))throw $util$1.ProtocolError("missing required 'counter'",{instance:o});return o},s.decodeDelimited=function(t){return t instanceof $Reader$1||(t=new $Reader$1(t)),this.decode(t,t.uint32())},s.verify=function(t){if(typeof t!="object"||t===null)return"object expected";let r={};if(!$util$1.isInteger(t.counter))return"counter: integer expected";if(t.valueIndex!=null&&t.hasOwnProperty("valueIndex")&&!$util$1.isInteger(t.valueIndex))return"valueIndex: integer expected";if(t.value!=null&&t.hasOwnProperty("value")&&(r.data=1,!(t.value&&typeof t.value.length=="number"||$util$1.isString(t.value))))return"value: buffer expected";if(t.valueArray!=null&&t.hasOwnProperty("valueArray")){if(r.data===1)return"data: multiple values";if(r.data=1,!(t.valueArray&&typeof t.valueArray.length=="number"||$util$1.isString(t.valueArray)))return"valueArray: buffer expected"}return null},s.fromObject=function(t){if(t instanceof s)return t;let r=new s;return t.counter!=null&&(r.counter=t.counter>>>0),t.valueIndex!=null&&(r.valueIndex=t.valueIndex>>>0),t.value!=null&&(typeof t.value=="string"?$util$1.base64.decode(t.value,r.value=$util$1.newBuffer($util$1.base64.length(t.value)),0):t.value.length&&(r.value=t.value)),t.valueArray!=null&&(typeof t.valueArray=="string"?$util$1.base64.decode(t.valueArray,r.valueArray=$util$1.newBuffer($util$1.base64.length(t.valueArray)),0):t.valueArray.length&&(r.valueArray=t.valueArray)),r},s.toObject=function(t,r){r||(r={});let l={};return r.defaults&&(l.counter=0,l.valueIndex=0),t.counter!=null&&t.hasOwnProperty("counter")&&(l.counter=t.counter),t.valueIndex!=null&&t.hasOwnProperty("valueIndex")&&(l.valueIndex=t.valueIndex),t.value!=null&&t.hasOwnProperty("value")&&(l.value=r.bytes===String?$util$1.base64.encode(t.value,0,t.value.length):r.bytes===Array?Array.prototype.slice.call(t.value):t.value,r.oneofs&&(l.data="value")),t.valueArray!=null&&t.hasOwnProperty("valueArray")&&(l.valueArray=r.bytes===String?$util$1.base64.encode(t.valueArray,0,t.valueArray.length):r.bytes===Array?Array.prototype.slice.call(t.valueArray):t.valueArray,r.oneofs&&(l.data="valueArray")),l},s.prototype.toJSON=function(){return this.constructor.toObject(this,minimal.util.toJSONOptions)},s})(),ValueListMessage=(()=>{function s(e){if(e)for(let t=Object.keys(e),r=0;r<t.length;++r)e[t[r]]!=null&&(this[t[r]]=e[t[r]])}s.prototype.insert=null,s.prototype.delete="";let n;return Object.defineProperty(s.prototype,"op",{get:$util$1.oneOfGetter(n=["insert","delete"]),set:$util$1.oneOfSetter(n)}),s.create=function(t){return new s(t)},s.encode=function(t,r){return r||(r=$Writer$1.create()),t.insert!=null&&Object.hasOwnProperty.call(t,"insert")&&ValueListInsertMessage.encode(t.insert,r.uint32(10).fork()).ldelim(),t.delete!=null&&Object.hasOwnProperty.call(t,"delete")&&r.uint32(18).string(t.delete),r},s.encodeDelimited=function(t,r){return this.encode(t,r).ldelim()},s.decode=function(t,r){t instanceof $Reader$1||(t=$Reader$1.create(t));let l=r===void 0?t.len:t.pos+r,o=new s;for(;t.pos<l;){let a=t.uint32();switch(a>>>3){case 1:o.insert=ValueListInsertMessage.decode(t,t.uint32());break;case 2:o.delete=t.string();break;default:t.skipType(a&7);break}}return o},s.decodeDelimited=function(t){return t instanceof $Reader$1||(t=new $Reader$1(t)),this.decode(t,t.uint32())},s.verify=function(t){if(typeof t!="object"||t===null)return"object expected";let r={};if(t.insert!=null&&t.hasOwnProperty("insert")){r.op=1;{let l=ValueListInsertMessage.verify(t.insert);if(l)return"insert."+l}}if(t.delete!=null&&t.hasOwnProperty("delete")){if(r.op===1)return"op: multiple values";if(r.op=1,!$util$1.isString(t.delete))return"delete: string expected"}return null},s.fromObject=function(t){if(t instanceof s)return t;let r=new s;if(t.insert!=null){if(typeof t.insert!="object")throw TypeError(".ValueListMessage.insert: object expected");r.insert=ValueListInsertMessage.fromObject(t.insert)}return t.delete!=null&&(r.delete=String(t.delete)),r},s.toObject=function(t,r){r||(r={});let l={};return t.insert!=null&&t.hasOwnProperty("insert")&&(l.insert=ValueListInsertMessage.toObject(t.insert,r),r.oneofs&&(l.op="insert")),t.delete!=null&&t.hasOwnProperty("delete")&&(l.delete=t.delete,r.oneofs&&(l.op="delete")),l},s.prototype.toJSON=function(){return this.constructor.toObject(this,minimal.util.toJSONOptions)},s})(),MessageSerializerMergeInfo=(()=>{function s(n){if(this.replicaIDs=[],this.lengths=[],n)for(let e=Object.keys(n),t=0;t<e.length;++t)n[e[t]]!=null&&(this[e[t]]=n[e[t]])}return s.prototype.replicaIDs=$util$1.emptyArray,s.prototype.lengths=$util$1.emptyArray,s.create=function(e){return new s(e)},s.encode=function(e,t){if(t||(t=$Writer$1.create()),e.replicaIDs!=null&&e.replicaIDs.length)for(let r=0;r<e.replicaIDs.length;++r)t.uint32(10).string(e.replicaIDs[r]);if(e.lengths!=null&&e.lengths.length){t.uint32(18).fork();for(let r=0;r<e.lengths.length;++r)t.uint32(e.lengths[r]);t.ldelim()}return t},s.encodeDelimited=function(e,t){return this.encode(e,t).ldelim()},s.decode=function(e,t){e instanceof $Reader$1||(e=$Reader$1.create(e));let r=t===void 0?e.len:e.pos+t,l=new s;for(;e.pos<r;){let o=e.uint32();switch(o>>>3){case 1:l.replicaIDs&&l.replicaIDs.length||(l.replicaIDs=[]),l.replicaIDs.push(e.string());break;case 2:if(l.lengths&&l.lengths.length||(l.lengths=[]),(o&7)===2){let a=e.uint32()+e.pos;for(;e.pos<a;)l.lengths.push(e.uint32())}else l.lengths.push(e.uint32());break;default:e.skipType(o&7);break}}return l},s.decodeDelimited=function(e){return e instanceof $Reader$1||(e=new $Reader$1(e)),this.decode(e,e.uint32())},s.verify=function(e){if(typeof e!="object"||e===null)return"object expected";if(e.replicaIDs!=null&&e.hasOwnProperty("replicaIDs")){if(!Array.isArray(e.replicaIDs))return"replicaIDs: array expected";for(let t=0;t<e.replicaIDs.length;++t)if(!$util$1.isString(e.replicaIDs[t]))return"replicaIDs: string[] expected"}if(e.lengths!=null&&e.hasOwnProperty("lengths")){if(!Array.isArray(e.lengths))return"lengths: array expected";for(let t=0;t<e.lengths.length;++t)if(!$util$1.isInteger(e.lengths[t]))return"lengths: integer[] expected"}return null},s.fromObject=function(e){if(e instanceof s)return e;let t=new s;if(e.replicaIDs){if(!Array.isArray(e.replicaIDs))throw TypeError(".MessageSerializerMergeInfo.replicaIDs: array expected");t.replicaIDs=[];for(let r=0;r<e.replicaIDs.length;++r)t.replicaIDs[r]=String(e.replicaIDs[r])}if(e.lengths){if(!Array.isArray(e.lengths))throw TypeError(".MessageSerializerMergeInfo.lengths: array expected");t.lengths=[];for(let r=0;r<e.lengths.length;++r)t.lengths[r]=e.lengths[r]>>>0}return t},s.toObject=function(e,t){t||(t={});let r={};if((t.arrays||t.defaults)&&(r.replicaIDs=[],r.lengths=[]),e.replicaIDs&&e.replicaIDs.length){r.replicaIDs=[];for(let l=0;l<e.replicaIDs.length;++l)r.replicaIDs[l]=e.replicaIDs[l]}if(e.lengths&&e.lengths.length){r.lengths=[];for(let l=0;l<e.lengths.length;++l)r.lengths[l]=e.lengths[l]}return r},s.prototype.toJSON=function(){return this.constructor.toObject(this,minimal.util.toJSONOptions)},s})(),CRDTMessageMetaMessage=(()=>{function s(n){if(this.vcKeys=[],this.vcValues=[],this.encodedVcKeys=[],n)for(let e=Object.keys(n),t=0;t<e.length;++t)n[e[t]]!=null&&(this[e[t]]=n[e[t]])}return s.prototype.senderID="",s.prototype.senderCounter=0,s.prototype.vcKeys=$util$1.emptyArray,s.prototype.vcValues=$util$1.emptyArray,s.prototype.maximalVcKeyCount=0,s.prototype.wallClockTime=$util$1.Long?$util$1.Long.fromBits(0,0,!0):0,s.prototype.lamportTimestamp=$util$1.Long?$util$1.Long.fromBits(0,0,!0):0,s.prototype.encodedVcKeys=$util$1.emptyArray,s.create=function(e){return new s(e)},s.encode=function(e,t){if(t||(t=$Writer$1.create()),t.uint32(10).string(e.senderID),t.uint32(16).uint32(e.senderCounter),e.vcKeys!=null&&e.vcKeys.length)for(let r=0;r<e.vcKeys.length;++r)t.uint32(26).string(e.vcKeys[r]);if(e.vcValues!=null&&e.vcValues.length){t.uint32(34).fork();for(let r=0;r<e.vcValues.length;++r)t.uint32(e.vcValues[r]);t.ldelim()}if(e.maximalVcKeyCount!=null&&Object.hasOwnProperty.call(e,"maximalVcKeyCount")&&t.uint32(40).uint32(e.maximalVcKeyCount),e.wallClockTime!=null&&Object.hasOwnProperty.call(e,"wallClockTime")&&t.uint32(48).uint64(e.wallClockTime),e.lamportTimestamp!=null&&Object.hasOwnProperty.call(e,"lamportTimestamp")&&t.uint32(56).uint64(e.lamportTimestamp),e.encodedVcKeys!=null&&e.encodedVcKeys.length){t.uint32(66).fork();for(let r=0;r<e.encodedVcKeys.length;++r)t.uint32(e.encodedVcKeys[r]);t.ldelim()}return t},s.encodeDelimited=function(e,t){return this.encode(e,t).ldelim()},s.decode=function(e,t){e instanceof $Reader$1||(e=$Reader$1.create(e));let r=t===void 0?e.len:e.pos+t,l=new s;for(;e.pos<r;){let o=e.uint32();switch(o>>>3){case 1:l.senderID=e.string();break;case 2:l.senderCounter=e.uint32();break;case 3:l.vcKeys&&l.vcKeys.length||(l.vcKeys=[]),l.vcKeys.push(e.string());break;case 4:if(l.vcValues&&l.vcValues.length||(l.vcValues=[]),(o&7)===2){let a=e.uint32()+e.pos;for(;e.pos<a;)l.vcValues.push(e.uint32())}else l.vcValues.push(e.uint32());break;case 5:l.maximalVcKeyCount=e.uint32();break;case 6:l.wallClockTime=e.uint64();break;case 7:l.lamportTimestamp=e.uint64();break;case 8:if(l.encodedVcKeys&&l.encodedVcKeys.length||(l.encodedVcKeys=[]),(o&7)===2){let a=e.uint32()+e.pos;for(;e.pos<a;)l.encodedVcKeys.push(e.uint32())}else l.encodedVcKeys.push(e.uint32());break;default:e.skipType(o&7);break}}if(!l.hasOwnProperty("senderID"))throw $util$1.ProtocolError("missing required 'senderID'",{instance:l});if(!l.hasOwnProperty("senderCounter"))throw $util$1.ProtocolError("missing required 'senderCounter'",{instance:l});return l},s.decodeDelimited=function(e){return e instanceof $Reader$1||(e=new $Reader$1(e)),this.decode(e,e.uint32())},s.verify=function(e){if(typeof e!="object"||e===null)return"object expected";if(!$util$1.isString(e.senderID))return"senderID: string expected";if(!$util$1.isInteger(e.senderCounter))return"senderCounter: integer expected";if(e.vcKeys!=null&&e.hasOwnProperty("vcKeys")){if(!Array.isArray(e.vcKeys))return"vcKeys: array expected";for(let t=0;t<e.vcKeys.length;++t)if(!$util$1.isString(e.vcKeys[t]))return"vcKeys: string[] expected"}if(e.vcValues!=null&&e.hasOwnProperty("vcValues")){if(!Array.isArray(e.vcValues))return"vcValues: array expected";for(let t=0;t<e.vcValues.length;++t)if(!$util$1.isInteger(e.vcValues[t]))return"vcValues: integer[] expected"}if(e.maximalVcKeyCount!=null&&e.hasOwnProperty("maximalVcKeyCount")&&!$util$1.isInteger(e.maximalVcKeyCount))return"maximalVcKeyCount: integer expected";if(e.wallClockTime!=null&&e.hasOwnProperty("wallClockTime")&&!$util$1.isInteger(e.wallClockTime)&&!(e.wallClockTime&&$util$1.isInteger(e.wallClockTime.low)&&$util$1.isInteger(e.wallClockTime.high)))return"wallClockTime: integer|Long expected";if(e.lamportTimestamp!=null&&e.hasOwnProperty("lamportTimestamp")&&!$util$1.isInteger(e.lamportTimestamp)&&!(e.lamportTimestamp&&$util$1.isInteger(e.lamportTimestamp.low)&&$util$1.isInteger(e.lamportTimestamp.high)))return"lamportTimestamp: integer|Long expected";if(e.encodedVcKeys!=null&&e.hasOwnProperty("encodedVcKeys")){if(!Array.isArray(e.encodedVcKeys))return"encodedVcKeys: array expected";for(let t=0;t<e.encodedVcKeys.length;++t)if(!$util$1.isInteger(e.encodedVcKeys[t]))return"encodedVcKeys: integer[] expected"}return null},s.fromObject=function(e){if(e instanceof s)return e;let t=new s;if(e.senderID!=null&&(t.senderID=String(e.senderID)),e.senderCounter!=null&&(t.senderCounter=e.senderCounter>>>0),e.vcKeys){if(!Array.isArray(e.vcKeys))throw TypeError(".CRDTMessageMetaMessage.vcKeys: array expected");t.vcKeys=[];for(let r=0;r<e.vcKeys.length;++r)t.vcKeys[r]=String(e.vcKeys[r])}if(e.vcValues){if(!Array.isArray(e.vcValues))throw TypeError(".CRDTMessageMetaMessage.vcValues: array expected");t.vcValues=[];for(let r=0;r<e.vcValues.length;++r)t.vcValues[r]=e.vcValues[r]>>>0}if(e.maximalVcKeyCount!=null&&(t.maximalVcKeyCount=e.maximalVcKeyCount>>>0),e.wallClockTime!=null&&($util$1.Long?(t.wallClockTime=$util$1.Long.fromValue(e.wallClockTime)).unsigned=!0:typeof e.wallClockTime=="string"?t.wallClockTime=parseInt(e.wallClockTime,10):typeof e.wallClockTime=="number"?t.wallClockTime=e.wallClockTime:typeof e.wallClockTime=="object"&&(t.wallClockTime=new $util$1.LongBits(e.wallClockTime.low>>>0,e.wallClockTime.high>>>0).toNumber(!0))),e.lamportTimestamp!=null&&($util$1.Long?(t.lamportTimestamp=$util$1.Long.fromValue(e.lamportTimestamp)).unsigned=!0:typeof e.lamportTimestamp=="string"?t.lamportTimestamp=parseInt(e.lamportTimestamp,10):typeof e.lamportTimestamp=="number"?t.lamportTimestamp=e.lamportTimestamp:typeof e.lamportTimestamp=="object"&&(t.lamportTimestamp=new $util$1.LongBits(e.lamportTimestamp.low>>>0,e.lamportTimestamp.high>>>0).toNumber(!0))),e.encodedVcKeys){if(!Array.isArray(e.encodedVcKeys))throw TypeError(".CRDTMessageMetaMessage.encodedVcKeys: array expected");t.encodedVcKeys=[];for(let r=0;r<e.encodedVcKeys.length;++r)t.encodedVcKeys[r]=e.encodedVcKeys[r]>>>0}return t},s.toObject=function(e,t){t||(t={});let r={};if((t.arrays||t.defaults)&&(r.vcKeys=[],r.vcValues=[],r.encodedVcKeys=[]),t.defaults){if(r.senderID="",r.senderCounter=0,r.maximalVcKeyCount=0,$util$1.Long){let l=new $util$1.Long(0,0,!0);r.wallClockTime=t.longs===String?l.toString():t.longs===Number?l.toNumber():l}else r.wallClockTime=t.longs===String?"0":0;if($util$1.Long){let l=new $util$1.Long(0,0,!0);r.lamportTimestamp=t.longs===String?l.toString():t.longs===Number?l.toNumber():l}else r.lamportTimestamp=t.longs===String?"0":0}if(e.senderID!=null&&e.hasOwnProperty("senderID")&&(r.senderID=e.senderID),e.senderCounter!=null&&e.hasOwnProperty("senderCounter")&&(r.senderCounter=e.senderCounter),e.vcKeys&&e.vcKeys.length){r.vcKeys=[];for(let l=0;l<e.vcKeys.length;++l)r.vcKeys[l]=e.vcKeys[l]}if(e.vcValues&&e.vcValues.length){r.vcValues=[];for(let l=0;l<e.vcValues.length;++l)r.vcValues[l]=e.vcValues[l]}if(e.maximalVcKeyCount!=null&&e.hasOwnProperty("maximalVcKeyCount")&&(r.maximalVcKeyCount=e.maximalVcKeyCount),e.wallClockTime!=null&&e.hasOwnProperty("wallClockTime")&&(typeof e.wallClockTime=="number"?r.wallClockTime=t.longs===String?String(e.wallClockTime):e.wallClockTime:r.wallClockTime=t.longs===String?$util$1.Long.prototype.toString.call(e.wallClockTime):t.longs===Number?new $util$1.LongBits(e.wallClockTime.low>>>0,e.wallClockTime.high>>>0).toNumber(!0):e.wallClockTime),e.lamportTimestamp!=null&&e.hasOwnProperty("lamportTimestamp")&&(typeof e.lamportTimestamp=="number"?r.lamportTimestamp=t.longs===String?String(e.lamportTimestamp):e.lamportTimestamp:r.lamportTimestamp=t.longs===String?$util$1.Long.prototype.toString.call(e.lamportTimestamp):t.longs===Number?new $util$1.LongBits(e.lamportTimestamp.low>>>0,e.lamportTimestamp.high>>>0).toNumber(!0):e.lamportTimestamp),e.encodedVcKeys&&e.encodedVcKeys.length){r.encodedVcKeys=[];for(let l=0;l<e.encodedVcKeys.length;++l)r.encodedVcKeys[l]=e.encodedVcKeys[l]}return r},s.prototype.toJSON=function(){return this.constructor.toObject(this,minimal.util.toJSONOptions)},s})(),CausalMessageBufferSave=(()=>{function s(n){if(this.vcKeys=[],this.vcValues=[],this.maximalVcKeys=[],this.bufferMessages=[],n)for(let e=Object.keys(n),t=0;t<e.length;++t)n[e[t]]!=null&&(this[e[t]]=n[e[t]])}return s.prototype.vcKeys=$util$1.emptyArray,s.prototype.vcValues=$util$1.emptyArray,s.prototype.maximalVcKeys=$util$1.emptyArray,s.prototype.lamportTimestamp=$util$1.Long?$util$1.Long.fromBits(0,0,!0):0,s.prototype.bufferMessages=$util$1.emptyArray,s.create=function(e){return new s(e)},s.encode=function(e,t){if(t||(t=$Writer$1.create()),e.vcKeys!=null&&e.vcKeys.length)for(let r=0;r<e.vcKeys.length;++r)t.uint32(10).string(e.vcKeys[r]);if(e.vcValues!=null&&e.vcValues.length){t.uint32(18).fork();for(let r=0;r<e.vcValues.length;++r)t.uint64(e.vcValues[r]);t.ldelim()}if(e.maximalVcKeys!=null&&e.maximalVcKeys.length)for(let r=0;r<e.maximalVcKeys.length;++r)t.uint32(26).string(e.maximalVcKeys[r]);if(t.uint32(32).uint64(e.lamportTimestamp),e.bufferMessages!=null&&e.bufferMessages.length)for(let r=0;r<e.bufferMessages.length;++r)t.uint32(42).bytes(e.bufferMessages[r]);return t},s.encodeDelimited=function(e,t){return this.encode(e,t).ldelim()},s.decode=function(e,t){e instanceof $Reader$1||(e=$Reader$1.create(e));let r=t===void 0?e.len:e.pos+t,l=new s;for(;e.pos<r;){let o=e.uint32();switch(o>>>3){case 1:l.vcKeys&&l.vcKeys.length||(l.vcKeys=[]),l.vcKeys.push(e.string());break;case 2:if(l.vcValues&&l.vcValues.length||(l.vcValues=[]),(o&7)===2){let a=e.uint32()+e.pos;for(;e.pos<a;)l.vcValues.push(e.uint64())}else l.vcValues.push(e.uint64());break;case 3:l.maximalVcKeys&&l.maximalVcKeys.length||(l.maximalVcKeys=[]),l.maximalVcKeys.push(e.string());break;case 4:l.lamportTimestamp=e.uint64();break;case 5:l.bufferMessages&&l.bufferMessages.length||(l.bufferMessages=[]),l.bufferMessages.push(e.bytes());break;default:e.skipType(o&7);break}}if(!l.hasOwnProperty("lamportTimestamp"))throw $util$1.ProtocolError("missing required 'lamportTimestamp'",{instance:l});return l},s.decodeDelimited=function(e){return e instanceof $Reader$1||(e=new $Reader$1(e)),this.decode(e,e.uint32())},s.verify=function(e){if(typeof e!="object"||e===null)return"object expected";if(e.vcKeys!=null&&e.hasOwnProperty("vcKeys")){if(!Array.isArray(e.vcKeys))return"vcKeys: array expected";for(let t=0;t<e.vcKeys.length;++t)if(!$util$1.isString(e.vcKeys[t]))return"vcKeys: string[] expected"}if(e.vcValues!=null&&e.hasOwnProperty("vcValues")){if(!Array.isArray(e.vcValues))return"vcValues: array expected";for(let t=0;t<e.vcValues.length;++t)if(!$util$1.isInteger(e.vcValues[t])&&!(e.vcValues[t]&&$util$1.isInteger(e.vcValues[t].low)&&$util$1.isInteger(e.vcValues[t].high)))return"vcValues: integer|Long[] expected"}if(e.maximalVcKeys!=null&&e.hasOwnProperty("maximalVcKeys")){if(!Array.isArray(e.maximalVcKeys))return"maximalVcKeys: array expected";for(let t=0;t<e.maximalVcKeys.length;++t)if(!$util$1.isString(e.maximalVcKeys[t]))return"maximalVcKeys: string[] expected"}if(!$util$1.isInteger(e.lamportTimestamp)&&!(e.lamportTimestamp&&$util$1.isInteger(e.lamportTimestamp.low)&&$util$1.isInteger(e.lamportTimestamp.high)))return"lamportTimestamp: integer|Long expected";if(e.bufferMessages!=null&&e.hasOwnProperty("bufferMessages")){if(!Array.isArray(e.bufferMessages))return"bufferMessages: array expected";for(let t=0;t<e.bufferMessages.length;++t)if(!(e.bufferMessages[t]&&typeof e.bufferMessages[t].length=="number"||$util$1.isString(e.bufferMessages[t])))return"bufferMessages: buffer[] expected"}return null},s.fromObject=function(e){if(e instanceof s)return e;let t=new s;if(e.vcKeys){if(!Array.isArray(e.vcKeys))throw TypeError(".CausalMessageBufferSave.vcKeys: array expected");t.vcKeys=[];for(let r=0;r<e.vcKeys.length;++r)t.vcKeys[r]=String(e.vcKeys[r])}if(e.vcValues){if(!Array.isArray(e.vcValues))throw TypeError(".CausalMessageBufferSave.vcValues: array expected");t.vcValues=[];for(let r=0;r<e.vcValues.length;++r)$util$1.Long?(t.vcValues[r]=$util$1.Long.fromValue(e.vcValues[r])).unsigned=!0:typeof e.vcValues[r]=="string"?t.vcValues[r]=parseInt(e.vcValues[r],10):typeof e.vcValues[r]=="number"?t.vcValues[r]=e.vcValues[r]:typeof e.vcValues[r]=="object"&&(t.vcValues[r]=new $util$1.LongBits(e.vcValues[r].low>>>0,e.vcValues[r].high>>>0).toNumber(!0))}if(e.maximalVcKeys){if(!Array.isArray(e.maximalVcKeys))throw TypeError(".CausalMessageBufferSave.maximalVcKeys: array expected");t.maximalVcKeys=[];for(let r=0;r<e.maximalVcKeys.length;++r)t.maximalVcKeys[r]=String(e.maximalVcKeys[r])}if(e.lamportTimestamp!=null&&($util$1.Long?(t.lamportTimestamp=$util$1.Long.fromValue(e.lamportTimestamp)).unsigned=!0:typeof e.lamportTimestamp=="string"?t.lamportTimestamp=parseInt(e.lamportTimestamp,10):typeof e.lamportTimestamp=="number"?t.lamportTimestamp=e.lamportTimestamp:typeof e.lamportTimestamp=="object"&&(t.lamportTimestamp=new $util$1.LongBits(e.lamportTimestamp.low>>>0,e.lamportTimestamp.high>>>0).toNumber(!0))),e.bufferMessages){if(!Array.isArray(e.bufferMessages))throw TypeError(".CausalMessageBufferSave.bufferMessages: array expected");t.bufferMessages=[];for(let r=0;r<e.bufferMessages.length;++r)typeof e.bufferMessages[r]=="string"?$util$1.base64.decode(e.bufferMessages[r],t.bufferMessages[r]=$util$1.newBuffer($util$1.base64.length(e.bufferMessages[r])),0):e.bufferMessages[r].length&&(t.bufferMessages[r]=e.bufferMessages[r])}return t},s.toObject=function(e,t){t||(t={});let r={};if((t.arrays||t.defaults)&&(r.vcKeys=[],r.vcValues=[],r.maximalVcKeys=[],r.bufferMessages=[]),t.defaults)if($util$1.Long){let l=new $util$1.Long(0,0,!0);r.lamportTimestamp=t.longs===String?l.toString():t.longs===Number?l.toNumber():l}else r.lamportTimestamp=t.longs===String?"0":0;if(e.vcKeys&&e.vcKeys.length){r.vcKeys=[];for(let l=0;l<e.vcKeys.length;++l)r.vcKeys[l]=e.vcKeys[l]}if(e.vcValues&&e.vcValues.length){r.vcValues=[];for(let l=0;l<e.vcValues.length;++l)typeof e.vcValues[l]=="number"?r.vcValues[l]=t.longs===String?String(e.vcValues[l]):e.vcValues[l]:r.vcValues[l]=t.longs===String?$util$1.Long.prototype.toString.call(e.vcValues[l]):t.longs===Number?new $util$1.LongBits(e.vcValues[l].low>>>0,e.vcValues[l].high>>>0).toNumber(!0):e.vcValues[l]}if(e.maximalVcKeys&&e.maximalVcKeys.length){r.maximalVcKeys=[];for(let l=0;l<e.maximalVcKeys.length;++l)r.maximalVcKeys[l]=e.maximalVcKeys[l]}if(e.lamportTimestamp!=null&&e.hasOwnProperty("lamportTimestamp")&&(typeof e.lamportTimestamp=="number"?r.lamportTimestamp=t.longs===String?String(e.lamportTimestamp):e.lamportTimestamp:r.lamportTimestamp=t.longs===String?$util$1.Long.prototype.toString.call(e.lamportTimestamp):t.longs===Number?new $util$1.LongBits(e.lamportTimestamp.low>>>0,e.lamportTimestamp.high>>>0).toNumber(!0):e.lamportTimestamp),e.bufferMessages&&e.bufferMessages.length){r.bufferMessages=[];for(let l=0;l<e.bufferMessages.length;++l)r.bufferMessages[l]=t.bytes===String?$util$1.base64.encode(e.bufferMessages[l],0,e.bufferMessages[l].length):t.bytes===Array?Array.prototype.slice.call(e.bufferMessages[l]):e.bufferMessages[l]}return r},s.prototype.toJSON=function(){return this.constructor.toObject(this,minimal.util.toJSONOptions)},s})(),CounterMessage=(()=>{function s(n){if(n)for(let e=Object.keys(n),t=0;t<e.length;++t)n[e[t]]!=null&&(this[e[t]]=n[e[t]])}return s.prototype.arg=$util$1.Long?$util$1.Long.fromBits(1,0,!1):1,s.create=function(e){return new s(e)},s.encode=function(e,t){return t||(t=$Writer$1.create()),e.arg!=null&&Object.hasOwnProperty.call(e,"arg")&&t.uint32(8).sint64(e.arg),t},s.encodeDelimited=function(e,t){return this.encode(e,t).ldelim()},s.decode=function(e,t){e instanceof $Reader$1||(e=$Reader$1.create(e));let r=t===void 0?e.len:e.pos+t,l=new s;for(;e.pos<r;){let o=e.uint32();switch(o>>>3){case 1:l.arg=e.sint64();break;default:e.skipType(o&7);break}}return l},s.decodeDelimited=function(e){return e instanceof $Reader$1||(e=new $Reader$1(e)),this.decode(e,e.uint32())},s.verify=function(e){return typeof e!="object"||e===null?"object expected":e.arg!=null&&e.hasOwnProperty("arg")&&!$util$1.isInteger(e.arg)&&!(e.arg&&$util$1.isInteger(e.arg.low)&&$util$1.isInteger(e.arg.high))?"arg: integer|Long expected":null},s.fromObject=function(e){if(e instanceof s)return e;let t=new s;return e.arg!=null&&($util$1.Long?(t.arg=$util$1.Long.fromValue(e.arg)).unsigned=!1:typeof e.arg=="string"?t.arg=parseInt(e.arg,10):typeof e.arg=="number"?t.arg=e.arg:typeof e.arg=="object"&&(t.arg=new $util$1.LongBits(e.arg.low>>>0,e.arg.high>>>0).toNumber())),t},s.toObject=function(e,t){t||(t={});let r={};if(t.defaults)if($util$1.Long){let l=new $util$1.Long(1,0,!1);r.arg=t.longs===String?l.toString():t.longs===Number?l.toNumber():l}else r.arg=t.longs===String?"1":1;return e.arg!=null&&e.hasOwnProperty("arg")&&(typeof e.arg=="number"?r.arg=t.longs===String?String(e.arg):e.arg:r.arg=t.longs===String?$util$1.Long.prototype.toString.call(e.arg):t.longs===Number?new $util$1.LongBits(e.arg.low>>>0,e.arg.high>>>0).toNumber():e.arg),r},s.prototype.toJSON=function(){return this.constructor.toObject(this,minimal.util.toJSONOptions)},s})(),CounterSave=(()=>{function s(n){if(this.p={},this.n={},n)for(let e=Object.keys(n),t=0;t<e.length;++t)n[e[t]]!=null&&(this[e[t]]=n[e[t]])}return s.prototype.p=$util$1.emptyObject,s.prototype.n=$util$1.emptyObject,s.create=function(e){return new s(e)},s.encode=function(e,t){if(t||(t=$Writer$1.create()),e.p!=null&&Object.hasOwnProperty.call(e,"p"))for(let r=Object.keys(e.p),l=0;l<r.length;++l)t.uint32(10).fork().uint32(10).string(r[l]).uint32(16).uint64(e.p[r[l]]).ldelim();if(e.n!=null&&Object.hasOwnProperty.call(e,"n"))for(let r=Object.keys(e.n),l=0;l<r.length;++l)t.uint32(18).fork().uint32(10).string(r[l]).uint32(16).uint64(e.n[r[l]]).ldelim();return t},s.encodeDelimited=function(e,t){return this.encode(e,t).ldelim()},s.decode=function(e,t){e instanceof $Reader$1||(e=$Reader$1.create(e));let r=t===void 0?e.len:e.pos+t,l=new s,o;for(;e.pos<r;){let a=e.uint32();switch(a>>>3){case 1:e.skip().pos++,l.p===$util$1.emptyObject&&(l.p={}),o=e.string(),e.pos++,l.p[o]=e.uint64();break;case 2:e.skip().pos++,l.n===$util$1.emptyObject&&(l.n={}),o=e.string(),e.pos++,l.n[o]=e.uint64();break;default:e.skipType(a&7);break}}return l},s.decodeDelimited=function(e){return e instanceof $Reader$1||(e=new $Reader$1(e)),this.decode(e,e.uint32())},s.verify=function(e){if(typeof e!="object"||e===null)return"object expected";if(e.p!=null&&e.hasOwnProperty("p")){if(!$util$1.isObject(e.p))return"p: object expected";let t=Object.keys(e.p);for(let r=0;r<t.length;++r)if(!$util$1.isInteger(e.p[t[r]])&&!(e.p[t[r]]&&$util$1.isInteger(e.p[t[r]].low)&&$util$1.isInteger(e.p[t[r]].high)))return"p: integer|Long{k:string} expected"}if(e.n!=null&&e.hasOwnProperty("n")){if(!$util$1.isObject(e.n))return"n: object expected";let t=Object.keys(e.n);for(let r=0;r<t.length;++r)if(!$util$1.isInteger(e.n[t[r]])&&!(e.n[t[r]]&&$util$1.isInteger(e.n[t[r]].low)&&$util$1.isInteger(e.n[t[r]].high)))return"n: integer|Long{k:string} expected"}return null},s.fromObject=function(e){if(e instanceof s)return e;let t=new s;if(e.p){if(typeof e.p!="object")throw TypeError(".CounterSave.p: object expected");t.p={};for(let r=Object.keys(e.p),l=0;l<r.length;++l)$util$1.Long?(t.p[r[l]]=$util$1.Long.fromValue(e.p[r[l]])).unsigned=!0:typeof e.p[r[l]]=="string"?t.p[r[l]]=parseInt(e.p[r[l]],10):typeof e.p[r[l]]=="number"?t.p[r[l]]=e.p[r[l]]:typeof e.p[r[l]]=="object"&&(t.p[r[l]]=new $util$1.LongBits(e.p[r[l]].low>>>0,e.p[r[l]].high>>>0).toNumber(!0))}if(e.n){if(typeof e.n!="object")throw TypeError(".CounterSave.n: object expected");t.n={};for(let r=Object.keys(e.n),l=0;l<r.length;++l)$util$1.Long?(t.n[r[l]]=$util$1.Long.fromValue(e.n[r[l]])).unsigned=!0:typeof e.n[r[l]]=="string"?t.n[r[l]]=parseInt(e.n[r[l]],10):typeof e.n[r[l]]=="number"?t.n[r[l]]=e.n[r[l]]:typeof e.n[r[l]]=="object"&&(t.n[r[l]]=new $util$1.LongBits(e.n[r[l]].low>>>0,e.n[r[l]].high>>>0).toNumber(!0))}return t},s.toObject=function(e,t){t||(t={});let r={};(t.objects||t.defaults)&&(r.p={},r.n={});let l;if(e.p&&(l=Object.keys(e.p)).length){r.p={};for(let o=0;o<l.length;++o)typeof e.p[l[o]]=="number"?r.p[l[o]]=t.longs===String?String(e.p[l[o]]):e.p[l[o]]:r.p[l[o]]=t.longs===String?$util$1.Long.prototype.toString.call(e.p[l[o]]):t.longs===Number?new $util$1.LongBits(e.p[l[o]].low>>>0,e.p[l[o]].high>>>0).toNumber(!0):e.p[l[o]]}if(e.n&&(l=Object.keys(e.n)).length){r.n={};for(let o=0;o<l.length;++o)typeof e.n[l[o]]=="number"?r.n[l[o]]=t.longs===String?String(e.n[l[o]]):e.n[l[o]]:r.n[l[o]]=t.longs===String?$util$1.Long.prototype.toString.call(e.n[l[o]]):t.longs===Number?new $util$1.LongBits(e.n[l[o]].low>>>0,e.n[l[o]].high>>>0).toNumber(!0):e.n[l[o]]}return r},s.prototype.toJSON=function(){return this.constructor.toObject(this,minimal.util.toJSONOptions)},s})(),PresenceSetMessage=(()=>{function s(n){if(n)for(let e=Object.keys(n),t=0;t<e.length;++t)n[e[t]]!=null&&(this[e[t]]=n[e[t]])}return s.prototype.value=$util$1.newBuffer([]),s.prototype.isJoin=!1,s.prototype.isResponse=!1,s.create=function(e){return new s(e)},s.encode=function(e,t){return t||(t=$Writer$1.create()),t.uint32(10).bytes(e.value),e.isJoin!=null&&Object.hasOwnProperty.call(e,"isJoin")&&t.uint32(16).bool(e.isJoin),e.isResponse!=null&&Object.hasOwnProperty.call(e,"isResponse")&&t.uint32(24).bool(e.isResponse),t},s.encodeDelimited=function(e,t){return this.encode(e,t).ldelim()},s.decode=function(e,t){e instanceof $Reader$1||(e=$Reader$1.create(e));let r=t===void 0?e.len:e.pos+t,l=new s;for(;e.pos<r;){let o=e.uint32();switch(o>>>3){case 1:l.value=e.bytes();break;case 2:l.isJoin=e.bool();break;case 3:l.isResponse=e.bool();break;default:e.skipType(o&7);break}}if(!l.hasOwnProperty("value"))throw $util$1.ProtocolError("missing required 'value'",{instance:l});return l},s.decodeDelimited=function(e){return e instanceof $Reader$1||(e=new $Reader$1(e)),this.decode(e,e.uint32())},s.verify=function(e){return typeof e!="object"||e===null?"object expected":e.value&&typeof e.value.length=="number"||$util$1.isString(e.value)?e.isJoin!=null&&e.hasOwnProperty("isJoin")&&typeof e.isJoin!="boolean"?"isJoin: boolean expected":e.isResponse!=null&&e.hasOwnProperty("isResponse")&&typeof e.isResponse!="boolean"?"isResponse: boolean expected":null:"value: buffer expected"},s.fromObject=function(e){if(e instanceof s)return e;let t=new s;return e.value!=null&&(typeof e.value=="string"?$util$1.base64.decode(e.value,t.value=$util$1.newBuffer($util$1.base64.length(e.value)),0):e.value.length&&(t.value=e.value)),e.isJoin!=null&&(t.isJoin=!!e.isJoin),e.isResponse!=null&&(t.isResponse=!!e.isResponse),t},s.toObject=function(e,t){t||(t={});let r={};return t.defaults&&(t.bytes===String?r.value="":(r.value=[],t.bytes!==Array&&(r.value=$util$1.newBuffer(r.value))),r.isJoin=!1,r.isResponse=!1),e.value!=null&&e.hasOwnProperty("value")&&(r.value=t.bytes===String?$util$1.base64.encode(e.value,0,e.value.length):t.bytes===Array?Array.prototype.slice.call(e.value):e.value),e.isJoin!=null&&e.hasOwnProperty("isJoin")&&(r.isJoin=e.isJoin),e.isResponse!=null&&e.hasOwnProperty("isResponse")&&(r.isResponse=e.isResponse),r},s.prototype.toJSON=function(){return this.constructor.toObject(this,minimal.util.toJSONOptions)},s})(),PresenceMessage=(()=>{function s(e){if(e)for(let t=Object.keys(e),r=0;r<t.length;++r)e[t[r]]!=null&&(this[t[r]]=e[t[r]])}s.prototype.heartbeat=!1,s.prototype.set=null,s.prototype.update=$util$1.newBuffer([]),s.prototype.disconnect=!1,s.prototype.request="";let n;return Object.defineProperty(s.prototype,"type",{get:$util$1.oneOfGetter(n=["heartbeat","set","update","disconnect","request"]),set:$util$1.oneOfSetter(n)}),s.create=function(t){return new s(t)},s.encode=function(t,r){return r||(r=$Writer$1.create()),t.heartbeat!=null&&Object.hasOwnProperty.call(t,"heartbeat")&&r.uint32(8).bool(t.heartbeat),t.set!=null&&Object.hasOwnProperty.call(t,"set")&&PresenceSetMessage.encode(t.set,r.uint32(18).fork()).ldelim(),t.update!=null&&Object.hasOwnProperty.call(t,"update")&&r.uint32(26).bytes(t.update),t.disconnect!=null&&Object.hasOwnProperty.call(t,"disconnect")&&r.uint32(32).bool(t.disconnect),t.request!=null&&Object.hasOwnProperty.call(t,"request")&&r.uint32(42).string(t.request),r},s.encodeDelimited=function(t,r){return this.encode(t,r).ldelim()},s.decode=function(t,r){t instanceof $Reader$1||(t=$Reader$1.create(t));let l=r===void 0?t.len:t.pos+r,o=new s;for(;t.pos<l;){let a=t.uint32();switch(a>>>3){case 1:o.heartbeat=t.bool();break;case 2:o.set=PresenceSetMessage.decode(t,t.uint32());break;case 3:o.update=t.bytes();break;case 4:o.disconnect=t.bool();break;case 5:o.request=t.string();break;default:t.skipType(a&7);break}}return o},s.decodeDelimited=function(t){return t instanceof $Reader$1||(t=new $Reader$1(t)),this.decode(t,t.uint32())},s.verify=function(t){if(typeof t!="object"||t===null)return"object expected";let r={};if(t.heartbeat!=null&&t.hasOwnProperty("heartbeat")&&(r.type=1,typeof t.heartbeat!="boolean"))return"heartbeat: boolean expected";if(t.set!=null&&t.hasOwnProperty("set")){if(r.type===1)return"type: multiple values";r.type=1;{let l=PresenceSetMessage.verify(t.set);if(l)return"set."+l}}if(t.update!=null&&t.hasOwnProperty("update")){if(r.type===1)return"type: multiple values";if(r.type=1,!(t.update&&typeof t.update.length=="number"||$util$1.isString(t.update)))return"update: buffer expected"}if(t.disconnect!=null&&t.hasOwnProperty("disconnect")){if(r.type===1)return"type: multiple values";if(r.type=1,typeof t.disconnect!="boolean")return"disconnect: boolean expected"}if(t.request!=null&&t.hasOwnProperty("request")){if(r.type===1)return"type: multiple values";if(r.type=1,!$util$1.isString(t.request))return"request: string expected"}return null},s.fromObject=function(t){if(t instanceof s)return t;let r=new s;if(t.heartbeat!=null&&(r.heartbeat=!!t.heartbeat),t.set!=null){if(typeof t.set!="object")throw TypeError(".PresenceMessage.set: object expected");r.set=PresenceSetMessage.fromObject(t.set)}return t.update!=null&&(typeof t.update=="string"?$util$1.base64.decode(t.update,r.update=$util$1.newBuffer($util$1.base64.length(t.update)),0):t.update.length&&(r.update=t.update)),t.disconnect!=null&&(r.disconnect=!!t.disconnect),t.request!=null&&(r.request=String(t.request)),r},s.toObject=function(t,r){r||(r={});let l={};return t.heartbeat!=null&&t.hasOwnProperty("heartbeat")&&(l.heartbeat=t.heartbeat,r.oneofs&&(l.type="heartbeat")),t.set!=null&&t.hasOwnProperty("set")&&(l.set=PresenceSetMessage.toObject(t.set,r),r.oneofs&&(l.type="set")),t.update!=null&&t.hasOwnProperty("update")&&(l.update=r.bytes===String?$util$1.base64.encode(t.update,0,t.update.length):r.bytes===Array?Array.prototype.slice.call(t.update):t.update,r.oneofs&&(l.type="update")),t.disconnect!=null&&t.hasOwnProperty("disconnect")&&(l.disconnect=t.disconnect,r.oneofs&&(l.type="disconnect")),t.request!=null&&t.hasOwnProperty("request")&&(l.request=t.request,r.oneofs&&(l.type="request")),l},s.prototype.toJSON=function(){return this.constructor.toObject(this,minimal.util.toJSONOptions)},s})(),PresenceInfoSave=(()=>{function s(n){if(n)for(let e=Object.keys(n),t=0;t<e.length;++t)n[e[t]]!=null&&(this[e[t]]=n[e[t]])}return s.prototype.value=$util$1.newBuffer([]),s.prototype.time=$util$1.Long?$util$1.Long.fromBits(0,0,!0):0,s.create=function(e){return new s(e)},s.encode=function(e,t){return t||(t=$Writer$1.create()),t.uint32(10).bytes(e.value),t.uint32(16).uint64(e.time),t},s.encodeDelimited=function(e,t){return this.encode(e,t).ldelim()},s.decode=function(e,t){e instanceof $Reader$1||(e=$Reader$1.create(e));let r=t===void 0?e.len:e.pos+t,l=new s;for(;e.pos<r;){let o=e.uint32();switch(o>>>3){case 1:l.value=e.bytes();break;case 2:l.time=e.uint64();break;default:e.skipType(o&7);break}}if(!l.hasOwnProperty("value"))throw $util$1.ProtocolError("missing required 'value'",{instance:l});if(!l.hasOwnProperty("time"))throw $util$1.ProtocolError("missing required 'time'",{instance:l});return l},s.decodeDelimited=function(e){return e instanceof $Reader$1||(e=new $Reader$1(e)),this.decode(e,e.uint32())},s.verify=function(e){return typeof e!="object"||e===null?"object expected":e.value&&typeof e.value.length=="number"||$util$1.isString(e.value)?!$util$1.isInteger(e.time)&&!(e.time&&$util$1.isInteger(e.time.low)&&$util$1.isInteger(e.time.high))?"time: integer|Long expected":null:"value: buffer expected"},s.fromObject=function(e){if(e instanceof s)return e;let t=new s;return e.value!=null&&(typeof e.value=="string"?$util$1.base64.decode(e.value,t.value=$util$1.newBuffer($util$1.base64.length(e.value)),0):e.value.length&&(t.value=e.value)),e.time!=null&&($util$1.Long?(t.time=$util$1.Long.fromValue(e.time)).unsigned=!0:typeof e.time=="string"?t.time=parseInt(e.time,10):typeof e.time=="number"?t.time=e.time:typeof e.time=="object"&&(t.time=new $util$1.LongBits(e.time.low>>>0,e.time.high>>>0).toNumber(!0))),t},s.toObject=function(e,t){t||(t={});let r={};if(t.defaults)if(t.bytes===String?r.value="":(r.value=[],t.bytes!==Array&&(r.value=$util$1.newBuffer(r.value))),$util$1.Long){let l=new $util$1.Long(0,0,!0);r.time=t.longs===String?l.toString():t.longs===Number?l.toNumber():l}else r.time=t.longs===String?"0":0;return e.value!=null&&e.hasOwnProperty("value")&&(r.value=t.bytes===String?$util$1.base64.encode(e.value,0,e.value.length):t.bytes===Array?Array.prototype.slice.call(e.value):e.value),e.time!=null&&e.hasOwnProperty("time")&&(typeof e.time=="number"?r.time=t.longs===String?String(e.time):e.time:r.time=t.longs===String?$util$1.Long.prototype.toString.call(e.time):t.longs===Number?new $util$1.LongBits(e.time.low>>>0,e.time.high>>>0).toNumber(!0):e.time),r},s.prototype.toJSON=function(){return this.constructor.toObject(this,minimal.util.toJSONOptions)},s})(),PresenceSave=(()=>{function s(n){if(this.state={},n)for(let e=Object.keys(n),t=0;t<e.length;++t)n[e[t]]!=null&&(this[e[t]]=n[e[t]])}return s.prototype.state=$util$1.emptyObject,s.prototype.saverID="",s.create=function(e){return new s(e)},s.encode=function(e,t){if(t||(t=$Writer$1.create()),e.state!=null&&Object.hasOwnProperty.call(e,"state"))for(let r=Object.keys(e.state),l=0;l<r.length;++l)t.uint32(10).fork().uint32(10).string(r[l]),PresenceInfoSave.encode(e.state[r[l]],t.uint32(18).fork()).ldelim().ldelim();return t.uint32(18).string(e.saverID),t},s.encodeDelimited=function(e,t){return this.encode(e,t).ldelim()},s.decode=function(e,t){e instanceof $Reader$1||(e=$Reader$1.create(e));let r=t===void 0?e.len:e.pos+t,l=new s,o;for(;e.pos<r;){let a=e.uint32();switch(a>>>3){case 1:e.skip().pos++,l.state===$util$1.emptyObject&&(l.state={}),o=e.string(),e.pos++,l.state[o]=PresenceInfoSave.decode(e,e.uint32());break;case 2:l.saverID=e.string();break;default:e.skipType(a&7);break}}if(!l.hasOwnProperty("saverID"))throw $util$1.ProtocolError("missing required 'saverID'",{instance:l});return l},s.decodeDelimited=function(e){return e instanceof $Reader$1||(e=new $Reader$1(e)),this.decode(e,e.uint32())},s.verify=function(e){if(typeof e!="object"||e===null)return"object expected";if(e.state!=null&&e.hasOwnProperty("state")){if(!$util$1.isObject(e.state))return"state: object expected";let t=Object.keys(e.state);for(let r=0;r<t.length;++r){let l=PresenceInfoSave.verify(e.state[t[r]]);if(l)return"state."+l}}return $util$1.isString(e.saverID)?null:"saverID: string expected"},s.fromObject=function(e){if(e instanceof s)return e;let t=new s;if(e.state){if(typeof e.state!="object")throw TypeError(".PresenceSave.state: object expected");t.state={};for(let r=Object.keys(e.state),l=0;l<r.length;++l){if(typeof e.state[r[l]]!="object")throw TypeError(".PresenceSave.state: object expected");t.state[r[l]]=PresenceInfoSave.fromObject(e.state[r[l]])}}return e.saverID!=null&&(t.saverID=String(e.saverID)),t},s.toObject=function(e,t){t||(t={});let r={};(t.objects||t.defaults)&&(r.state={}),t.defaults&&(r.saverID="");let l;if(e.state&&(l=Object.keys(e.state)).length){r.state={};for(let o=0;o<l.length;++o)r.state[l[o]]=PresenceInfoSave.toObject(e.state[l[o]],t)}return e.saverID!=null&&e.hasOwnProperty("saverID")&&(r.saverID=e.saverID),r},s.prototype.toJSON=function(){return this.constructor.toObject(this,minimal.util.toJSONOptions)},s})(),MultiValueMapMessage=(()=>{function s(n){if(n)for(let e=Object.keys(n),t=0;t<e.length;++t)n[e[t]]!=null&&(this[e[t]]=n[e[t]])}return s.prototype.key=$util$1.newBuffer([]),s.prototype.value=$util$1.newBuffer([]),s.create=function(e){return new s(e)},s.encode=function(e,t){return t||(t=$Writer$1.create()),t.uint32(10).bytes(e.key),e.value!=null&&Object.hasOwnProperty.call(e,"value")&&t.uint32(18).bytes(e.value),t},s.encodeDelimited=function(e,t){return this.encode(e,t).ldelim()},s.decode=function(e,t){e instanceof $Reader$1||(e=$Reader$1.create(e));let r=t===void 0?e.len:e.pos+t,l=new s;for(;e.pos<r;){let o=e.uint32();switch(o>>>3){case 1:l.key=e.bytes();break;case 2:l.value=e.bytes();break;default:e.skipType(o&7);break}}if(!l.hasOwnProperty("key"))throw $util$1.ProtocolError("missing required 'key'",{instance:l});return l},s.decodeDelimited=function(e){return e instanceof $Reader$1||(e=new $Reader$1(e)),this.decode(e,e.uint32())},s.verify=function(e){return typeof e!="object"||e===null?"object expected":e.key&&typeof e.key.length=="number"||$util$1.isString(e.key)?e.value!=null&&e.hasOwnProperty("value")&&!(e.value&&typeof e.value.length=="number"||$util$1.isString(e.value))?"value: buffer expected":null:"key: buffer expected"},s.fromObject=function(e){if(e instanceof s)return e;let t=new s;return e.key!=null&&(typeof e.key=="string"?$util$1.base64.decode(e.key,t.key=$util$1.newBuffer($util$1.base64.length(e.key)),0):e.key.length&&(t.key=e.key)),e.value!=null&&(typeof e.value=="string"?$util$1.base64.decode(e.value,t.value=$util$1.newBuffer($util$1.base64.length(e.value)),0):e.value.length&&(t.value=e.value)),t},s.toObject=function(e,t){t||(t={});let r={};return t.defaults&&(t.bytes===String?r.key="":(r.key=[],t.bytes!==Array&&(r.key=$util$1.newBuffer(r.key))),t.bytes===String?r.value="":(r.value=[],t.bytes!==Array&&(r.value=$util$1.newBuffer(r.value)))),e.key!=null&&e.hasOwnProperty("key")&&(r.key=t.bytes===String?$util$1.base64.encode(e.key,0,e.key.length):t.bytes===Array?Array.prototype.slice.call(e.key):e.key),e.value!=null&&e.hasOwnProperty("value")&&(r.value=t.bytes===String?$util$1.base64.encode(e.value,0,e.value.length):t.bytes===Array?Array.prototype.slice.call(e.value):e.value),r},s.prototype.toJSON=function(){return this.constructor.toObject(this,minimal.util.toJSONOptions)},s})(),MultiValueMapItemsSave=(()=>{function s(n){if(this.values=[],this.senders=[],this.senderCounters=[],this.wallClockTimes=[],this.lamportTimestamps=[],n)for(let e=Object.keys(n),t=0;t<e.length;++t)n[e[t]]!=null&&(this[e[t]]=n[e[t]])}return s.prototype.values=$util$1.emptyArray,s.prototype.senders=$util$1.emptyArray,s.prototype.senderCounters=$util$1.emptyArray,s.prototype.wallClockTimes=$util$1.emptyArray,s.prototype.lamportTimestamps=$util$1.emptyArray,s.create=function(e){return new s(e)},s.encode=function(e,t){if(t||(t=$Writer$1.create()),e.values!=null&&e.values.length)for(let r=0;r<e.values.length;++r)t.uint32(10).bytes(e.values[r]);if(e.senders!=null&&e.senders.length){t.uint32(18).fork();for(let r=0;r<e.senders.length;++r)t.uint32(e.senders[r]);t.ldelim()}if(e.senderCounters!=null&&e.senderCounters.length){t.uint32(26).fork();for(let r=0;r<e.senderCounters.length;++r)t.uint32(e.senderCounters[r]);t.ldelim()}if(e.wallClockTimes!=null&&e.wallClockTimes.length){t.uint32(34).fork();for(let r=0;r<e.wallClockTimes.length;++r)t.uint64(e.wallClockTimes[r]);t.ldelim()}if(e.lamportTimestamps!=null&&e.lamportTimestamps.length){t.uint32(42).fork();for(let r=0;r<e.lamportTimestamps.length;++r)t.uint64(e.lamportTimestamps[r]);t.ldelim()}return t},s.encodeDelimited=function(e,t){return this.encode(e,t).ldelim()},s.decode=function(e,t){e instanceof $Reader$1||(e=$Reader$1.create(e));let r=t===void 0?e.len:e.pos+t,l=new s;for(;e.pos<r;){let o=e.uint32();switch(o>>>3){case 1:l.values&&l.values.length||(l.values=[]),l.values.push(e.bytes());break;case 2:if(l.senders&&l.senders.length||(l.senders=[]),(o&7)===2){let a=e.uint32()+e.pos;for(;e.pos<a;)l.senders.push(e.uint32())}else l.senders.push(e.uint32());break;case 3:if(l.senderCounters&&l.senderCounters.length||(l.senderCounters=[]),(o&7)===2){let a=e.uint32()+e.pos;for(;e.pos<a;)l.senderCounters.push(e.uint32())}else l.senderCounters.push(e.uint32());break;case 4:if(l.wallClockTimes&&l.wallClockTimes.length||(l.wallClockTimes=[]),(o&7)===2){let a=e.uint32()+e.pos;for(;e.pos<a;)l.wallClockTimes.push(e.uint64())}else l.wallClockTimes.push(e.uint64());break;case 5:if(l.lamportTimestamps&&l.lamportTimestamps.length||(l.lamportTimestamps=[]),(o&7)===2){let a=e.uint32()+e.pos;for(;e.pos<a;)l.lamportTimestamps.push(e.uint64())}else l.lamportTimestamps.push(e.uint64());break;default:e.skipType(o&7);break}}return l},s.decodeDelimited=function(e){return e instanceof $Reader$1||(e=new $Reader$1(e)),this.decode(e,e.uint32())},s.verify=function(e){if(typeof e!="object"||e===null)return"object expected";if(e.values!=null&&e.hasOwnProperty("values")){if(!Array.isArray(e.values))return"values: array expected";for(let t=0;t<e.values.length;++t)if(!(e.values[t]&&typeof e.values[t].length=="number"||$util$1.isString(e.values[t])))return"values: buffer[] expected"}if(e.senders!=null&&e.hasOwnProperty("senders")){if(!Array.isArray(e.senders))return"senders: array expected";for(let t=0;t<e.senders.length;++t)if(!$util$1.isInteger(e.senders[t]))return"senders: integer[] expected"}if(e.senderCounters!=null&&e.hasOwnProperty("senderCounters")){if(!Array.isArray(e.senderCounters))return"senderCounters: array expected";for(let t=0;t<e.senderCounters.length;++t)if(!$util$1.isInteger(e.senderCounters[t]))return"senderCounters: integer[] expected"}if(e.wallClockTimes!=null&&e.hasOwnProperty("wallClockTimes")){if(!Array.isArray(e.wallClockTimes))return"wallClockTimes: array expected";for(let t=0;t<e.wallClockTimes.length;++t)if(!$util$1.isInteger(e.wallClockTimes[t])&&!(e.wallClockTimes[t]&&$util$1.isInteger(e.wallClockTimes[t].low)&&$util$1.isInteger(e.wallClockTimes[t].high)))return"wallClockTimes: integer|Long[] expected"}if(e.lamportTimestamps!=null&&e.hasOwnProperty("lamportTimestamps")){if(!Array.isArray(e.lamportTimestamps))return"lamportTimestamps: array expected";for(let t=0;t<e.lamportTimestamps.length;++t)if(!$util$1.isInteger(e.lamportTimestamps[t])&&!(e.lamportTimestamps[t]&&$util$1.isInteger(e.lamportTimestamps[t].low)&&$util$1.isInteger(e.lamportTimestamps[t].high)))return"lamportTimestamps: integer|Long[] expected"}return null},s.fromObject=function(e){if(e instanceof s)return e;let t=new s;if(e.values){if(!Array.isArray(e.values))throw TypeError(".MultiValueMapItemsSave.values: array expected");t.values=[];for(let r=0;r<e.values.length;++r)typeof e.values[r]=="string"?$util$1.base64.decode(e.values[r],t.values[r]=$util$1.newBuffer($util$1.base64.length(e.values[r])),0):e.values[r].length&&(t.values[r]=e.values[r])}if(e.senders){if(!Array.isArray(e.senders))throw TypeError(".MultiValueMapItemsSave.senders: array expected");t.senders=[];for(let r=0;r<e.senders.length;++r)t.senders[r]=e.senders[r]>>>0}if(e.senderCounters){if(!Array.isArray(e.senderCounters))throw TypeError(".MultiValueMapItemsSave.senderCounters: array expected");t.senderCounters=[];for(let r=0;r<e.senderCounters.length;++r)t.senderCounters[r]=e.senderCounters[r]>>>0}if(e.wallClockTimes){if(!Array.isArray(e.wallClockTimes))throw TypeError(".MultiValueMapItemsSave.wallClockTimes: array expected");t.wallClockTimes=[];for(let r=0;r<e.wallClockTimes.length;++r)$util$1.Long?(t.wallClockTimes[r]=$util$1.Long.fromValue(e.wallClockTimes[r])).unsigned=!0:typeof e.wallClockTimes[r]=="string"?t.wallClockTimes[r]=parseInt(e.wallClockTimes[r],10):typeof e.wallClockTimes[r]=="number"?t.wallClockTimes[r]=e.wallClockTimes[r]:typeof e.wallClockTimes[r]=="object"&&(t.wallClockTimes[r]=new $util$1.LongBits(e.wallClockTimes[r].low>>>0,e.wallClockTimes[r].high>>>0).toNumber(!0))}if(e.lamportTimestamps){if(!Array.isArray(e.lamportTimestamps))throw TypeError(".MultiValueMapItemsSave.lamportTimestamps: array expected");t.lamportTimestamps=[];for(let r=0;r<e.lamportTimestamps.length;++r)$util$1.Long?(t.lamportTimestamps[r]=$util$1.Long.fromValue(e.lamportTimestamps[r])).unsigned=!0:typeof e.lamportTimestamps[r]=="string"?t.lamportTimestamps[r]=parseInt(e.lamportTimestamps[r],10):typeof e.lamportTimestamps[r]=="number"?t.lamportTimestamps[r]=e.lamportTimestamps[r]:typeof e.lamportTimestamps[r]=="object"&&(t.lamportTimestamps[r]=new $util$1.LongBits(e.lamportTimestamps[r].low>>>0,e.lamportTimestamps[r].high>>>0).toNumber(!0))}return t},s.toObject=function(e,t){t||(t={});let r={};if((t.arrays||t.defaults)&&(r.values=[],r.senders=[],r.senderCounters=[],r.wallClockTimes=[],r.lamportTimestamps=[]),e.values&&e.values.length){r.values=[];for(let l=0;l<e.values.length;++l)r.values[l]=t.bytes===String?$util$1.base64.encode(e.values[l],0,e.values[l].length):t.bytes===Array?Array.prototype.slice.call(e.values[l]):e.values[l]}if(e.senders&&e.senders.length){r.senders=[];for(let l=0;l<e.senders.length;++l)r.senders[l]=e.senders[l]}if(e.senderCounters&&e.senderCounters.length){r.senderCounters=[];for(let l=0;l<e.senderCounters.length;++l)r.senderCounters[l]=e.senderCounters[l]}if(e.wallClockTimes&&e.wallClockTimes.length){r.wallClockTimes=[];for(let l=0;l<e.wallClockTimes.length;++l)typeof e.wallClockTimes[l]=="number"?r.wallClockTimes[l]=t.longs===String?String(e.wallClockTimes[l]):e.wallClockTimes[l]:r.wallClockTimes[l]=t.longs===String?$util$1.Long.prototype.toString.call(e.wallClockTimes[l]):t.longs===Number?new $util$1.LongBits(e.wallClockTimes[l].low>>>0,e.wallClockTimes[l].high>>>0).toNumber(!0):e.wallClockTimes[l]}if(e.lamportTimestamps&&e.lamportTimestamps.length){r.lamportTimestamps=[];for(let l=0;l<e.lamportTimestamps.length;++l)typeof e.lamportTimestamps[l]=="number"?r.lamportTimestamps[l]=t.longs===String?String(e.lamportTimestamps[l]):e.lamportTimestamps[l]:r.lamportTimestamps[l]=t.longs===String?$util$1.Long.prototype.toString.call(e.lamportTimestamps[l]):t.longs===Number?new $util$1.LongBits(e.lamportTimestamps[l].low>>>0,e.lamportTimestamps[l].high>>>0).toNumber(!0):e.lamportTimestamps[l]}return r},s.prototype.toJSON=function(){return this.constructor.toObject(this,minimal.util.toJSONOptions)},s})(),MultiValueMapSave=(()=>{function s(n){if(this.entries={},this.senders=[],n)for(let e=Object.keys(n),t=0;t<e.length;++t)n[e[t]]!=null&&(this[e[t]]=n[e[t]])}return s.prototype.entries=$util$1.emptyObject,s.prototype.senders=$util$1.emptyArray,s.create=function(e){return new s(e)},s.encode=function(e,t){if(t||(t=$Writer$1.create()),e.entries!=null&&Object.hasOwnProperty.call(e,"entries"))for(let r=Object.keys(e.entries),l=0;l<r.length;++l)t.uint32(10).fork().uint32(10).string(r[l]),MultiValueMapItemsSave.encode(e.entries[r[l]],t.uint32(18).fork()).ldelim().ldelim();if(e.senders!=null&&e.senders.length)for(let r=0;r<e.senders.length;++r)t.uint32(18).string(e.senders[r]);return t},s.encodeDelimited=function(e,t){return this.encode(e,t).ldelim()},s.decode=function(e,t){e instanceof $Reader$1||(e=$Reader$1.create(e));let r=t===void 0?e.len:e.pos+t,l=new s,o;for(;e.pos<r;){let a=e.uint32();switch(a>>>3){case 1:e.skip().pos++,l.entries===$util$1.emptyObject&&(l.entries={}),o=e.string(),e.pos++,l.entries[o]=MultiValueMapItemsSave.decode(e,e.uint32());break;case 2:l.senders&&l.senders.length||(l.senders=[]),l.senders.push(e.string());break;default:e.skipType(a&7);break}}return l},s.decodeDelimited=function(e){return e instanceof $Reader$1||(e=new $Reader$1(e)),this.decode(e,e.uint32())},s.verify=function(e){if(typeof e!="object"||e===null)return"object expected";if(e.entries!=null&&e.hasOwnProperty("entries")){if(!$util$1.isObject(e.entries))return"entries: object expected";let t=Object.keys(e.entries);for(let r=0;r<t.length;++r){let l=MultiValueMapItemsSave.verify(e.entries[t[r]]);if(l)return"entries."+l}}if(e.senders!=null&&e.hasOwnProperty("senders")){if(!Array.isArray(e.senders))return"senders: array expected";for(let t=0;t<e.senders.length;++t)if(!$util$1.isString(e.senders[t]))return"senders: string[] expected"}return null},s.fromObject=function(e){if(e instanceof s)return e;let t=new s;if(e.entries){if(typeof e.entries!="object")throw TypeError(".MultiValueMapSave.entries: object expected");t.entries={};for(let r=Object.keys(e.entries),l=0;l<r.length;++l){if(typeof e.entries[r[l]]!="object")throw TypeError(".MultiValueMapSave.entries: object expected");t.entries[r[l]]=MultiValueMapItemsSave.fromObject(e.entries[r[l]])}}if(e.senders){if(!Array.isArray(e.senders))throw TypeError(".MultiValueMapSave.senders: array expected");t.senders=[];for(let r=0;r<e.senders.length;++r)t.senders[r]=String(e.senders[r])}return t},s.toObject=function(e,t){t||(t={});let r={};(t.arrays||t.defaults)&&(r.senders=[]),(t.objects||t.defaults)&&(r.entries={});let l;if(e.entries&&(l=Object.keys(e.entries)).length){r.entries={};for(let o=0;o<l.length;++o)r.entries[l[o]]=MultiValueMapItemsSave.toObject(e.entries[l[o]],t)}if(e.senders&&e.senders.length){r.senders=[];for(let o=0;o<e.senders.length;++o)r.senders[o]=e.senders[o]}return r},s.prototype.toJSON=function(){return this.constructor.toObject(this,minimal.util.toJSONOptions)},s})(),RADIX$1=36;class CSet extends AbstractSet_Collab{constructor(n,e,t={}){if(super(n),this.valueConstructor=e,this.children=new Map,this.constructorArgs=new Map,this.justDeletedChildren=new Map,this.deletedSendingChild=void 0,this.inAdd=!1,this.ourCreatedValue=void 0,this.trCounter=0,this.runtime.isCRDTRuntime!==!0)throw new Error("this.runtime must be CRuntime or compatible");this.argsSerializer=t.argsSerializer??DefaultSerializer.getInstance()}childSend(n,e,t){if(n.parent!==this)throw new Error(`childSend called by non-child: ${n}`);this.children.has(n.name)||(this.deletedSendingChild=n),e.push(n.name),this.send(e,t)}receive(n,e){const t=nonNull(n.pop());if(typeof t=="string"){let r=this.children.get(t);if(r===void 0)if(this.deletedSendingChild!==void 0)r=this.deletedSendingChild,this.deletedSendingChild=void 0;else return;r.receive(n,e)}else{const r=CSetMessage.decode(t),l=e.runtimeExtra;switch(r.op){case"add":{const o=this.makeName(e.senderID,l.senderCounter);this.receiveAdd(o,r.add,e);break}case"delete":{const o=this.children.get(r.delete);o!==void 0&&this.receiveDelete(r.delete,o,e);break}default:throw new Error(`Unknown decoded.op: ${r.op}`)}}}receiveAdd(n,e,t){if(this.children.has(n))throw new Error('Duplicate newValue name: "'+n+'"');const r=this.valueConstructor(new InitToken(n,this),...this.argsSerializer.deserialize(nonNull(e)));this.children.set(n,r),this.constructorArgs.set(n,nonNull(e)),this.inAdd&&(this.ourCreatedValue=r),this.emit("Add",{value:r,meta:t})}receiveDelete(n,e,t){this.children.delete(n),this.constructorArgs.delete(n),this.justDeletedChildren.size===0&&this.runtime.on("Update",()=>this.justDeletedChildren.clear(),{once:!0}),this.justDeletedChildren.set(n,e),this.emit("Delete",{value:e,meta:t}),e.finalize()}makeName(n,e){let t;return this.trCounter===0?(this.runtime.on("Update",()=>{this.trCounter=0},{once:!0}),t=`${e.toString(RADIX$1)},${n}`):t=`${e.toString(RADIX$1)}.${this.trCounter.toString(RADIX$1)},${n}`,this.trCounter++,t}parseName(n){const e=n.indexOf(","),t=n.lastIndexOf(".",e-1),r=n.slice(0,t===-1?e:t);return[n.slice(e+1),Number.parseInt(r,RADIX$1)]}add(...n){this.inAdd=!0;const e=CSetMessage.create({add:this.argsSerializer.serialize(n)});this.send([CSetMessage.encode(e).finish()],[]);const t=nonNull(this.ourCreatedValue);return this.ourCreatedValue=void 0,this.inAdd=!1,t}delete(n){if(this.has(n)){const e=CSetMessage.create({delete:n.name});this.send([CSetMessage.encode(e).finish()],[])}}has(n){return n.parent===this&&this.children.has(n.name)}values(){return this.children.values()}get size(){return this.children.size}getArgs(n){if(!this.has(n))throw new Error("this.has(value) is false");const e=this.constructorArgs.get(n.name);if(e===void 0)throw new Error("Cannot call argsOf on initial value");return this.argsSerializer.deserialize(e)}save(){const n=new Array(this.size),e=new Map;let t=0;for(const[l,o]of this.children)n[t]=nonNull(this.constructorArgs.get(l)),e.set(l,o.save()),t++;const r=CSetSave.create({args:n});return{self:CSetSave.encode(r).finish(),children:e}}load(n,e){const t=e.runtimeExtra;let r,l;n===null?(r=CSetSave.create({args:[]}),l=new Map):(r=CSetSave.decode(nonNull(n.self)),l=nonNull(n.children));for(const[a,u]of this.children)if(!l.has(a)){const[c,f]=this.parseName(a);t.remoteVectorClock.get(c)>=f&&this.receiveDelete(a,u,e)}let o=0;for(const a of l.keys()){if(!this.children.has(a)){const[u,c]=this.parseName(a);t.localVectorClock.get(u)<c&&this.receiveAdd(a,r.args[o],e)}o++}for(const[a,u]of l){const c=this.children.get(a);c!==void 0&&c.load(u,e)}}idOf(n){return collabIDOf(n,this)}fromID(n,e=0){const t=n.collabIDPath[e];let r=this.children.get(t);if(!(r===void 0&&(r=this.justDeletedChildren.get(t),r===void 0))){if(e===n.collabIDPath.length-1)return r;if(r.fromID===void 0)throw new Error("child is not a parent, but CollabID is its descendant");return r.fromID(n,e+1)}}canGC(){return this.size===0}}const trueSerializer=new ConstSerializer(!0);class CValueSet extends AbstractSet_CObject{constructor(n,e={}){super(n),this.mvMap=super.registerCollab("",t=>new CMultiValueMap(t,{keySerializer:e.valueSerializer,valueSerializer:trueSerializer})),this.mvMap.on("Delete",t=>{this.emit("Delete",{value:t.key,meta:t.meta})}),this.mvMap.on("Set",t=>{t.previousValue.isPresent||this.emit("Add",{value:t.key,meta:t.meta})})}add(n){return this.mvMap.set(n,!0),n}delete(n){const e=this.has(n);return this.mvMap.delete(n),e}clear(){this.mvMap.clear()}has(n){return this.mvMap.has(n)}get size(){return this.mvMap.size}values(){return this.mvMap.keys()}}class CMultiValueMap extends AbstractMap_PrimitiveCRDT{constructor(n,e={}){var t,r;super(n),this.state=new Map,this.keySerializer=e.keySerializer??DefaultSerializer.getInstance(),this.valueSerializer=e.valueSerializer??DefaultSerializer.getInstance(),this.wallClockTime=((t=e.aggregator)==null?void 0:t.wallClockTime)??!1,this.lamportTimestamp=((r=e.aggregator)==null?void 0:r.lamportTimestamp)??!1}set(n,e){const t=MultiValueMapMessage.create({key:this.keySerializer.serialize(n),value:this.valueSerializer.serialize(e)});return super.sendCRDT(MultiValueMapMessage.encode(t).finish()),nonNull(this.get(n))}delete(n){const e=MultiValueMapMessage.create({key:this.keySerializer.serialize(n)});super.sendCRDT(MultiValueMapMessage.encode(e).finish())}receiveCRDT(n,e,t){const r=MultiValueMapMessage.decode(n),l=fromByteArray_1(r.key),o=this.getInternal(l),a=[];let u=!1;if(o!==void 0)for(const c of o)t.vectorClock.get(c.senderID)<c.senderCounter&&a.push(c);protobufHas(r,"value")&&(a.push({value:this.valueSerializer.deserialize(r.value),senderID:e.senderID,senderCounter:t.senderCounter,...this.wallClockTime?{wallClockTime:nonNull(t.wallClockTime)}:{},...this.lamportTimestamp?{lamportTimestamp:nonNull(t.lamportTimestamp)}:{}}),u=!0),this.applyNewItems(l,r.key,o,a,e,u)}applyNewItems(n,e,t,r,l,o){o&&r.sort((u,c)=>u.senderID<c.senderID?-1:1);const a=this.keySerializer.deserialize(e??toByteArray_1(n));r.length===0?(this.state.delete(n),t!==void 0&&this.emit("Delete",{key:a,value:t,meta:l})):(this.state.set(n,r.length===1?r[0]:r),this.emit("Set",{key:a,value:r,previousValue:t===void 0?Optional.empty():Optional.of(t),meta:l}))}asNewArray(n){return n===void 0?[]:Array.isArray(n)?n.slice():[n]}get(n){return this.getInternal(fromByteArray_1(this.keySerializer.serialize(n)))}getInternal(n){const e=this.state.get(n);return e===void 0?void 0:this.asNewArray(e)}has(n){return this.state.has(fromByteArray_1(this.keySerializer.serialize(n)))}get size(){return this.state.size}*entries(){for(const[n,e]of this.state)yield[this.keySerializer.deserialize(toByteArray_1(n)),this.asNewArray(e)]}saveCRDT(){const n={},e=[],t=new Map;for(const[r,l]of this.state){const o=this.asNewArray(l),a={values:new Array(o.length),senders:new Array(o.length),senderCounters:new Array(o.length)};this.wallClockTime&&(a.wallClockTimes=new Array(o.length)),this.lamportTimestamp&&(a.lamportTimestamps=new Array(o.length));for(let u=0;u<o.length;u++){a.values[u]=this.valueSerializer.serialize(o[u].value);let c=t.get(o[u].senderID);c===void 0&&(c=e.length,e.push(o[u].senderID)),a.senders[u]=c,a.senderCounters[u]=o[u].senderCounter,this.wallClockTime&&(a.wallClockTimes[u]=o[u].wallClockTime),this.lamportTimestamp&&(a.lamportTimestamps[u]=o[u].lamportTimestamp)}n[r]=a}return MultiValueMapSave.encode({entries:n,senders:e}).finish()}loadCRDT(n,e,t){let r;n===null?r=MultiValueMapSave.create({entries:{},senders:[]}):r=MultiValueMapSave.decode(n);for(const[l,o]of this.state)this.loadOneKey(l,this.asNewArray(o),r.entries[l],r.senders,e,t),delete r.entries[l];for(const[l,o]of Object.entries(r.entries))this.loadOneKey(l,void 0,o,r.senders,e,t)}loadOneKey(n,e,t,r,l,o){const a=[];let u=!1;if(e!==void 0){const c=new Map;if(t!==void 0)for(let f=0;f<t.senders.length;f++)c.set(r[t.senders[f]],t.senderCounters[f]);for(const f of e)(o.remoteVectorClock.get(f.senderID)<f.senderCounter||c.get(f.senderID)===f.senderCounter)&&a.push(f)}if(t!==void 0)for(let c=0;c<t.senders.length;c++){const f=r[t.senders[c]],d=t.senderCounters[c];o.localVectorClock.get(f)<d&&(a.push({value:this.valueSerializer.deserialize(t.values[c]),senderID:f,senderCounter:d,...this.wallClockTime?{wallClockTime:int64AsNumber(t.wallClockTimes[c])}:{},...this.lamportTimestamp?{lamportTimestamp:int64AsNumber(t.lamportTimestamps[c])}:{}}),u=!0)}(u||e!==void 0&&a.length<e.length)&&this.applyNewItems(n,void 0,e,a,l,u)}canGC(){return this.state.size===0}}const defaultAggregator$1={aggregate(s){return s[0].value}};class CValueMap extends AbstractMap_CObject{constructor(n,e={}){super(n),this.aggregator=e.aggregator??defaultAggregator$1,this.mvMap=super.registerCollab("",t=>new CMultiValueMap(t,e)),this.mvMap.on("Delete",t=>{this.emit("Delete",{key:t.key,value:this.aggregator.aggregate(t.value),meta:t.meta})}),this.mvMap.on("Set",t=>{this.emit("Set",{key:t.key,value:this.aggregator.aggregate(t.value),previousValue:t.previousValue.map(r=>this.aggregator.aggregate(r)),meta:t.meta})})}set(n,e){return this.mvMap.set(n,e),this.get(n)}delete(n){const e=this.has(n);return this.mvMap.delete(n),e}get(n){const e=this.mvMap.get(n);if(e!==void 0)return this.aggregator.aggregate(e)}getConflicts(n){return(this.mvMap.get(n)??[]).map(e=>e.value)}has(n){return this.mvMap.has(n)}get size(){return this.mvMap.size}*entries(){for(const[n,e]of this.mvMap)yield[n,this.aggregator.aggregate(e)]}}class CMap extends AbstractMap_CObject{constructor(n,e,t={}){super(n);const r=t.keySerializer??DefaultSerializer.getInstance(),l=t.argsSerializer??DefaultSerializer.getInstance();this.valueSet=super.registerCollab("",o=>new CSet(o,(a,u,c)=>e(a,u,...c),{argsSerializer:new PairSerializer(r,l)})),this.map=super.registerCollab("0",o=>new CValueMap(o,{keySerializer:r,valueSerializer:CollabIDSerializer.getInstance(),aggregator:t.aggregator})),this.map.on("Set",o=>{const a=o.previousValue.map(u=>nonNull(this.valueSet.fromID(u)));this.emit("Set",{key:o.key,value:nonNull(this.valueSet.fromID(o.value)),previousValue:a,meta:o.meta})}),this.map.on("Delete",o=>{const a=nonNull(this.valueSet.fromID(o.value));this.emit("Delete",{key:o.key,value:a,meta:o.meta})})}set(n,...e){const t=this.getConflicts(n),r=this.valueSet.add(n,e);return this.map.set(n,this.valueSet.idOf(r)),t.forEach(l=>this.valueSet.delete(l)),r}delete(n){const e=this.getConflicts(n);this.map.delete(n),e.forEach(t=>this.valueSet.delete(t))}get(n){const e=this.map.get(n);return e===void 0?void 0:nonNull(this.valueSet.fromID(e))}getConflicts(n){return this.map.getConflicts(n).map(e=>nonNull(this.valueSet.fromID(e)))}has(n){return this.map.has(n)}*entries(){for(const[n,e]of this.map)yield[n,nonNull(this.valueSet.fromID(e))]}keyOf(n){if(this.valueSet.has(n))return this.valueSet.getArgs(n)[0]}get size(){return this.map.size}}class CPresence extends PrimitiveCRDT{constructor(n,e={}){if(super(n),this.state=new Map,this._size=0,this.ourValue=null,this.heartbeatTimeout=null,this._connected=!1,this.joined=!1,this.heartbeat=()=>{this.connected&&super.sendCRDT(PresenceMessage.encode({heartbeat:!0}).finish()),this.resetHeartbeat()},this.updateSerializer=e.updateSerializer??DefaultSerializer.getInstance(),this.ttlMS=e.ttlMS??CPresence.TTL_MS_DEFAULT,!(Number.isInteger(this.ttlMS)&&this.ttlMS>0))throw new Error(`options.ttlMS must be a positive integer; got ${this.ttlMS}`);this.heartbeatInterval=Math.ceil(this.ttlMS/2)}setOurs(n){const e=this.ourValue===null?Optional.empty():Optional.of(this.ourValue);this.ourValue===null&&this._size++,this.ourValue=n,this.connected&&(super.sendCRDT(PresenceMessage.encode({set:{value:this.updateSerializer.serialize(this.ourValue)}}).finish()),this.resetHeartbeat()),this.emitOwnSetEvent(e)}updateOurs(n,e){if(this.ourValue===null)throw new Error("You must set our value with setOurs before updating it with updateOurs");const t=Optional.of(this.ourValue);if(this.ourValue={...this.ourValue,[n]:e},this.connected){const r={};r[n]=e,super.sendCRDT(PresenceMessage.encode({update:this.updateSerializer.serialize(r)}).finish()),this.resetHeartbeat()}this.emitOwnSetEvent(t)}emitOwnSetEvent(n){this.emit("Set",{key:this.runtime.replicaID,value:nonNull(this.ourValue),previousValue:n,meta:{isLocalOp:!0,senderID:this.runtime.replicaID,updateType:"message",runtimeExtra:void 0}})}connect(){if(!this._connected){if(this.ourValue===null)throw new Error("You must set our value with setOurs before calling connect()");super.sendCRDT(PresenceMessage.encode({set:{value:this.updateSerializer.serialize(this.ourValue),isJoin:!this.joined}}).finish()),this._connected=!0,this.joined=!0,this.resetHeartbeat()}}disconnect(){this._connected&&(super.sendCRDT(PresenceMessage.encode({disconnect:!0}).finish()),this._connected=!1,this.resetHeartbeat())}get connected(){return this._connected}resetHeartbeat(){this.heartbeatTimeout!==null&&clearTimeout(this.heartbeatTimeout),this._connected?this.heartbeatTimeout=setTimeout(this.heartbeat,this.heartbeatInterval):this.heartbeatTimeout=null}receiveCRDT(n,e,t){if(e.isLocalOp||!this.joined)return;const r=PresenceMessage.decode(n);switch(r.type){case"heartbeat":{this.processHeartbeat(null,e.senderID,e);break}case"set":{const l=r.set;if(l.isResponse&&this.state.has(e.senderID))this.processHeartbeat(null,e.senderID,e);else{const o=this.updateSerializer.deserialize(l.value);this.processHeartbeat(o,e.senderID,e)}l.isJoin&&this.sendResponse();break}case"update":{const l=this.state.get(e.senderID);if(l===void 0)this.processHeartbeat(null,e.senderID,e);else{const o={...l.value,...this.updateSerializer.deserialize(r.update)};this.processHeartbeat(o,e.senderID,e)}break}case"disconnect":{const l=this.state.get(e.senderID);l!==void 0&&(l.timeout!==null&&clearTimeout(l.timeout),this.state.delete(e.senderID),this._size--,this.emit("Delete",{key:e.senderID,value:l.value,meta:e}));break}case"request":{r.request===this.runtime.replicaID&&this.sendResponse();break}}}processHeartbeat(n,e,t,r=Date.now()){let l=this.state.get(e);if(l===void 0)if(n===null){setTimeout(()=>super.sendCRDT(PresenceMessage.encode({request:e}).finish()),0);return}else l={value:n,present:!1,time:0,timeout:null},this.state.set(e,l);const o=l.present?Optional.of(l.value):Optional.empty();n!==null&&(l.value=n),l.timeout!==null&&clearTimeout(l.timeout),l.time=Math.max(l.time,r);const a=l.time+this.ttlMS-Date.now();a>0?(l.present||this._size++,l.present=!0,l.timeout=setTimeout(()=>this.processTimeout(e,nonNull(l),t),a),(!o.isPresent||n!==null)&&this.emit("Set",{key:e,value:l.value,previousValue:o,meta:t})):l.timeout=null}processTimeout(n,e,t){e.timeout=null,e.present&&(e.present=!1,this._size--,this.emit("Delete",{key:n,value:e.value,meta:t}))}sendResponse(){setTimeout(()=>{this.connected&&(super.sendCRDT(PresenceMessage.encode({set:{value:this.updateSerializer.serialize(nonNull(this.ourValue)),isResponse:!0}}).finish()),this.resetHeartbeat())})}getOurs(){return this.ourValue??void 0}get(n){if(n===this.runtime.replicaID)return this.getOurs();const e=this.state.get(n);if(!(e===void 0||!e.present))return e.value}has(n){return this.get(n)!==void 0}get size(){return this._size}*entries(){this.ourValue!==null&&(yield[this.runtime.replicaID,this.ourValue]);for(const[n,e]of this.state)e.present&&(yield[n,e.value])}[Symbol.iterator](){return this.entries()}forEach(n,e){for(const[t,r]of this)n.call(e,r,t,this)}*keys(){for(const[n]of this)yield n}*values(){for(const[,n]of this)yield n}saveCRDT(){const n={};for(const[e,t]of this.state)t.present&&(n[e]={value:this.updateSerializer.serialize(t.value),time:t.time});return this.connected&&(n[this.runtime.replicaID]={value:this.updateSerializer.serialize(nonNull(this.ourValue)),time:Date.now()}),PresenceSave.encode({state:n,saverID:this.runtime.replicaID}).finish()}loadCRDT(n,e,t){if(n===null)return;const r=PresenceSave.decode(n);for(const[l,o]of Object.entries(r.state))if(t.remoteVectorClock.get(l)>t.localVectorClock.get(l)){const a=this.updateSerializer.deserialize(o.value);let u=int64AsNumber(o.time);u>Date.now()&&(u=2*Date.now()-u),this.processHeartbeat(a,r.saverID,e,u)}}}CPresence.TTL_MS_DEFAULT=1e4;const nullSerializer=new ConstSerializer(null),defaultAggregator={aggregate(s){return s[0].value}};class CVar extends CObject{constructor(n,e,t={}){super(n);const r=t.aggregator??defaultAggregator;this.mvMap=super.registerCollab("",l=>new CMultiValueMap(l,{keySerializer:nullSerializer,valueSerializer:t.valueSerializer,aggregator:t.aggregator})),this.mvMap.on("Any",l=>{const o=this._value,a=this.mvMap.get(null);this._value=a===void 0?e:r.aggregate(a),this.emit("Set",{value:this._value,previousValue:o,meta:l.meta})}),this._value=e}set(n){return this.mvMap.set(null,n),this._value}set value(n){this.set(n)}get value(){return this._value}conflicts(){return(this.mvMap.get(null)??[]).map(n=>n.value)}clear(){this.mvMap.delete(null)}toString(){return`${this.value}`}}const trueBytes=new Uint8Array,falseBytes=new Uint8Array(1),BooleanSerializer={serialize(s){return s?trueBytes:falseBytes},deserialize(s){return s.length===0}},TrueWinsAggregator={aggregate(s){return s.find(n=>n.value)!==void 0}},FalseWinsAggregator={aggregate(s){return s.find(n=>!n.value)===void 0}};class CBoolean extends CVar{constructor(n,e={}){const t=e.winner??!0,r=e.initialValue??!1;super(n,r,{valueSerializer:BooleanSerializer,aggregator:t?TrueWinsAggregator:FalseWinsAggregator})}}const RADIX=36;class Waypoint{constructor(n,e,t,r,l){this.senderID=n,this.counter=e,this.parentWaypoint=t,this.parentValueIndex=r,this.isRight=l,this.children=[]}}class CTotalOrder extends CPrimitive{constructor(n){super(n),this.waypointsByID=new Map,this.ourWaypoints=new Map,this.rootWaypoint=new Waypoint("",0,null,0,!0),this.waypointsByID.set("",[this.rootWaypoint])}createPositions(n,e,t){if(n!==null&&n===e)throw new Error("prevPosition == nextPosition");if(t<=0)throw new Error(`count is <= 0: ${t}`);const[r,l]=n===null?[this.rootWaypoint,0]:this.decode(n);if(e!==null){const[u,c]=this.decode(e);if(this.isDescendant(u,c,r,l)){const[f,d]=this.leftmostDescendant(u,c);return this.createChildren(f,d,!1,t)}}const o=this.ourWaypoints.get(r);if(o!==void 0)return this.ourWaypoints.set(r,o+t),this.encodeAll(r,o,t);const a=this.firstRightChild(r,l);if(a===null)return this.createChildren(r,l,!0,t);{const u=this.leftmostDescendant0(a);return this.createChildren(u,0,!1,t)}}isDescendant(n,e,t,r){if(n===t)return e>=r;let l=n;for(;l.parentWaypoint!==t;){if(l.parentWaypoint===null)return!1;l=l.parentWaypoint}return l.parentValueIndex>r?!0:l.parentValueIndex===r?l.isRight:!1}leftmostDescendant(n,e){for(const t of n.children){if(!t.isRight&&t.parentValueIndex===e)return[this.leftmostDescendant0(t),0];if(t.isRight||t.parentValueIndex>e)break}return[n,e]}leftmostDescendant0(n){let e=n;for(;e.children.length>0;){const t=e.children[0];if(t.parentValueIndex===0&&!t.isRight)e=t;else break}return e}firstRightChild(n,e){for(const t of n.children)if(t.parentValueIndex===e&&t.isRight)return t;return null}createChildren(n,e,t,r){const l={parentWaypointSenderID:n.senderID===this.runtime.replicaID?void 0:n.senderID,parentWaypointCounterAndSide:this.valueAndSideEncode(n.counter,t),parentValueIndex:e};this.sendPrimitive(TotalOrderCreateMessage.encode(l).finish());const o=nonNull(this.waypointsByID.get(this.runtime.replicaID)),a=o[o.length-1];return this.ourWaypoints.set(a,r),this.encodeAll(a,0,r)}valueAndSideEncode(n,e){return e?n:~n}valueAndSideDecode(n){const e=n>=0;return[e?n:~n,e]}receivePrimitive(n,e){const t=TotalOrderCreateMessage.decode(n),r=protobufHas(t,"parentWaypointSenderID")?nonNull(t.parentWaypointSenderID):e.senderID,[l,o]=this.valueAndSideDecode(t.parentWaypointCounterAndSide),a=this.getWaypoint(r,l);let u=this.waypointsByID.get(e.senderID);u===void 0&&(u=[],this.waypointsByID.set(e.senderID,u));const c=new Waypoint(e.senderID,u.length,a,t.parentValueIndex,o);u.push(c),this.addToChildren(c)}addToChildren(n){const e=nonNull(n.parentWaypoint).children;let t=0;for(;t<e.length&&!this.isSiblingLess(n,e[t]);t++);e.splice(t,0,n)}isSiblingLess(n,e){return n.isRight===e.isRight?n.parentValueIndex===e.parentValueIndex?n.senderID<e.senderID:n.isRight===n.parentValueIndex>e.parentValueIndex:e.isRight}getWaypoint(n,e){const t=this.waypointsByID.get(n);if(t===void 0)throw new Error("Invalid position: unknown senderID");if(e<0)throw new Error("Invalid position: counter < 0");if(e>=t.length)throw new Error("Invalid position: unknown counter");return t[e]}encode(n,e){return`${n.counter.toString(RADIX)}.${e.toString(RADIX)},${n.senderID}`}encodeAll(n,e,t){const r=new Array(t);for(let l=0;l<t;l++)r[l]=this.encode(n,e+l);return r}decode(n){const e=n.indexOf("."),t=n.indexOf(",",e),r=Number.parseInt(n.slice(0,e),RADIX),l=Number.parseInt(n.slice(e+1,t),RADIX),o=n.slice(t+1);if(e===-1||t===-1||isNaN(r)||isNaN(l))throw new Error(`Not a Position: ${n}`);const a=this.getWaypoint(o,r);if(l<0)throw new Error(`Invalid valueIndex < 0: ${l}`);return[a,l]}savePrimitive(){const n=[],e=[],t=new Map;let r=0;for(const[u,c]of this.waypointsByID)u!==""&&(n.push(u),e.push(c.length),t.set(u,r),r+=c.length);const l=[],o=[];for(const u of this.waypointsByID.values())for(const c of u)if(c!==this.rootWaypoint){const f=nonNull(c.parentWaypoint);f===this.rootWaypoint?l.push(0):l.push(1+nonNull(t.get(f.senderID))+f.counter),o.push(this.valueAndSideEncode(c.parentValueIndex,c.isRight))}const a=TotalOrderSave.create({replicaIDs:n,replicaCounts:e,parentWaypoints:l,parentValueIndexAndSides:o});return TotalOrderSave.encode(a).finish()}loadPrimitive(n,e){if(n===null)return;const t=TotalOrderSave.decode(n),r=[],l=[this.rootWaypoint];let o=0;for(let a=0;a<t.replicaIDs.length;a++){const u=t.replicaIDs[a],c=t.replicaCounts[a];let f=this.waypointsByID.get(u);f===void 0&&(f=[],this.waypointsByID.set(u,f)),r.push(f.length);for(let d=f.length;d<c;d++){const h=o+d,p=new Waypoint(u,d,null,...this.valueAndSideDecode(t.parentValueIndexAndSides[h]));f.push(p)}for(let d=0;d<c;d++)l.push(f[d]);o+=c}o=0;for(let a=0;a<t.replicaIDs.length;a++){const u=t.replicaIDs[a],c=t.replicaCounts[a],f=r[a],d=nonNull(this.waypointsByID.get(u));for(let h=f;h<c;h++){const p=o+h,y=d[h];y.parentWaypoint=l[t.parentWaypoints[p]],this.addToChildren(y)}o+=c}}}class LocalList{constructor(n){this.source=n,this.valuesByWaypoint=new Map,this._inInitialState=!0,this.iterFailFast="mod"}set(n,e){this._inInitialState=!1;const[t,r]=this.source.decode(n),l=this.valuesByWaypoint.get(t);if(l===void 0){const u=r===0?[[e]]:[r,[e]];this.valuesByWaypoint.set(t,{total:0,seen:r+1,items:u}),this.updateTotals(t,1);return}const o=l.items;let a=r;for(let u=0;u<o.length;u++){const c=o[u];if(typeof c!="number")if(a<c.length){c[a]=e;return}else a-=c.length;else if(a<c){let f=u,d=1;const h=[[e]];a!==0?h.unshift(a):u!==0&&(f--,d++,h[0].unshift(...o[u-1])),a!==c-1?h.push(c-1-a):u!==o.length-1&&(d++,h[h.length-1].push(...o[u+1])),o.splice(f,d,...h),this.updateTotals(t,1);return}else a-=c}a!==0?o.push(a,[e]):o.length===0?o.push([e]):o[o.length-1].push(e),l.seen=Math.max(l.seen,r+1),this.updateTotals(t,1)}setCreated(n,e){if(e.length===0)return;this._inInitialState=!1;const[t,r]=this.source.decode(n),l=this.valuesByWaypoint.get(t);if(l===void 0){e=e.slice();const o=r===0?[e]:[r,e];this.valuesByWaypoint.set(t,{total:0,seen:r+e.length,items:o})}else{if(r<l.seen)throw new Error("setCreated called on seen positions");let o=0;for(const a of l.items)o+=typeof a=="number"?a:a.length;if(o<r)l.items.push(r-o,e.slice());else if(o===r)l.items.length===0?l.items.push(e.slice()):l.items[l.items.length-1].push(...e);else throw new Error("setCreated called on seen positions");l.seen=Math.max(l.seen,r+e.length)}this.updateTotals(t,e.length)}delete(n){this._inInitialState=!1;const[e,t]=this.source.decode(n),r=this.valuesByWaypoint.get(e);if(r===void 0)return!1;const l=r.items;let o=t;for(let a=0;a<l.length;a++){const u=l[a];if(typeof u=="number"){if(o<u)return!1;o-=u}else if(o<u.length){let c=a,f=1;const d=[1];return o!==0?d.unshift(u.slice(0,o)):a!==0&&(c--,f++,d[0]+=l[a-1]),o!==u.length-1?d.push(u.slice(o+1)):a!==l.length-1&&(f++,d[d.length-1]+=l[a+1]),l.splice(c,f,...d),typeof l[l.length-1]=="number"&&l.pop(),this.updateTotals(e,-1),!0}else o-=u.length}return!1}updateTotals(n,e){this.iterFailFast="mod";for(let t=n;t!==null;t=t.parentWaypoint){const r=this.valuesByWaypoint.get(t);r===void 0?this.valuesByWaypoint.set(t,{total:e,seen:0,items:[]}):r.total+=e}}getByPosition(n){return this.locate(...this.source.decode(n))[0]}hasPosition(n){return this.locate(...this.source.decode(n))[1]}locate(n,e){const t=this.valuesByWaypoint.get(n);if(t===void 0)return[void 0,!1,0];let r=e,l=0;for(const o of t.items)if(typeof o=="number"){if(r<o)return[void 0,!1,l];r-=o}else{if(r<o.length)return[o[r],!0,l+r];r-=o.length,l+=o.length}return[void 0,!1,l]}valueCount(n){const e=this.valuesByWaypoint.get(n);if(e===void 0)return 0;let t=0;for(const r of e.items)typeof r!="number"&&(t+=r.length);return t}indexOfPosition(n,e="none"){const[t,r]=this.source.decode(n),[,l,o]=this.locate(t,r);let a=o;for(const u of t.children){if(u.isRight||u.parentValueIndex>r)break;a+=this.total(u)}for(let u=t;u.parentWaypoint!==null;u=u.parentWaypoint){u.isRight?a+=this.valueCount(u.parentWaypoint):a+=this.locate(u.parentWaypoint,u.parentValueIndex)[2];for(const c of u.parentWaypoint.children){if(c===u)break;a+=this.total(c)}}if(l)return a;switch(e){case"none":return-1;case"left":return a-1;case"right":return a}}getPosition(n){if(n<0||n>=this.length)throw new Error(`Index out of bounds: ${n} (length: ${this.length})`);let e=n,t=this.source.rootWaypoint;for(;;)e:{for(const r of this.valuesAndChildren(t))if(r.isValues){const l=r.end-r.start;if(e<l)return this.source.encode(t,r.valueIndex+e);e-=l}else if(e<r.total){t=r.child;break e}else e-=r.total;throw new Error("Internal error: failed to find index among children")}}get(n){return this.getByPosition(this.getPosition(n))}get length(){return this.total(this.source.rootWaypoint)}[Symbol.iterator](){return this.values()}*entries(){if(this.length===0)return;this.iterFailFast="iter";let n=0,e=this.source.rootWaypoint;const t=[this.valuesAndChildren(this.source.rootWaypoint)];for(;e!==null;){const l=t[t.length-1].next();if(l.done)t.pop(),e=e.parentWaypoint;else{const o=l.value;if(o.isValues){if(this.iterFailFast==="mod")throw new Error("LocalList modified while iterating over it");for(let a=0;a<o.end-o.start;a++)yield[n,o.item[o.start+a],this.source.encode(e,o.valueIndex+a)],n++}else e=o.child,t.push(this.valuesAndChildren(e))}}}*valuesAndChildren(n){const e=nonNull(this.valuesByWaypoint.get(n)).items,t=n.children;let r=0,l=0;for(const o of e){const a=typeof o=="number"?o:o.length,u=l+a;let c=l;for(;r<t.length;r++){const f=t[r];if(f.isRight||f.parentValueIndex>=u)break;const d=this.total(f);d!==0&&(c<f.parentValueIndex&&(typeof o!="number"&&(yield{isValues:!0,item:o,start:c-l,end:f.parentValueIndex-l,valueIndex:c}),c=f.parentValueIndex),yield{isValues:!1,child:f,total:d})}typeof o!="number"&&c<u&&(yield{isValues:!0,item:o,start:c-l,end:a,valueIndex:c}),l=u}for(;r<t.length;r++){const o=t[r],a=this.total(o);this.total(o)!==0&&(yield{isValues:!1,child:o,total:a})}}total(n){var e;return((e=this.valuesByWaypoint.get(n))==null?void 0:e.total)??0}*values(){for(const[,n]of this.entries())yield n}*positions(){for(const[,,n]of this.entries())yield n}slice(n,e){const t=this.length;if(n===void 0||n<-t)n=0;else if(n<0)n+=t;else if(n>=t)return[];if(e===void 0||e>=t?e=t:e<-t?e=0:e<0&&(e+=t),e<=n)return[];if(n===0&&e===t)return[...this.values()];{const r=new Array(e-n);for(let l=0;l<e-n;l++)r[l]=this.get(n+l);return r}}getSeen(n){var e;return((e=this.valuesByWaypoint.get(n))==null?void 0:e.seen)??0}get inInitialState(){return this._inInitialState}save(n){const e=[],t=new Map;t.set("",0);const r=[],l=[],o=[],a=[],u=[],c=[],f=[];for(const[h,p]of this.valuesByWaypoint){let y=t.get(h.senderID);y===void 0&&(e.push(h.senderID),y=e.length,t.set(h.senderID,y)),r.push(y),l.push(h.counter),o.push(p.total),a.push(p.seen),u.push(p.items.length);for(const b of p.items)typeof b=="number"?c.push(-b):(c.push(b.length),f.push(...b))}const d=LocalListSave.create({replicaIDs:e,replicaIDIndices:r,counters:l,totals:o,seens:a,itemsLengths:u,itemSizes:c,values:n.serialize(f)});return LocalListSave.encode(d).finish()}load(n,e){if(!this._inInitialState)throw new Error("Can only call load in the initial state");this._inInitialState=!1;const t=LocalListSave.decode(n),r=e.deserialize(t.values);let l=0,o=0;for(let a=0;a<t.replicaIDIndices.length;a++){const u=t.replicaIDIndices[a],c=u===0?"":t.replicaIDs[u-1],f=this.source.getWaypoint(c,t.counters[a]),d={total:t.totals[a],seen:t.seens[a],items:new Array(t.itemsLengths[a])};for(let h=0;h<t.itemsLengths[a];h++){const p=t.itemSizes[l];l++,p<0?d.items[h]=-p:(d.items[h]=r.slice(o,o+p),o+=p)}this.valuesByWaypoint.set(f,d)}}}class CListEntry extends CObject{constructor(n,e,t){super(n),this.value=super.registerCollab("",e),this.position=super.registerCollab("0",r=>new CVar(r,t)),this.present=super.registerCollab("1",r=>new CBoolean(r,{initialValue:!0,winner:!0}))}}class CList extends AbstractList_CObject{constructor(n,e,t={}){super(n),this.valueConstructor=e;const r=t.argsSerializer??DefaultSerializer.getInstance();this.totalOrder=this.registerCollab("0",l=>new CTotalOrder(l)),this.set=this.registerCollab("",l=>new CSet(l,this.entryConstructor.bind(this),{argsSerializer:new PairSerializer(StringSerializer.instance,r)})),this.list=new LocalList(this.totalOrder),this.set.on("Add",l=>{const o=l.value.position.value;this.list.set(o,l.value.value),this.emit("Insert",{index:this.list.indexOfPosition(o),values:[l.value.value],positions:[o],method:"insert",meta:l.meta})}),this.set.on("Delete",l=>{const o=l.value.position.value;if(l.value.present.value){const a=this.list.indexOfPosition(o);this.list.delete(o),this.emit("Delete",{index:a,values:[l.value.value],positions:[o],method:"delete",meta:l.meta})}else this.emit("DeleteArchived",{values:[l.value.value],positions:[o],meta:l.meta})})}entryConstructor(n,e,t){const r=new CListEntry(n,l=>this.valueConstructor(l,...t),e);return r.position.on("Set",l=>{if(l.value!==l.previousValue)if(r.present.value){const o=this.list.indexOfPosition(l.previousValue);this.list.delete(l.previousValue),this.list.set(l.value,r.value),this.emit("Move",{index:this.list.indexOfPosition(l.value),previousIndex:o,values:[r.value],previousPositions:[l.previousValue],positions:[l.value],meta:l.meta})}else this.emit("MoveArchived",{values:[r.value],previousPositions:[l.previousValue],positions:[l.value],meta:l.meta})}),r.present.on("Set",l=>{if(l.value===l.previousValue)return;const o=r.position.value;if(l.value)this.list.set(o,r.value),this.emit("Insert",{index:this.list.indexOfPosition(o),values:[r.value],positions:[o],method:"restore",meta:l.meta});else{const a=this.list.indexOfPosition(o);this.list.delete(o),this.emit("Delete",{index:a,values:[r.value],positions:[o],method:"archive",meta:l.meta})}}),r}entryFromValue(n){return isRuntime(n.parent)?null:n.parent}insert(n,...e){const t=this.createPositions(n,1)[0];return this.set.add(t,e).value}createPositions(n,e){return this.totalOrder.createPositions(n===0?null:this.list.getPosition(n-1),n===this.length?null:this.list.getPosition(n),e)}delete(n,e=1){if(e<0||!Number.isInteger(e))throw new Error(`invalid count: ${e}`);const t=this.list.slice(n,n+e);t.reverse();for(const r of t)this.set.delete(nonNull(this.entryFromValue(r)))}archive(n,e=1){if(e<0||!Number.isInteger(e))throw new Error(`invalid count: ${e}`);const t=this.list.slice(n,n+e);t.reverse();for(const r of t){const l=nonNull(this.entryFromValue(r));l.present.value=!1}}restore(n){const e=this.entryFromValue(n);e===null||!this.set.has(e)||(e.present.value=!0)}move(n,e,t=1){if(t<0||!Number.isInteger(t))throw new Error(`invalid count: ${t}`);if(t===0)return e;const r=this.createPositions(e,t),l=this.list.slice(n,n+t);for(let o=0;o<t;o++){const a=nonNull(this.entryFromValue(l[o]));a.position.value=r[o]}return this.list.indexOfPosition(r[0])}get(n){return this.list.get(n)}values(){return this.list.values()}get length(){return this.list.length}push(...n){return this.insert(this.length,...n)}unshift(...n){return this.insert(0,...n)}slice(n,e){return this.list.slice(n,e)}getPosition(n){return this.list.getPosition(n)}indexOfPosition(n,e="none"){return this.list.indexOfPosition(n,e)}hasPosition(n){return this.list.hasPosition(n)}getByPosition(n){return this.list.getByPosition(n)}entries(){return this.list.entries()}indexOf(n,e=0){const t=this.entryFromValue(n);if(t!==null&&this.set.has(t)&&t.present.value){const r=this.list.indexOfPosition(t.position.value);if(e<0&&(e+=this.length),r>=e)return r}return-1}positionOf(n){const e=this.entryFromValue(n);if(e!==null&&this.set.has(e)&&e.present.value)return e.position.value}}class PartialSpanSerializer{constructor(n){this.formatSerializer=n}serialize(n){const e=SpanLogPartialSpanMessage.create({...n,value:n.value===void 0?void 0:this.formatSerializer.serialize(n.value)});return SpanLogPartialSpanMessage.encode(e).finish()}deserialize(n){const e=SpanLogPartialSpanMessage.decode(n);return{key:e.key,value:protobufHas(e,"value")?this.formatSerializer.deserialize(e.value):void 0,startPosition:e.startPosition,endPosition:protobufHas(e,"endPosition")?e.endPosition:null,...e.endClosed?{endClosed:!0}:{}}}}class CSpanLog extends PrimitiveCRDT{constructor(n,e){super(n),this.log=new Map,this.partialSpanSerializer=new PartialSpanSerializer(e)}add(n,e,t,r,l){super.sendCRDT(this.partialSpanSerializer.serialize({key:n,value:e,startPosition:t,endPosition:r,endClosed:l?!0:void 0}))}receiveCRDT(n,e,t){const l={...this.partialSpanSerializer.deserialize(n),lamport:nonNull(t.lamportTimestamp),senderID:t.senderID};let o=this.log.get(t.senderID);o===void 0&&(o=[],this.log.set(t.senderID,o)),o.push(l),this.emit("Add",{span:l,meta:e})}saveCRDT(){const n=new Array(this.log.size),e=new Array(this.log.size),t=[],r=[];let l=0;for(const[a,u]of this.log){n[l]=a,e[l]=u.length;for(const c of u)t.push(this.partialSpanSerializer.serialize(c)),r.push(c.lamport);l++}const o=SpanLogSaveMessage.create({senderIDs:n,lengths:e,spans:t,lamports:r});return SpanLogSaveMessage.encode(o).finish()}loadCRDT(n,e){if(n===null)return;const t=SpanLogSaveMessage.decode(n);let r=0;for(let l=0;l<t.senderIDs.length;l++){const o=t.senderIDs[l];let a,u=this.log.get(o);u===void 0?(u=[],this.log.set(o,u),a=-1):a=u[u.length-1].lamport;for(let c=0;c<t.lengths[l];c++){const f=int64AsNumber(t.lamports[r]);if(f>a){const d={...this.partialSpanSerializer.deserialize(t.spans[r]),lamport:f,senderID:o};u.push(d),this.emit("Add",{span:d,meta:e})}r++}}}}class CValueList extends AbstractList_CObject{constructor(n,e={}){super(n),this.valueSerializer=e.valueSerializer??DefaultSerializer.getInstance(),this.valueArraySerializer=e.valueArraySerializer!==void 0?e.valueArraySerializer:ArraySerializer.getInstance(this.valueSerializer),this.totalOrder=super.registerCollab("0",t=>new CTotalOrder(t)),this.list=new LocalList(this.totalOrder),this.messenger=super.registerCollab("",t=>new CMessenger(t,{messageSerializer:Uint8ArraySerializer.instance})),this.messenger.on("Message",t=>this.altReceivePrimitive(t.message,t.meta))}altReceivePrimitive(n,e){const t=ValueListMessage.decode(n);switch(t.op){case"insert":{const r=nonNull(t.insert),l=r.data==="value"?[this.valueSerializer.deserialize(r.value)]:this.valueArraySerializer.deserialize(r.valueArray),o=this.totalOrder.getWaypoint(e.senderID,r.counter),a=this.totalOrder.encodeAll(o,r.valueIndex,l.length);this.list.setCreated(a[0],l),this.emit("Insert",{index:this.list.indexOfPosition(a[0]),values:l,positions:a,meta:e});break}case"delete":{const r=t.delete;if(this.list.hasPosition(r)){const l=this.list.getByPosition(r),o=this.list.indexOfPosition(r);this.list.delete(r),this.emit("Delete",{index:o,values:[l],positions:[r],meta:e})}break}default:throw new Error(`Unknown decoded.op: ${t.op}`)}}insert(n,...e){if(n<0||n>this.length)throw new Error(`Index out of bounds: ${n} (length: ${this.length})`);if(e.length===0)return;const t=this.totalOrder.createPositions(n===0?null:this.list.getPosition(n-1),n===this.length?null:this.list.getPosition(n),e.length)[0],[r,l]=this.totalOrder.decode(t),o={counter:r.counter,valueIndex:l===0?void 0:l};return e.length===1?o.value=this.valueSerializer.serialize(e[0]):o.valueArray=this.valueArraySerializer.serialize(e),this.messenger.sendMessage(ValueListMessage.encode({insert:o}).finish()),e[0]}delete(n,e=1){if(n<0)throw new Error(`index out of bounds: ${n}`);if(n+e>this.length)throw new Error(`(index + count) out of bounds: ${n} + ${e} (length: ${this.length})`);for(let t=n+e-1;t>=n;t--)this.messenger.sendMessage(ValueListMessage.encode({delete:this.list.getPosition(t)}).finish())}get(n){return this.list.get(n)}values(){return this.list.values()}get length(){return this.list.length}push(...n){return this.insert(this.length,...n)}unshift(...n){return this.insert(0,...n)}splice(n,e,...t){n<0&&(n+=this.length),n<0&&(n=0),n>this.length&&(n=this.length),e===void 0||e>this.length-n?e=this.length-n:e<0&&(e=0);const r=this.slice(n,n+e);return this.delete(n,e),t.length>0&&this.insert(n,...t),r}slice(n,e){return this.list.slice(n,e)}getPosition(n){return this.list.getPosition(n)}indexOfPosition(n,e="none"){return this.list.indexOfPosition(n,e)}hasPosition(n){return this.list.hasPosition(n)}getByPosition(n){return this.list.getByPosition(n)}positions(){return this.list.positions()}entries(){return this.list.entries()}save(){const n=super.save();return n.self=this.list.save(this.valueArraySerializer),n}load(n,e){if(super.load(n,e),n===null)return;const t=nonNull(n.self);if(this.list.inInitialState){if(this.list.load(t,this.valueArraySerializer),this.list.length>0){const r=new Array(this.list.length),l=new Array(this.list.length);for(const[o,a,u]of this.list.entries())r[o]=a,l[o]=u;this.emit("Insert",{index:0,values:r,positions:l,meta:e})}}else{const r=new LocalList(this.totalOrder);r.load(t,this.valueArraySerializer);const l=[];for(const[u,c,f]of this.list.entries()){const[d,h]=this.totalOrder.decode(f),p=r.getSeen(d);h<p&&!r.hasPosition(f)&&l.push({index:u,positions:[f],values:[c],meta:e})}l.reverse();for(const u of l)this.list.delete(u.positions[0]),this.emit("Delete",u);const o=[];let a=0;for(const[,u,c]of r.entries()){const[f,d]=this.totalOrder.decode(c),h=this.list.getSeen(f);d>=h&&(o.push({index:this.list.indexOfPosition(c,"right")+a,positions:[c],values:[u],meta:e}),a++)}for(const u of o)this.list.set(u.positions[0],u.values[0]),this.emit("Insert",u)}}}const charArraySerializer={serialize(s){return StringSerializer.instance.serialize(s.join(""))},deserialize(s){return[...StringSerializer.instance.deserialize(s)]}};class CRichText extends CObject{constructor(n,e){super(n),this.noGrowAtEnd=new Set((e==null?void 0:e.noGrowAtEnd)??[]),this.text=super.registerCollab("",t=>new CValueList(t,{valueSerializer:StringSerializer.instance,valueArraySerializer:charArraySerializer})),this.spanLog=super.registerCollab("0",t=>new CSpanLog(t,(e==null?void 0:e.formatSerializer)??DefaultSerializer.getInstance())),this.formatList=new LocalList(this.text.totalOrder),this.spanLog.on("Add",t=>this.addSpan(t.span,t.meta)),this.text.on("Insert",t=>this.emit("Insert",{index:t.index,values:t.values.join(""),positions:t.positions,format:this.getFormatInternal(t.positions[0]),meta:t.meta})),this.text.on("Delete",t=>this.emit("Delete",{index:t.index,values:t.values.join(""),positions:t.positions,meta:t.meta}))}addSpan(n,e){this.createData(n.startPosition),n.endPosition!==null&&this.createData(n.endPosition);const t=this.formatList.indexOfPosition(n.startPosition),r=n.endPosition===null?this.formatList.length:this.formatList.indexOfPosition(n.endPosition),l=new SliceBuilder(this,formatChangeEquals);for(let a=t;a<r;a++){const u=this.formatList.getPosition(a),c=nonNull(this.formatList.getByPosition(u));if(this.wins(n,c.normalSpans.get(n.key))){const f=getDataValue(c,!1,n.key),d=getDataValue(c,!0,n.key);c.normalSpans.set(n.key,n),this.wins(n,c.endClosedSpans.get(n.key))?(c.endClosedSpans.delete(n.key),l.add({previousValue:d,format:getDataRecord(c,!0)},u,!0)):l.add(null,u,!0),l.add({previousValue:f,format:getDataRecord(c,!1)},u,!1)}else l.add(null,u,!0)}let o;if(n.endPosition!==null)if(n.endClosed===!0){const a=nonNull(this.formatList.getByPosition(n.endPosition));if(this.wins(n,a.endClosedSpans.get(n.key))&&this.wins(n,a.normalSpans.get(n.key))){const u=getDataValue(a,!0,n.key);a.endClosedSpans.set(n.key,n),l.add({previousValue:u,format:getDataRecord(a,!0)},n.endPosition,!0),o=l.finish(n.endPosition,!1)}else o=l.finish(n.endPosition,!0)}else o=l.finish(n.endPosition,!0);else o=l.finish(null,!1);for(const a of o)a.data!==null&&a.data.previousValue!==n.value&&this.emit("Format",{startIndex:a.startIndex,endIndex:a.endIndex,key:n.key,value:n.value,previousValue:a.data.previousValue,format:a.data.format,meta:e})}createData(n){if(this.formatList.hasPosition(n))return;const e=this.formatList.indexOfPosition(n,"left");if(e===-1)this.formatList.set(n,{normalSpans:new Map,endClosedSpans:new Map});else{const t=this.formatList.get(e);this.formatList.set(n,{normalSpans:new Map(t.normalSpans),endClosedSpans:new Map})}}wins(n,e){return e===void 0||n.lamport>e.lamport||n.lamport===e.lamport&&n.senderID>=e.senderID}insert(n,e,t){if(e.length===0)return;this.text.insert(n,...e);const r=this.text.getPosition(n),l=this.getFormatInternal(r),o=this.text.getPosition(n+e.length-1),a=n+e.length===this.text.length?null:this.text.getPosition(n+e.length);for(const[u,c]of Object.entries(t))if(c!==void 0&&l[u]!==c){const f=this.noGrowAtEnd.has(u);this.spanLog.add(u,c,r,f?o:a,f)}for(const u of Object.keys(l))t[u]===void 0&&this.spanLog.add(u,void 0,r,a,!1)}format(n,e,t,r){if(n<0||n>=this.length)throw new Error(`startIndex out of bounds: ${n} (length: ${this.length})`);if(e<0||e>this.length)throw new Error(`endIndex out of bound: ${e} (length: ${this.length})`);if(e<n)throw new Error(`endIndex ${e} is less than startIndex ${n}`);if(e===n)return;const l=r!==void 0&&this.noGrowAtEnd.has(t),o=l?e-1:e,a=o===this.length?null:this.getPosition(o);this.spanLog.add(t,r,this.getPosition(n),a,l)}delete(n,e){this.text.delete(n,e)}clear(){this.text.clear()}charAt(n){return this.text.get(n)}getFormat(n){return this.getFormatInternal(this.text.getPosition(n))}getFormatInternal(n){const e=this.formatList.indexOfPosition(n,"left");if(e===-1)return{};const t=this.formatList.getPosition(e),r=nonNull(this.formatList.getByPosition(t));return getDataRecord(r,t===n)}values(){return this.text.values()}*entries(){const n=this.text.positions();for(const{index:e,values:t,format:r}of this.formatted())for(let l=0;l<t.length;l++)yield[e+l,t[l],r,n.next().value]}[Symbol.iterator](){return this.formatted()[Symbol.iterator]()}formatted(){const n=new SliceBuilder(this,recordEquals);n.add({},null,!1);for(const[,t,r]of this.formatList.entries())this.text.hasPosition(r)&&n.add(getDataRecord(t,!0),r,!0),n.add(getDataRecord(t,!1),r,!1);return n.finish(null,!1).map(t=>({index:t.startIndex,values:this.text.slice(t.startIndex,t.endIndex).join(""),format:t.data}))}get length(){return this.text.length}toString(){return this.text.slice().join("")}push(n,e){this.insert(this.length,n,e)}unshift(n,e){return this.insert(0,n,e)}splice(n,e,t,r){n<0&&(n+=this.length),n<0&&(n=0),n>this.length&&(n=this.length),e===void 0||e>this.length-n?e=this.length-n:e<0&&(e=0);const l=this.slice(n,n+e);return this.delete(n,e),t!==void 0&&this.insert(n,t,nonNull(r)),l}slice(n,e){return this.text.slice(n,e).join("")}getPosition(n){return this.text.getPosition(n)}indexOfPosition(n,e){return this.text.indexOfPosition(n,e)}hasPosition(n){return this.text.hasPosition(n)}getByPosition(n){return this.text.getByPosition(n)}positions(){return this.text.positions()}get totalOrder(){return this.text.totalOrder}}function getDataValue(s,n,e){var t;return n&&s.endClosedSpans.has(e)?nonNull(s.endClosedSpans.get(e)).value:(t=s.normalSpans.get(e))==null?void 0:t.value}function getDataRecord(s,n){const e={};for(const[t,r]of s.normalSpans)r.value!==void 0&&(e[t]=r.value);if(n)for(const[t,r]of s.endClosedSpans)r.value===void 0?delete e[t]:e[t]=r.value;return e}class SliceBuilder{constructor(n,e){this.list=n,this.equals=e,this.slices=[],this.prevIndex=-1,this.prevData=null}add(n,e,t){let r;e===null?r=0:t?r=this.list.indexOfPosition(e,"right"):r=this.list.indexOfPosition(e,"left")+1,this.prevIndex!==-1&&this.record(this.prevIndex,r,this.prevData),this.prevIndex=r,this.prevData=n}finish(n,e){if(this.prevIndex!==-1){let t;n===null?t=this.list.length:e?t=this.list.indexOfPosition(n,"right"):t=this.list.indexOfPosition(n,"left")+1,this.record(this.prevIndex,t,this.prevData)}return this.slices}record(n,e,t){if(n!==e){if(this.slices.length!==0){const r=this.slices[this.slices.length-1];if(this.equals(r.data,t)){r.endIndex=e;return}}this.slices.push({startIndex:n,endIndex:e,data:t})}}}function recordEquals(s,n){for(const[e,t]of Object.entries(s))if(n[e]!==t)return!1;for(const[e,t]of Object.entries(n))if(s[e]!==t)return!1;return!0}function formatChangeEquals(s,n){return s===null||n===null?s===n:s.previousValue===n.previousValue&&recordEquals(s.format,n.format)}class CText extends CObject{constructor(n){super(n),this.list=super.registerCollab("",e=>new CValueList(e,{valueSerializer:StringSerializer.instance,valueArraySerializer:charArraySerializer})),this.list.on("Insert",e=>this.emit("Insert",{index:e.index,values:e.values.join(""),positions:e.positions,meta:e.meta})),this.list.on("Delete",e=>this.emit("Delete",{index:e.index,values:e.values.join(""),positions:e.positions,meta:e.meta}))}insert(n,e){this.list.insert(n,...e)}delete(n,e=1){this.list.delete(n,e)}clear(){this.list.clear()}charAt(n){return this.list.get(n)}values(){return this.list.values()}[Symbol.iterator](){return this.values()}entries(){return this.list.entries()}get length(){return this.list.length}toString(){return this.list.slice().join("")}push(n){this.insert(this.length,n)}unshift(n){return this.insert(0,n)}splice(n,e,t){n<0&&(n+=this.length),n<0&&(n=0),n>this.length&&(n=this.length),e===void 0||e>this.length-n?e=this.length-n:e<0&&(e=0);const r=this.slice(n,n+e);return this.delete(n,e),t!==void 0&&this.insert(n,t),r}slice(n,e){return this.list.slice(n,e).join("")}getPosition(n){return this.list.getPosition(n)}indexOfPosition(n,e="none"){return this.list.indexOfPosition(n,e)}hasPosition(n){return this.list.hasPosition(n)}getByPosition(n){return this.list.getByPosition(n)}positions(){return this.list.positions()}get totalOrder(){return this.list.totalOrder}}class CCounter extends CPrimitive{constructor(n,e={}){super(n),this.p=new Map,this.n=new Map,this.initialValue=e.initialValue??0,this._value=this.initialValue}add(n){if(!Number.isSafeInteger(n))throw new Error("toAdd must be a safe integer");if(n===0)return;const e=CounterMessage.create(n===1?{}:{arg:n});this.sendPrimitive(CounterMessage.encode(e).finish())}receivePrimitive(n,e){const t=CounterMessage.decode(n),r=int64AsNumber(t.arg);r>0?this.p.set(e.senderID,(this.p.get(e.senderID)??0)+r):this.n.set(e.senderID,(this.n.get(e.senderID)??0)-r),this._value+=r,this.emit("Add",{added:r,value:this._value,meta:e})}get value(){return this._value}savePrimitive(){const n=CounterSave.create({p:Object.fromEntries(this.p),n:Object.fromEntries(this.n)});return CounterSave.encode(n).finish()}loadPrimitive(n,e){if(n===null)return;const t=this._value,r=CounterSave.decode(n);this.mergeOne(this.p,r.p,1),this.mergeOne(this.n,r.n,-1),this._value!==t&&this.emit("Add",{added:this._value-t,value:this._value,meta:e})}mergeOne(n,e,t){for(const[r,l]of Object.entries(e)){const o=n.get(r)??0,a=int64AsNumber(l);a>o&&(n.set(r,a),this._value+=t*(a-o))}}}class BasicVectorClock{constructor(n){this.vcEntries=n}get(n){return this.vcEntries.get(n)??0}}class SendCRDTMeta{constructor(n,e,t,r,l){if(this.senderID=n,this.actualVC=e,this.actualWallClockTime=r,this.actualLamportTimestamp=l,this.vcEntries=new Map,this.wallClockTimeIfRequested=null,this.lamportTimestampIfRequested=null,this.isAutomatic=!1,this.isFrozen=!1,this.senderCounter=nonNull(e.get(n)),this.vcEntries.set(n,this.senderCounter),t.has(n))throw new Error("Internal error: causallyMaximalVCKeys has senderID");this.maximalVCKeyCount=t.size;for(const o of t)this.vcEntries.set(o,nonNull(e.get(o)));this.vectorClock={get:this.vectorClockGet.bind(this)}}vectorClockGet(n){this.isAutomatic&&this.requestVectorClockEntry(n);const e=this.vcEntries.get(n);if(!this.isFrozen&&e===void 0)throw new Error("You must request a vector clock entry (or automatic mode) to access it (entry:"+n+")");return e??0}get wallClockTime(){if(this.isAutomatic)this.requestWallClockTime();else if(!this.isFrozen&&this.wallClockTimeIfRequested===null)throw new Error("You must request wallClockTime (or automatic mode) to access it");return this.wallClockTimeIfRequested}get lamportTimestamp(){if(this.isAutomatic)this.requestLamportTimestamp();else if(!this.isFrozen&&this.lamportTimestampIfRequested===null)throw new Error("You must request lamportTimestamp (or automatic mode) to access it");return this.lamportTimestampIfRequested}requestAutomatic(n){this.isAutomatic=n}requestVectorClockEntry(n){const e=this.actualVC.get(n);if(e===void 0)throw new Error("Unknown replicaID: "+n);this.vcEntries.has(n)||this.vcEntries.set(n,e)}requestWallClockTime(){this.wallClockTimeIfRequested=this.actualWallClockTime}requestLamportTimestamp(){this.lamportTimestampIfRequested=this.actualLamportTimestamp}freeze(){this.isFrozen=!0}toString(){return JSON.stringify({sender:this.senderID,senderCounter:this.senderCounter,vectorClock:Object.entries(this.vcEntries),wallClockTime:this.wallClockTime,lamportTimestamp:this.lamportTimestamp})}}class ReceiveCRDTMeta{constructor(n,e,t,r,l,o){this.senderID=n,this.senderCounter=e,this.vcEntries=t,this.maximalVCKeyCount=r,this.wallClockTime=l,this.lamportTimestamp=o,this.vectorClock=new BasicVectorClock(t)}toString(){return JSON.stringify({sender:this.senderID,senderCounter:this.senderCounter,vectorClock:Object.entries(this.vcEntries),wallClockTime:this.wallClockTime,lamportTimestamp:this.lamportTimestamp})}}const RuntimeMetaSerializer={serialize(s,n){const e=s.runtimeExtra,t=new Array(e.vcEntries.size-1),r=new Array(e.vcEntries.size-1);let l=0;for(const[a,u]of e.vcEntries)a!==e.senderID&&(n?t[l]=n(a):t[l]=a,r[l]=u,l++);const o={senderID:e.senderID,senderCounter:e.senderCounter,vcValues:r,maximalVcKeyCount:e.maximalVCKeyCount===0?void 0:e.maximalVCKeyCount,wallClockTime:e.wallClockTime,lamportTimestamp:e.lamportTimestamp};return n?o.encodedVcKeys=t:o.vcKeys=t,CRDTMessageMetaMessage.encode(o).finish()},deserialize(s,n){const e=CRDTMessageMetaMessage.decode(s),t=new Map;t.set(e.senderID,e.senderCounter);for(let l=0;l<e.vcValues.length;l++){const o=n?n[e.encodedVcKeys[l]]:e.vcKeys[l];t.set(o,e.vcValues[l])}const r=new ReceiveCRDTMeta(e.senderID,e.senderCounter,t,e.maximalVcKeyCount,protobufHas(e,"wallClockTime")?int64AsNumber(e.wallClockTime):null,protobufHas(e,"lamportTimestamp")?int64AsNumber(e.lamportTimestamp):null);return{senderID:r.senderID,updateType:"message",isLocalOp:!1,runtimeExtra:r}}};class LoadCRDTMeta{constructor(n,e,t,r,l){this.senderID=n,this.localLamportTimestamp=r,this.remoteLamportTimestamp=l,this.localVectorClock=new BasicVectorClock(e),this.remoteVectorClock=new BasicVectorClock(t)}toString(){return JSON.stringify({localVectorClock:Object.entries(this.localVectorClock.vcEntries),remoteVectorClock:Object.entries(this.remoteVectorClock.vcEntries)})}}var _a,MessageType;(function(s){s.Merged="m"})(MessageType||(MessageType={}));class MessageSerializer{constructor(){}serialize(n){if(n.length===1){const{messageStacks:e,meta:t}=n[0];return e.push([RuntimeMetaSerializer.serialize(t)]),MessageStacksSerializer.instance.serialize(e)}else{const e=[],t=new Map,r=u=>{let c=t.get(u);return c===void 0&&(c=e.length,e.push(u),t.set(u,c)),c},l=[],o=new Array(n.length);let a=0;for(const{messageStacks:u,meta:c}of n)l.push(...u),l.push([RuntimeMetaSerializer.serialize(c,r)]),o[a]=u.length,a++;return l.push([MessageSerializerMergeInfo.encode({replicaIDs:e,lengths:o}).finish()]),l.push([MessageType.Merged]),MessageStacksSerializer.instance.serialize(l)}}deserialize(n,e=!1){const t=MessageStacksSerializer.instance.deserialize(n),r=t.pop()[0];if(typeof r=="string")switch(r){case MessageType.Merged:{const l=[],o=MessageSerializerMergeInfo.decode(t.pop()[0]);let a=0;for(const u of o.lengths){const c=t.slice(a,a+u),f=RuntimeMetaSerializer.deserialize(t[a+u][0],o.replicaIDs),d={messageStacks:c,meta:f};e&&(d.trMessage=this.serialize([{messageStacks:c.slice(),meta:f}])),l.push(d),a+=u+1}if(a!==t.length)throw new Error("Internal error: lengths/allMessageStacks mismatch");return l}default:throw new Error('Unknown message type "'+r+'"; your @collabs/collabs version may need updating')}else{const l=RuntimeMetaSerializer.deserialize(r);return[{trMessage:e?n:void 0,messageStacks:t,meta:l}]}}}_a=MessageSerializer;MessageSerializer.instance=new _a;class CausalMessageBuffer{constructor(n,e,t){this.replicaID=n,this.causalityGuaranteed=e,this.deliver=t,this.vc=new Map,this.maximalVCKeys=new Set,this.lamportTimestamp=0,this.buffer=new Map,this.vc.set(this.replicaID,0)}encodeDot(n){return`${n.senderCounter},${n.senderID}`}process(n,e,t,r){const l=t.runtimeExtra;if(!this.isAlreadyDelivered(l)){if(this.isReady(l))return this.deliver(n,e,t,r),this.processRemoteDelivery(l),!0;{const o=this.encodeDot(l);this.buffer.has(o)||this.buffer.set(o,{message:n,messageStacks:e,meta:t,caller:r})}}return!1}check(){let n=!1,e=!1;do{e=!1;for(const[t,r]of this.buffer){const l=r.meta.runtimeExtra;this.isReady(l)?(this.buffer.delete(t),this.deliver(r.message,r.messageStacks,r.meta,r.caller),this.processRemoteDelivery(l),n=!0,e=!0):this.isAlreadyDelivered(l)&&this.buffer.delete(t)}}while(e);return n}isReady(n){if(this.causalityGuaranteed)return!0;if((this.vc.get(n.senderID)??0)!==n.senderCounter-1)return!1;let e=0;for(const[t,r]of n.vcEntries)if(t!==n.senderID){if(e===n.maximalVCKeyCount)break;if((this.vc.get(t)??0)<r)return!1;e++}return!0}isAlreadyDelivered(n){const e=this.vc.get(n.senderID);return e!==void 0&&e>=n.senderCounter}processRemoteDelivery(n){if(!this.causalityGuaranteed){let e=0;for(const[t,r]of n.vcEntries)if(t!==n.senderID){if(e===n.maximalVCKeyCount)break;this.vc.get(t)===r&&this.maximalVCKeys.delete(t),e++}this.maximalVCKeys.add(n.senderID)}this.vc.set(n.senderID,n.senderCounter),this.lamportTimestamp=Math.max(this.lamportTimestamp,n.lamportTimestamp??0)}tick(){this.vc.set(this.replicaID,nonNull(this.vc.get(this.replicaID))+1),this.causalityGuaranteed||this.maximalVCKeys.clear(),this.lamportTimestamp++}save(){const n=new Array(this.vc.size),e=new Array(this.vc.size);let t=0;for(const[o,a]of this.vc)n[t]=o,e[t]=a,t++;const r=new Array(this.buffer.size);t=0;for(const o of this.buffer.values())r[t]=o.message,t++;const l=CausalMessageBufferSave.create({vcKeys:n,vcValues:e,maximalVcKeys:[...this.maximalVCKeys],lamportTimestamp:this.lamportTimestamp,bufferMessages:r});return CausalMessageBufferSave.encode(l).finish()}load(n,e){const t=new Map(this.vc),r=this.lamportTimestamp,l=CausalMessageBufferSave.decode(n),o=new Map;for(let c=0;c<l.vcKeys.length;c++)o.set(l.vcKeys[c],int64AsNumber(l.vcValues[c]));const a=new Set(l.maximalVcKeys);for(const c of this.maximalVCKeys){const f=nonNull(this.vc.get(c)),d=o.get(c)??0;a.has(c)&&f===d||d>=f&&this.maximalVCKeys.delete(c)}for(const c of a)(this.vc.get(c)??0)<nonNull(o.get(c))&&this.maximalVCKeys.add(c);this.maximalVCKeys.delete(this.replicaID);for(const[c,f]of o)this.vc.set(c,Math.max(this.vc.get(c)??0,f));const u=int64AsNumber(l.lamportTimestamp);this.lamportTimestamp=Math.max(this.lamportTimestamp,u);for(let c=0;c<l.bufferMessages.length;c++){const f=l.bufferMessages[c],{messageStacks:d,meta:h}=MessageSerializer.instance.deserialize(f)[0],p=this.encodeDot(h.runtimeExtra);this.buffer.has(p)||this.buffer.set(p,{message:f,messageStacks:d,meta:h,caller:e})}return new LoadCRDTMeta(l.vcKeys[0],t,o,r,u)}}class PublicCObject extends CObject{registerCollab(n,e){return super.registerCollab(n,e)}}class CRuntime extends AbstractRuntime{constructor(n={}){super(n.debugReplicaID??ReplicaIDs.random()),this.used=!1,this.inReceiveOrLoad=!1,this.inTransaction=!1,this.crdtMeta=null,this.meta=null,this.messageBatches=[],this.inBatchRemote=!1,this.batchChanged=!1,this.isCRDTRuntime=!0;const e=n.causalityGuaranteed??!1;this.autoTransactions=n.autoTransactions??"microtask",this.allowRedundantLoads=n.allowRedundantLoads??!1,this.registry=super.setRootCollab(t=>new PublicCObject(t)),this.buffer=new CausalMessageBuffer(this.replicaID,e,this.deliverFromBuffer.bind(this))}registerCollab(n,e){if(this.used)throw new Error("Already used (sent/received message or loaded state)");return this.registry.registerCollab(n,e)}beginTransaction(){this.inTransaction=!0}endTransaction(){if(this.inTransaction=!1,this.meta===null)return;const n=this.meta,e=nonNull(this.crdtMeta);e.freeze();const t=MessageSerializer.instance.serialize([{messageStacks:this.messageBatches,meta:n}]);this.messageBatches=[],this.meta=null,this.crdtMeta=null,this.emit("Send",{message:t,senderID:this.replicaID,senderCounter:e.senderCounter}),this.emit("Update",{update:t,caller:void 0,updateType:"message",senderID:this.replicaID,senderCounter:e.senderCounter,isLocalOp:!0}),this.emit("Change",{isLocalOp:!0})}transact(n){if(this.inTransaction)n();else{this.beginTransaction();try{n()}finally{this.endTransaction()}}}childSend(n,e,t){if(n!==this.rootCollab)throw new Error(`childSend called by non-root: ${n}`);if(this.inReceiveOrLoad)throw new Error("CRuntime.send called during a receive/load call; did you try to perform an operation in an event handler?");this.used=!0;let r=!1;if(!this.inTransaction)switch(this.autoTransactions){case"microtask":this.beginTransaction(),Promise.resolve().then(()=>this.endTransaction());break;case"debugOp":this.beginTransaction(),r=!0;break;case"error":throw new Error('Operation outside of transaction when options.autoTransactions = "error"')}try{if(this.meta===null){const o=new Set(this.buffer.maximalVCKeys);this.buffer.tick(),this.crdtMeta=new SendCRDTMeta(this.replicaID,this.buffer.vc,o,Date.now(),this.buffer.lamportTimestamp),this.meta={senderID:this.replicaID,updateType:"message",isLocalOp:!0,runtimeExtra:this.crdtMeta}}const l=nonNull(this.crdtMeta);l.requestAutomatic(!0);for(const o of t)if(o.lamportTimestamp&&l.requestLamportTimestamp(),o.wallClockTime&&l.requestWallClockTime(),o.vectorClockKeys)for(const a of o.vectorClockKeys)l.requestVectorClockEntry(a);this.rootCollab.receive(e.slice(),this.meta),l.requestAutomatic(!1),this.messageBatches.push(e)}finally{r&&this.endTransaction()}}batchRemoteUpdates(n){if(this.inTransaction)throw new Error("Cannot apply remote updates during a local transaction");if(this.inBatchRemote)n();else{this.inBatchRemote=!0,this.batchChanged=!1;try{n()}finally{this.inBatchRemote=!1,this.batchChanged&&this.emit("Change",{isLocalOp:!1})}}}receive(n,e){if(this.inTransaction)throw new Error("Cannot call receive() during a transaction");if(this.inReceiveOrLoad)throw new Error("Cannot call receive() during another receive/load call; did you try to deliver a message in a Collab's event handler?");this.used=!0,this.batchRemoteUpdates(()=>{this.inReceiveOrLoad=!0;try{const t=MessageSerializer.instance.deserialize(n,!0);let r=!1;for(const{trMessage:l,messageStacks:o,meta:a}of t)this.buffer.process(l,o,a,e)&&(r=!0,this.batchChanged=!0);r&&this.buffer.check()}finally{this.inReceiveOrLoad=!1}})}deliverFromBuffer(n,e,t,r){for(const o of e)this.rootCollab.receive(o,t);const l=t.runtimeExtra;this.emit("Update",{update:n,caller:r,updateType:"message",senderID:l.senderID,senderCounter:l.senderCounter,isLocalOp:!1})}save(){if(this.inTransaction)throw new Error("Cannot call save() during a transaction");if(this.inReceiveOrLoad)throw new Error("Cannot call save() during a load/receive call");const n=this.rootCollab.save();return n.self=this.buffer.save(),SavedStateTreeSerializer.instance.serialize(n)}load(n,e){if(this.inTransaction)throw new Error("Cannot call load() during a transaction");if(this.inReceiveOrLoad)throw new Error("Cannot call load() during another receive/load call; did you try to load in a Collab's event handler?");this.used=!0,this.batchRemoteUpdates(()=>{this.inReceiveOrLoad=!0;try{const t=SavedStateTreeSerializer.instance.deserialize(n),r=this.buffer.load(nonNull(t.self),e);t.self=void 0;const l={updateType:"savedState",runtimeExtra:r,isLocalOp:!1};let o=!0;const a=new Map,u=new Map;for(const[c,f]of r.remoteVectorClock.vcEntries){a.set(c,f);const d=r.localVectorClock.get(c);u.set(c,Math.min(d,f)),d<f&&(o=!1)}o&&!this.allowRedundantLoads?this.buffer.check()&&(this.batchChanged=!0):(this.rootCollab.load(t,l),this.batchChanged=!0,this.emit("Update",{update:n,caller:e,updateType:"savedState",vectorClock:a,redundant:u,isLocalOp:!1}),this.buffer.check())}finally{this.inReceiveOrLoad=!1}})}vectorClock(){const n=new Map(this.buffer.vc);return n.get(this.replicaID)===0&&n.delete(this.replicaID),n}}const runtimeEventNames=["Change","Update","Send"];class AbstractDoc extends EventEmitter$1{constructor(n){super(),this.runtime=new CRuntime(n);for(const e of runtimeEventNames)this.runtime.on(e,t=>this.emit(e,t))}transact(n){this.runtime.transact(n)}batchRemoteUpdates(n){this.runtime.batchRemoteUpdates(n)}receive(n,e){this.runtime.receive(n,e)}save(){return this.runtime.save()}load(n,e){this.runtime.load(n,e)}idOf(n){if(n.runtime!==this.runtime)throw new Error("idOf called with Collab from different AbstractDoc");return this.runtime.idOf(n)}fromID(n){return this.runtime.fromID(n)}get replicaID(){return this.runtime.replicaID}vectorClock(){return this.runtime.vectorClock()}}function mergeMessages(s){if(s.length===0)throw new Error("messages.length is 0");if(s.length===1)return s[0];const n=[];for(const e of s)n.push(...MessageSerializer.instance.deserialize(e));return MessageSerializer.instance.serialize(n)}class TestingRuntimes{constructor(){this.messageQueues=new Map,this.sentBytes=new Map,this.receivedBytes=new Map,this.lastMessage=void 0}newRuntime(n={}){const e=n.rng?ReplicaIDs.pseudoRandom(n.rng):void 0,t=new CRuntime({autoTransactions:"debugOp",debugReplicaID:e,causalityGuaranteed:n.causalityGuaranteed,allowRedundantLoads:!(n.skipRedundantLoads??!1)}),r=new Map;for(const[l,o]of this.messageQueues)r.set(l,[]),o.set(t,[]);return this.messageQueues.set(t,r),this.sentBytes.set(t,0),this.receivedBytes.set(t,0),t.on("Send",l=>{this.sentBytes.set(t,nonNull(this.sentBytes.get(t))+l.message.byteLength);for(const o of r.values())o.push(l.message);this.lastMessage=l.message}),t}release(n,...e){e.length===0&&(e=[...this.messageQueues.keys()]);const t=nonNull(this.messageQueues.get(n));for(const r of e)if(r!==n){for(const l of nonNull(t.get(r)))this.receivedBytes.set(r,nonNull(this.receivedBytes.get(r))+l.byteLength),r.receive(l);t.set(r,[])}}releaseAll(){for(const n of this.messageQueues.keys())this.release(n)}getTotalSentBytes(){let n=0;for(const e of this.sentBytes.values())n+=e;return n}}const collabs=Object.freeze(Object.defineProperty({__proto__:null,AbstractDoc,AbstractList_CObject,AbstractList_CPrimitive,AbstractList_Collab,AbstractList_PrimitiveCRDT,AbstractMap_CObject,AbstractMap_CPrimitive,AbstractMap_Collab,AbstractMap_PrimitiveCRDT,AbstractRuntime,AbstractSet_CObject,AbstractSet_CPrimitive,AbstractSet_Collab,AbstractSet_PrimitiveCRDT,CBoolean,CConst,CCounter,CLazyMap,CList,CMap,CMessenger,CObject,CPresence,CPrimitive,CRichText,CRuntime,CSet,CText,CTotalOrder,CValueList,CValueMap,CValueSet,CVar,Collab,Cursors,DefaultSerializer,EventEmitter:EventEmitter$1,InitToken,LocalList,Optional,PrimitiveCRDT,ReplicaIDs,StringSerializer,TestingRuntimes,Waypoint,mergeMessages},Symbol.toStringTag,{value:"Module"})),updatesBeforeCheckpoint$1=100,checkpointInterval$1=1e4,objectStoreName="updates";class IndexedDBDocStore extends EventEmitter$1{constructor(n={}){var e;super(),this.db=null,this.subs=new Map,this.docsByID=new Map,this.closed=!1,this.onError=t=>{this.emit("Error",{err:t})},this.onUpdate=(t,r)=>{if(t.caller===this||typeof t.caller=="object"&&t.caller.isTabSyncNetwork===!0)return;const l=this.subs.get(r);l!==void 0&&(t.updateType==="message"?l.currentUpdates.size>=updatesBeforeCheckpoint$1&&Date.now()>=l.lastCheckpointTime+checkpointInterval$1?setTimeout(()=>void this.checkpoint(r,l),0):this.appendMessage(r,l,t.update):setTimeout(()=>void this.checkpoint(r,l),0))},this.dbName=(e=n.dbName)!==null&&e!==void 0?e:"@collabs/indexeddb",this.dbPromise=new Promise((t,r)=>{const l=indexedDB.open(this.dbName,1);l.onupgradeneeded=()=>{l.result.createObjectStore(objectStoreName,{autoIncrement:!0}).createIndex("docID","docID",{unique:!1})},l.onsuccess=()=>{this.db=l.result,this.db.onerror=this.onError,t(l.result)},l.onerror=o=>{this.onError(o),r(o)}})}trFinish(n){return new Promise(e=>{n.oncomplete=()=>e(!0),n.onabort=()=>e(!1),n.onerror=()=>e(!1)})}subscribe(n,e){if(this.closed)throw new Error("Already closed");if(this.subs.has(n))throw new Error("doc is already subscribed to a docID");if(this.docsByID.has(e))throw new Error("Unsupported: multiple docs with same docID");const t={docID:e,currentUpdates:new Set,lastCheckpointTime:0};this.subs.set(n,t),this.docsByID.set(e,n),this.subscribeAsync(n,e,t)}async subscribeAsync(n,e,t){let r;try{r=await this.dbPromise}catch{return}if(t.unsubscribed)return;const l=[],o=[];{const a=r.transaction([objectStoreName],"readonly"),c=a.objectStore(objectStoreName).index("docID").openCursor(e);if(c.onsuccess=()=>{const f=c.result;if(!f)return;const d=f.value;typeof d=="object"&&(d.savedState!==void 0&&(l.push(d.savedState),t.currentUpdates.add(f.primaryKey)),d.message!==void 0&&(o.push(d.message),t.currentUpdates.add(f.primaryKey))),f.continue()},!await this.trFinish(a))return}t.unsubscribed||(n.batchRemoteUpdates(()=>{for(const a of l)n.load(a,this);for(const a of o)n.receive(a,this)}),this.emit("Load",{doc:n,docID:e}),await new Promise(a=>setTimeout(a,0)),!t.unsubscribed&&(t.off=n.on("Update",this.onUpdate),await this.checkpoint(n,t)))}unsubscribe(n){const e=this.subs.get(n);e!==void 0&&(e.unsubscribed=!0,this.subs.delete(n),this.docsByID.delete(e.docID),e.off!==void 0&&e.off())}async appendMessage(n,e,t){const l=nonNull(this.db).transaction([objectStoreName],"readwrite"),a=l.objectStore(objectStoreName).add({docID:e.docID,message:t});await this.trFinish(l)&&(e.currentUpdates.add(a.result),this.emit("Save",{doc:n,docID:e.docID}))}async checkpoint(n,e){if(e.unsubscribed)return;const r=nonNull(this.db).transaction([objectStoreName],"readwrite"),l=r.objectStore(objectStoreName),o=[...e.currentUpdates],a=l.add({docID:e.docID,savedState:n.save()});for(const u of o)l.delete(u);if(await this.trFinish(r)){for(const u of o)e.currentUpdates.delete(u);e.currentUpdates.add(a.result),e.lastCheckpointTime=Date.now(),this.emit("Save",{doc:n,docID:e.docID})}}close(){if(!this.closed){this.closed=!0;for(const n of this.subs.keys())this.unsubscribe(n);(async()=>{try{(await this.dbPromise).close()}catch{return}})()}}async delete(n){if(this.closed)throw new Error("Already closed");const t=(await this.dbPromise).transaction([objectStoreName],"readwrite"),r=t.objectStore(objectStoreName),l=r.index("docID").openKeyCursor(n);if(await new Promise((o,a)=>{l.onsuccess=()=>{const u=l.result;if(!u){o();return}r.delete(u.primaryKey),u.continue()},l.onerror=a}),!await this.trFinish(t))throw nonNull(t.error)}async clear(){if(this.closed)throw new Error("Already closed");const e=(await this.dbPromise).transaction([objectStoreName],"readwrite");if(e.objectStore(objectStoreName).clear(),!await this.trFinish(e))throw nonNull(e.error)}async docIDs(){if(this.closed)throw new Error("Already closed");const e=(await this.dbPromise).transaction([objectStoreName],"readonly"),t=e.objectStore(objectStoreName),r=new Set,l=t.index("docID").openKeyCursor(null,"nextunique");if(await new Promise((o,a)=>{l.onsuccess=()=>{const u=l.result;if(!u){o();return}r.add(u.key),u.continue()},l.onerror=a}),!await this.trFinish(e))throw nonNull(e.error);return r}}const updatesBeforeCheckpoint=50,checkpointInterval=5e3;function setBytes(s,n){window.localStorage.setItem(s,fromByteArray_1(n))}function getBytes(s){const n=window.localStorage.getItem(s);return n===null?null:toByteArray_1(n)}function escapeDots(s){return s.replace(/\\/g,"\\\\").replace(/\./g,"\\d")}function unescapeDots(s){let n="";for(let e=0;e<s.length;e++)if(s[e]==="\\")switch(s[e+1]){case"\\":n+="\\",e++;break;case"d":n+=".",e++;break;default:return null}else n+=s[e];return n}class LocalStorageDocStore extends EventEmitter$1{constructor(n={}){var e;super(),this.subs=new Map,this.docsByID=new Map,this.closed=!1,this.onUpdate=(t,r)=>{if(t.caller===this||typeof t.caller=="object"&&t.caller.isTabSyncNetwork===!0)return;const l=this.subs.get(r);if(l!==void 0)if(t.updateType==="message")if(l.currentUpdates.length>=updatesBeforeCheckpoint&&Date.now()>=l.lastCheckpointTime+checkpointInterval)setTimeout(()=>this.checkpoint(r,l),0);else{const o=escapeDots(`${t.senderCounter},${t.senderID}`),a=l.docPrefix+".message"+o;try{setBytes(a,t.update)}catch(u){this.emit("Error",{err:u});return}l.currentUpdates.push(a),this.emit("Save",{doc:r,docID:l.docID})}else setTimeout(()=>this.checkpoint(r,l),0)},this.keyPrefix=(e=n.keyPrefix)!==null&&e!==void 0?e:"@collabs/local-storage",this.keyPrefixDot=this.keyPrefix+"."}getDocPrefix(n){return this.keyPrefix+"."+escapeDots(n)}getOurPrefix(n,e){return this.getDocPrefix(n)+"."+escapeDots(e.replicaID)}subscribe(n,e){if(this.closed)throw new Error("Already closed");if(this.subs.has(n))throw new Error("doc is already subscribed to a docID");if(this.docsByID.has(e))throw new Error("Unsupported: multiple docs with same docID");const t=this.getDocPrefix(e),r=t+".",l=this.getOurPrefix(e,n),o={docID:e,docPrefix:t,ourPrefix:l,saveCounter:0,currentUpdates:[],lastCheckpointTime:0};this.subs.set(n,o),this.docsByID.set(e,n),setTimeout(()=>{if(o.unsubscribed)return;const a=[],u=[];for(let c=0;c<window.localStorage.length;c++){const f=window.localStorage.key(c);if(f!==null&&f.startsWith(r)){let d=f.lastIndexOf(".");const h=f.slice(d+1);try{if(h.startsWith("savedState")){const p=getBytes(f);p!==null&&(a.push(p),o.currentUpdates.push(f))}else if(h.startsWith("message")){const p=getBytes(f);p!==null&&(u.push(p),o.currentUpdates.push(f))}}catch(p){this.emit("Error",{err:p})}}}n.batchRemoteUpdates(()=>{for(const c of a)n.load(c,this);for(const c of u)n.receive(c,this)}),this.emit("Load",{doc:n,docID:e}),setTimeout(()=>{o.unsubscribed||(o.off=n.on("Update",this.onUpdate),this.checkpoint(n,o))})},0)}unsubscribe(n){const e=this.subs.get(n);e!==void 0&&(e.unsubscribed=!0,this.subs.delete(n),this.docsByID.delete(e.docID),e.off!==void 0&&e.off())}checkpoint(n,e){if(e.unsubscribed)return;const t=e.ourPrefix+".savedState"+e.saveCounter,r=n.save();try{setBytes(t,r)}catch(l){this.emit("Error",{err:l});return}for(const l of e.currentUpdates)localStorage.removeItem(l);e.saveCounter++,e.currentUpdates=[t],e.lastCheckpointTime=Date.now(),this.emit("Save",{doc:n,docID:e.docID})}close(){if(!this.closed){this.closed=!0;for(const n of this.subs.keys())this.unsubscribe(n)}}delete(n){const e=[],t=this.getDocPrefix(n)+".";for(let r=0;r<window.localStorage.length;r++){const l=window.localStorage.key(r);l!==null&&l.startsWith(t)&&e.push(l)}for(const r of e)window.localStorage.removeItem(r)}clear(){const n=[];for(let e=0;e<window.localStorage.length;e++){const t=window.localStorage.key(e);t!==null&&t.startsWith(this.keyPrefixDot)&&n.push(t)}for(const e of n)window.localStorage.removeItem(e)}docIDs(){const n=new Set;for(let e=0;e<window.localStorage.length;e++){const t=window.localStorage.key(e);if(t!==null&&t.startsWith(this.keyPrefixDot)){const r=t.slice(this.keyPrefixDot.length),l=r.indexOf(".");if(l===-1)continue;const o=r.slice(0,l),a=unescapeDots(o);a!==null&&n.add(a)}}return n}}class TabSyncNetwork extends EventEmitter$1{constructor(n={}){var e,t;super(),this.subs=new Map,this.docsByID=new Map,this.closed=!1,this.isTabSyncNetwork=!0,this.bcName=(e=n.bcName)!==null&&e!==void 0?e:"@collabs/tab-sync",this.allUpdates=(t=n.allUpdates)!==null&&t!==void 0?t:!1,this.objID=ReplicaIDs.random(),this.bc=new BroadcastChannel(this.bcName),this.bc.addEventListener("message",r=>this.bcReceive(r.data)),this.bc.addEventListener("messageerror",r=>this.emit("Error",{err:r}))}sendInternal(n){this.bc.postMessage(n)}subscribe(n,e){if(this.closed)throw new Error("Already closed");if(this.subs.has(n))throw new Error("doc is already subscribed to a docID");if(this.docsByID.has(e))throw new Error("Unsupported: multiple docs with same docID");const t={docID:e};this.subs.set(n,t),this.docsByID.set(e,n),setTimeout(()=>{t.unsubscribed||(this.sendInternal({type:"join",senderID:this.objID,docID:e,savedState:n.save()}),t.off=n.on("Update",r=>{r.caller!==this&&(this.allUpdates||r.isLocalOp)&&this.sendInternal({type:"update",docID:e,updateType:r.updateType,update:r.update})}))},0)}unsubscribe(n){const e=this.subs.get(n);e!==void 0&&(e.unsubscribed=!0,this.subs.delete(n),this.docsByID.delete(e.docID),e.off!==void 0&&e.off())}bcReceive(n){const e=this.docsByID.get(n.docID);if(e===void 0)return;const t=nonNull(this.subs.get(e));switch(n.type){case"join":this.sendInternal({type:"joinReply",targetID:n.senderID,docID:n.docID,savedState:e.save()}),setTimeout(()=>{t.unsubscribed||e.load(n.savedState,this)});break;case"joinReply":if(n.targetID!==this.objID)return;e.load(n.savedState,this);break;case"update":switch(n.updateType){case"message":e.receive(n.update,this);break;case"savedState":e.load(n.update,this);break;default:this.emit("Error",{err:`Unrecognized message.updateType ${n.updateType} on ${n}`})}break;default:this.emit("Error",{err:`Unrecognized message.type ${n.type} on ${n}`})}}close(){if(!this.closed){this.closed=!0;for(const n of this.subs.keys())this.unsubscribe(n);this.bc.close()}}}const $Reader=minimal.Reader,$Writer=minimal.Writer,$util=minimal.util,$root=minimal.roots.default||(minimal.roots.default={});$root.Subscribe=(()=>{function s(n){if(this.docIDs=[],n)for(let e=Object.keys(n),t=0;t<e.length;++t)n[e[t]]!=null&&(this[e[t]]=n[e[t]])}return s.prototype.docIDs=$util.emptyArray,s.create=function(e){return new s(e)},s.encode=function(e,t){if(t||(t=$Writer.create()),e.docIDs!=null&&e.docIDs.length)for(let r=0;r<e.docIDs.length;++r)t.uint32(10).string(e.docIDs[r]);return t},s.encodeDelimited=function(e,t){return this.encode(e,t).ldelim()},s.decode=function(e,t){e instanceof $Reader||(e=$Reader.create(e));let r=t===void 0?e.len:e.pos+t,l=new $root.Subscribe;for(;e.pos<r;){let o=e.uint32();switch(o>>>3){case 1:l.docIDs&&l.docIDs.length||(l.docIDs=[]),l.docIDs.push(e.string());break;default:e.skipType(o&7);break}}return l},s.decodeDelimited=function(e){return e instanceof $Reader||(e=new $Reader(e)),this.decode(e,e.uint32())},s.verify=function(e){if(typeof e!="object"||e===null)return"object expected";if(e.docIDs!=null&&e.hasOwnProperty("docIDs")){if(!Array.isArray(e.docIDs))return"docIDs: array expected";for(let t=0;t<e.docIDs.length;++t)if(!$util.isString(e.docIDs[t]))return"docIDs: string[] expected"}return null},s.fromObject=function(e){if(e instanceof $root.Subscribe)return e;let t=new $root.Subscribe;if(e.docIDs){if(!Array.isArray(e.docIDs))throw TypeError(".Subscribe.docIDs: array expected");t.docIDs=[];for(let r=0;r<e.docIDs.length;++r)t.docIDs[r]=String(e.docIDs[r])}return t},s.toObject=function(e,t){t||(t={});let r={};if((t.arrays||t.defaults)&&(r.docIDs=[]),e.docIDs&&e.docIDs.length){r.docIDs=[];for(let l=0;l<e.docIDs.length;++l)r.docIDs[l]=e.docIDs[l]}return r},s.prototype.toJSON=function(){return this.constructor.toObject(this,minimal.util.toJSONOptions)},s})();$root.Unsubscribe=(()=>{function s(n){if(n)for(let e=Object.keys(n),t=0;t<e.length;++t)n[e[t]]!=null&&(this[e[t]]=n[e[t]])}return s.prototype.docID="",s.create=function(e){return new s(e)},s.encode=function(e,t){return t||(t=$Writer.create()),t.uint32(10).string(e.docID),t},s.encodeDelimited=function(e,t){return this.encode(e,t).ldelim()},s.decode=function(e,t){e instanceof $Reader||(e=$Reader.create(e));let r=t===void 0?e.len:e.pos+t,l=new $root.Unsubscribe;for(;e.pos<r;){let o=e.uint32();switch(o>>>3){case 1:l.docID=e.string();break;default:e.skipType(o&7);break}}if(!l.hasOwnProperty("docID"))throw $util.ProtocolError("missing required 'docID'",{instance:l});return l},s.decodeDelimited=function(e){return e instanceof $Reader||(e=new $Reader(e)),this.decode(e,e.uint32())},s.verify=function(e){return typeof e!="object"||e===null?"object expected":$util.isString(e.docID)?null:"docID: string expected"},s.fromObject=function(e){if(e instanceof $root.Unsubscribe)return e;let t=new $root.Unsubscribe;return e.docID!=null&&(t.docID=String(e.docID)),t},s.toObject=function(e,t){t||(t={});let r={};return t.defaults&&(r.docID=""),e.docID!=null&&e.hasOwnProperty("docID")&&(r.docID=e.docID),r},s.prototype.toJSON=function(){return this.constructor.toObject(this,minimal.util.toJSONOptions)},s})();$root.Welcome=(()=>{function s(n){if(this.updates=[],this.updateTypes=[],n)for(let e=Object.keys(n),t=0;t<e.length;++t)n[e[t]]!=null&&(this[e[t]]=n[e[t]])}return s.prototype.docID="",s.prototype.savedState=$util.newBuffer([]),s.prototype.updates=$util.emptyArray,s.prototype.updateTypes=$util.emptyArray,s.create=function(e){return new s(e)},s.encode=function(e,t){if(t||(t=$Writer.create()),t.uint32(10).string(e.docID),e.savedState!=null&&Object.hasOwnProperty.call(e,"savedState")&&t.uint32(18).bytes(e.savedState),e.updates!=null&&e.updates.length)for(let r=0;r<e.updates.length;++r)t.uint32(26).bytes(e.updates[r]);if(e.updateTypes!=null&&e.updateTypes.length){t.uint32(34).fork();for(let r=0;r<e.updateTypes.length;++r)t.uint32(e.updateTypes[r]);t.ldelim()}return t},s.encodeDelimited=function(e,t){return this.encode(e,t).ldelim()},s.decode=function(e,t){e instanceof $Reader||(e=$Reader.create(e));let r=t===void 0?e.len:e.pos+t,l=new $root.Welcome;for(;e.pos<r;){let o=e.uint32();switch(o>>>3){case 1:l.docID=e.string();break;case 2:l.savedState=e.bytes();break;case 3:l.updates&&l.updates.length||(l.updates=[]),l.updates.push(e.bytes());break;case 4:if(l.updateTypes&&l.updateTypes.length||(l.updateTypes=[]),(o&7)===2){let a=e.uint32()+e.pos;for(;e.pos<a;)l.updateTypes.push(e.uint32())}else l.updateTypes.push(e.uint32());break;default:e.skipType(o&7);break}}if(!l.hasOwnProperty("docID"))throw $util.ProtocolError("missing required 'docID'",{instance:l});return l},s.decodeDelimited=function(e){return e instanceof $Reader||(e=new $Reader(e)),this.decode(e,e.uint32())},s.verify=function(e){if(typeof e!="object"||e===null)return"object expected";if(!$util.isString(e.docID))return"docID: string expected";if(e.savedState!=null&&e.hasOwnProperty("savedState")&&!(e.savedState&&typeof e.savedState.length=="number"||$util.isString(e.savedState)))return"savedState: buffer expected";if(e.updates!=null&&e.hasOwnProperty("updates")){if(!Array.isArray(e.updates))return"updates: array expected";for(let t=0;t<e.updates.length;++t)if(!(e.updates[t]&&typeof e.updates[t].length=="number"||$util.isString(e.updates[t])))return"updates: buffer[] expected"}if(e.updateTypes!=null&&e.hasOwnProperty("updateTypes")){if(!Array.isArray(e.updateTypes))return"updateTypes: array expected";for(let t=0;t<e.updateTypes.length;++t)if(!$util.isInteger(e.updateTypes[t]))return"updateTypes: integer[] expected"}return null},s.fromObject=function(e){if(e instanceof $root.Welcome)return e;let t=new $root.Welcome;if(e.docID!=null&&(t.docID=String(e.docID)),e.savedState!=null&&(typeof e.savedState=="string"?$util.base64.decode(e.savedState,t.savedState=$util.newBuffer($util.base64.length(e.savedState)),0):e.savedState.length&&(t.savedState=e.savedState)),e.updates){if(!Array.isArray(e.updates))throw TypeError(".Welcome.updates: array expected");t.updates=[];for(let r=0;r<e.updates.length;++r)typeof e.updates[r]=="string"?$util.base64.decode(e.updates[r],t.updates[r]=$util.newBuffer($util.base64.length(e.updates[r])),0):e.updates[r].length&&(t.updates[r]=e.updates[r])}if(e.updateTypes){if(!Array.isArray(e.updateTypes))throw TypeError(".Welcome.updateTypes: array expected");t.updateTypes=[];for(let r=0;r<e.updateTypes.length;++r)t.updateTypes[r]=e.updateTypes[r]>>>0}return t},s.toObject=function(e,t){t||(t={});let r={};if((t.arrays||t.defaults)&&(r.updates=[],r.updateTypes=[]),t.defaults&&(r.docID="",t.bytes===String?r.savedState="":(r.savedState=[],t.bytes!==Array&&(r.savedState=$util.newBuffer(r.savedState)))),e.docID!=null&&e.hasOwnProperty("docID")&&(r.docID=e.docID),e.savedState!=null&&e.hasOwnProperty("savedState")&&(r.savedState=t.bytes===String?$util.base64.encode(e.savedState,0,e.savedState.length):t.bytes===Array?Array.prototype.slice.call(e.savedState):e.savedState),e.updates&&e.updates.length){r.updates=[];for(let l=0;l<e.updates.length;++l)r.updates[l]=t.bytes===String?$util.base64.encode(e.updates[l],0,e.updates[l].length):t.bytes===Array?Array.prototype.slice.call(e.updates[l]):e.updates[l]}if(e.updateTypes&&e.updateTypes.length){r.updateTypes=[];for(let l=0;l<e.updateTypes.length;++l)r.updateTypes[l]=e.updateTypes[l]}return r},s.prototype.toJSON=function(){return this.constructor.toObject(this,minimal.util.toJSONOptions)},s})();$root.SubscribeDenied=(()=>{function s(n){if(n)for(let e=Object.keys(n),t=0;t<e.length;++t)n[e[t]]!=null&&(this[e[t]]=n[e[t]])}return s.prototype.docID="",s.create=function(e){return new s(e)},s.encode=function(e,t){return t||(t=$Writer.create()),t.uint32(10).string(e.docID),t},s.encodeDelimited=function(e,t){return this.encode(e,t).ldelim()},s.decode=function(e,t){e instanceof $Reader||(e=$Reader.create(e));let r=t===void 0?e.len:e.pos+t,l=new $root.SubscribeDenied;for(;e.pos<r;){let o=e.uint32();switch(o>>>3){case 1:l.docID=e.string();break;default:e.skipType(o&7);break}}if(!l.hasOwnProperty("docID"))throw $util.ProtocolError("missing required 'docID'",{instance:l});return l},s.decodeDelimited=function(e){return e instanceof $Reader||(e=new $Reader(e)),this.decode(e,e.uint32())},s.verify=function(e){return typeof e!="object"||e===null?"object expected":$util.isString(e.docID)?null:"docID: string expected"},s.fromObject=function(e){if(e instanceof $root.SubscribeDenied)return e;let t=new $root.SubscribeDenied;return e.docID!=null&&(t.docID=String(e.docID)),t},s.toObject=function(e,t){t||(t={});let r={};return t.defaults&&(r.docID=""),e.docID!=null&&e.hasOwnProperty("docID")&&(r.docID=e.docID),r},s.prototype.toJSON=function(){return this.constructor.toObject(this,minimal.util.toJSONOptions)},s})();$root.Send=(()=>{function s(n){if(n)for(let e=Object.keys(n),t=0;t<e.length;++t)n[e[t]]!=null&&(this[e[t]]=n[e[t]])}return s.prototype.docID="",s.prototype.update=$util.newBuffer([]),s.prototype.updateType=0,s.prototype.localCounter=0,s.create=function(e){return new s(e)},s.encode=function(e,t){return t||(t=$Writer.create()),t.uint32(10).string(e.docID),t.uint32(18).bytes(e.update),t.uint32(24).uint32(e.updateType),t.uint32(32).uint32(e.localCounter),t},s.encodeDelimited=function(e,t){return this.encode(e,t).ldelim()},s.decode=function(e,t){e instanceof $Reader||(e=$Reader.create(e));let r=t===void 0?e.len:e.pos+t,l=new $root.Send;for(;e.pos<r;){let o=e.uint32();switch(o>>>3){case 1:l.docID=e.string();break;case 2:l.update=e.bytes();break;case 3:l.updateType=e.uint32();break;case 4:l.localCounter=e.uint32();break;default:e.skipType(o&7);break}}if(!l.hasOwnProperty("docID"))throw $util.ProtocolError("missing required 'docID'",{instance:l});if(!l.hasOwnProperty("update"))throw $util.ProtocolError("missing required 'update'",{instance:l});if(!l.hasOwnProperty("updateType"))throw $util.ProtocolError("missing required 'updateType'",{instance:l});if(!l.hasOwnProperty("localCounter"))throw $util.ProtocolError("missing required 'localCounter'",{instance:l});return l},s.decodeDelimited=function(e){return e instanceof $Reader||(e=new $Reader(e)),this.decode(e,e.uint32())},s.verify=function(e){return typeof e!="object"||e===null?"object expected":$util.isString(e.docID)?e.update&&typeof e.update.length=="number"||$util.isString(e.update)?$util.isInteger(e.updateType)?$util.isInteger(e.localCounter)?null:"localCounter: integer expected":"updateType: integer expected":"update: buffer expected":"docID: string expected"},s.fromObject=function(e){if(e instanceof $root.Send)return e;let t=new $root.Send;return e.docID!=null&&(t.docID=String(e.docID)),e.update!=null&&(typeof e.update=="string"?$util.base64.decode(e.update,t.update=$util.newBuffer($util.base64.length(e.update)),0):e.update.length&&(t.update=e.update)),e.updateType!=null&&(t.updateType=e.updateType>>>0),e.localCounter!=null&&(t.localCounter=e.localCounter>>>0),t},s.toObject=function(e,t){t||(t={});let r={};return t.defaults&&(r.docID="",t.bytes===String?r.update="":(r.update=[],t.bytes!==Array&&(r.update=$util.newBuffer(r.update))),r.updateType=0,r.localCounter=0),e.docID!=null&&e.hasOwnProperty("docID")&&(r.docID=e.docID),e.update!=null&&e.hasOwnProperty("update")&&(r.update=t.bytes===String?$util.base64.encode(e.update,0,e.update.length):t.bytes===Array?Array.prototype.slice.call(e.update):e.update),e.updateType!=null&&e.hasOwnProperty("updateType")&&(r.updateType=e.updateType),e.localCounter!=null&&e.hasOwnProperty("localCounter")&&(r.localCounter=e.localCounter),r},s.prototype.toJSON=function(){return this.constructor.toObject(this,minimal.util.toJSONOptions)},s})();$root.Receive=(()=>{function s(n){if(n)for(let e=Object.keys(n),t=0;t<e.length;++t)n[e[t]]!=null&&(this[e[t]]=n[e[t]])}return s.prototype.docID="",s.prototype.update=$util.newBuffer([]),s.prototype.updateType=0,s.create=function(e){return new s(e)},s.encode=function(e,t){return t||(t=$Writer.create()),t.uint32(10).string(e.docID),t.uint32(18).bytes(e.update),t.uint32(24).uint32(e.updateType),t},s.encodeDelimited=function(e,t){return this.encode(e,t).ldelim()},s.decode=function(e,t){e instanceof $Reader||(e=$Reader.create(e));let r=t===void 0?e.len:e.pos+t,l=new $root.Receive;for(;e.pos<r;){let o=e.uint32();switch(o>>>3){case 1:l.docID=e.string();break;case 2:l.update=e.bytes();break;case 3:l.updateType=e.uint32();break;default:e.skipType(o&7);break}}if(!l.hasOwnProperty("docID"))throw $util.ProtocolError("missing required 'docID'",{instance:l});if(!l.hasOwnProperty("update"))throw $util.ProtocolError("missing required 'update'",{instance:l});if(!l.hasOwnProperty("updateType"))throw $util.ProtocolError("missing required 'updateType'",{instance:l});return l},s.decodeDelimited=function(e){return e instanceof $Reader||(e=new $Reader(e)),this.decode(e,e.uint32())},s.verify=function(e){return typeof e!="object"||e===null?"object expected":$util.isString(e.docID)?e.update&&typeof e.update.length=="number"||$util.isString(e.update)?$util.isInteger(e.updateType)?null:"updateType: integer expected":"update: buffer expected":"docID: string expected"},s.fromObject=function(e){if(e instanceof $root.Receive)return e;let t=new $root.Receive;return e.docID!=null&&(t.docID=String(e.docID)),e.update!=null&&(typeof e.update=="string"?$util.base64.decode(e.update,t.update=$util.newBuffer($util.base64.length(e.update)),0):e.update.length&&(t.update=e.update)),e.updateType!=null&&(t.updateType=e.updateType>>>0),t},s.toObject=function(e,t){t||(t={});let r={};return t.defaults&&(r.docID="",t.bytes===String?r.update="":(r.update=[],t.bytes!==Array&&(r.update=$util.newBuffer(r.update))),r.updateType=0),e.docID!=null&&e.hasOwnProperty("docID")&&(r.docID=e.docID),e.update!=null&&e.hasOwnProperty("update")&&(r.update=t.bytes===String?$util.base64.encode(e.update,0,e.update.length):t.bytes===Array?Array.prototype.slice.call(e.update):e.update),e.updateType!=null&&e.hasOwnProperty("updateType")&&(r.updateType=e.updateType),r},s.prototype.toJSON=function(){return this.constructor.toObject(this,minimal.util.toJSONOptions)},s})();$root.Ack=(()=>{function s(n){if(n)for(let e=Object.keys(n),t=0;t<e.length;++t)n[e[t]]!=null&&(this[e[t]]=n[e[t]])}return s.prototype.docID="",s.prototype.localCounter=0,s.prototype.checkpointRequest="",s.create=function(e){return new s(e)},s.encode=function(e,t){return t||(t=$Writer.create()),t.uint32(10).string(e.docID),t.uint32(16).uint32(e.localCounter),e.checkpointRequest!=null&&Object.hasOwnProperty.call(e,"checkpointRequest")&&t.uint32(26).string(e.checkpointRequest),t},s.encodeDelimited=function(e,t){return this.encode(e,t).ldelim()},s.decode=function(e,t){e instanceof $Reader||(e=$Reader.create(e));let r=t===void 0?e.len:e.pos+t,l=new $root.Ack;for(;e.pos<r;){let o=e.uint32();switch(o>>>3){case 1:l.docID=e.string();break;case 2:l.localCounter=e.uint32();break;case 3:l.checkpointRequest=e.string();break;default:e.skipType(o&7);break}}if(!l.hasOwnProperty("docID"))throw $util.ProtocolError("missing required 'docID'",{instance:l});if(!l.hasOwnProperty("localCounter"))throw $util.ProtocolError("missing required 'localCounter'",{instance:l});return l},s.decodeDelimited=function(e){return e instanceof $Reader||(e=new $Reader(e)),this.decode(e,e.uint32())},s.verify=function(e){return typeof e!="object"||e===null?"object expected":$util.isString(e.docID)?$util.isInteger(e.localCounter)?e.checkpointRequest!=null&&e.hasOwnProperty("checkpointRequest")&&!$util.isString(e.checkpointRequest)?"checkpointRequest: string expected":null:"localCounter: integer expected":"docID: string expected"},s.fromObject=function(e){if(e instanceof $root.Ack)return e;let t=new $root.Ack;return e.docID!=null&&(t.docID=String(e.docID)),e.localCounter!=null&&(t.localCounter=e.localCounter>>>0),e.checkpointRequest!=null&&(t.checkpointRequest=String(e.checkpointRequest)),t},s.toObject=function(e,t){t||(t={});let r={};return t.defaults&&(r.docID="",r.localCounter=0,r.checkpointRequest=""),e.docID!=null&&e.hasOwnProperty("docID")&&(r.docID=e.docID),e.localCounter!=null&&e.hasOwnProperty("localCounter")&&(r.localCounter=e.localCounter),e.checkpointRequest!=null&&e.hasOwnProperty("checkpointRequest")&&(r.checkpointRequest=e.checkpointRequest),r},s.prototype.toJSON=function(){return this.constructor.toObject(this,minimal.util.toJSONOptions)},s})();$root.CheckpointResponse=(()=>{function s(n){if(n)for(let e=Object.keys(n),t=0;t<e.length;++t)n[e[t]]!=null&&(this[e[t]]=n[e[t]])}return s.prototype.docID="",s.prototype.savedState=$util.newBuffer([]),s.prototype.checkpointRequest="",s.create=function(e){return new s(e)},s.encode=function(e,t){return t||(t=$Writer.create()),t.uint32(10).string(e.docID),t.uint32(18).bytes(e.savedState),t.uint32(26).string(e.checkpointRequest),t},s.encodeDelimited=function(e,t){return this.encode(e,t).ldelim()},s.decode=function(e,t){e instanceof $Reader||(e=$Reader.create(e));let r=t===void 0?e.len:e.pos+t,l=new $root.CheckpointResponse;for(;e.pos<r;){let o=e.uint32();switch(o>>>3){case 1:l.docID=e.string();break;case 2:l.savedState=e.bytes();break;case 3:l.checkpointRequest=e.string();break;default:e.skipType(o&7);break}}if(!l.hasOwnProperty("docID"))throw $util.ProtocolError("missing required 'docID'",{instance:l});if(!l.hasOwnProperty("savedState"))throw $util.ProtocolError("missing required 'savedState'",{instance:l});if(!l.hasOwnProperty("checkpointRequest"))throw $util.ProtocolError("missing required 'checkpointRequest'",{instance:l});return l},s.decodeDelimited=function(e){return e instanceof $Reader||(e=new $Reader(e)),this.decode(e,e.uint32())},s.verify=function(e){return typeof e!="object"||e===null?"object expected":$util.isString(e.docID)?e.savedState&&typeof e.savedState.length=="number"||$util.isString(e.savedState)?$util.isString(e.checkpointRequest)?null:"checkpointRequest: string expected":"savedState: buffer expected":"docID: string expected"},s.fromObject=function(e){if(e instanceof $root.CheckpointResponse)return e;let t=new $root.CheckpointResponse;return e.docID!=null&&(t.docID=String(e.docID)),e.savedState!=null&&(typeof e.savedState=="string"?$util.base64.decode(e.savedState,t.savedState=$util.newBuffer($util.base64.length(e.savedState)),0):e.savedState.length&&(t.savedState=e.savedState)),e.checkpointRequest!=null&&(t.checkpointRequest=String(e.checkpointRequest)),t},s.toObject=function(e,t){t||(t={});let r={};return t.defaults&&(r.docID="",t.bytes===String?r.savedState="":(r.savedState=[],t.bytes!==Array&&(r.savedState=$util.newBuffer(r.savedState))),r.checkpointRequest=""),e.docID!=null&&e.hasOwnProperty("docID")&&(r.docID=e.docID),e.savedState!=null&&e.hasOwnProperty("savedState")&&(r.savedState=t.bytes===String?$util.base64.encode(e.savedState,0,e.savedState.length):t.bytes===Array?Array.prototype.slice.call(e.savedState):e.savedState),e.checkpointRequest!=null&&e.hasOwnProperty("checkpointRequest")&&(r.checkpointRequest=e.checkpointRequest),r},s.prototype.toJSON=function(){return this.constructor.toObject(this,minimal.util.toJSONOptions)},s})();const WSMessage=$root.WSMessage=(()=>{function s(e){if(e)for(let t=Object.keys(e),r=0;r<t.length;++r)e[t[r]]!=null&&(this[t[r]]=e[t[r]])}s.prototype.subscribe=null,s.prototype.unsubscribe=null,s.prototype.welcome=null,s.prototype.subscribeDenied=null,s.prototype.send=null,s.prototype.receive=null,s.prototype.ack=null,s.prototype.checkpointResponse=null;let n;return Object.defineProperty(s.prototype,"type",{get:$util.oneOfGetter(n=["subscribe","unsubscribe","welcome","subscribeDenied","send","receive","ack","checkpointResponse"]),set:$util.oneOfSetter(n)}),s.create=function(t){return new s(t)},s.encode=function(t,r){return r||(r=$Writer.create()),t.subscribe!=null&&Object.hasOwnProperty.call(t,"subscribe")&&$root.Subscribe.encode(t.subscribe,r.uint32(10).fork()).ldelim(),t.unsubscribe!=null&&Object.hasOwnProperty.call(t,"unsubscribe")&&$root.Unsubscribe.encode(t.unsubscribe,r.uint32(18).fork()).ldelim(),t.welcome!=null&&Object.hasOwnProperty.call(t,"welcome")&&$root.Welcome.encode(t.welcome,r.uint32(26).fork()).ldelim(),t.subscribeDenied!=null&&Object.hasOwnProperty.call(t,"subscribeDenied")&&$root.SubscribeDenied.encode(t.subscribeDenied,r.uint32(34).fork()).ldelim(),t.send!=null&&Object.hasOwnProperty.call(t,"send")&&$root.Send.encode(t.send,r.uint32(42).fork()).ldelim(),t.receive!=null&&Object.hasOwnProperty.call(t,"receive")&&$root.Receive.encode(t.receive,r.uint32(50).fork()).ldelim(),t.ack!=null&&Object.hasOwnProperty.call(t,"ack")&&$root.Ack.encode(t.ack,r.uint32(58).fork()).ldelim(),t.checkpointResponse!=null&&Object.hasOwnProperty.call(t,"checkpointResponse")&&$root.CheckpointResponse.encode(t.checkpointResponse,r.uint32(66).fork()).ldelim(),r},s.encodeDelimited=function(t,r){return this.encode(t,r).ldelim()},s.decode=function(t,r){t instanceof $Reader||(t=$Reader.create(t));let l=r===void 0?t.len:t.pos+r,o=new $root.WSMessage;for(;t.pos<l;){let a=t.uint32();switch(a>>>3){case 1:o.subscribe=$root.Subscribe.decode(t,t.uint32());break;case 2:o.unsubscribe=$root.Unsubscribe.decode(t,t.uint32());break;case 3:o.welcome=$root.Welcome.decode(t,t.uint32());break;case 4:o.subscribeDenied=$root.SubscribeDenied.decode(t,t.uint32());break;case 5:o.send=$root.Send.decode(t,t.uint32());break;case 6:o.receive=$root.Receive.decode(t,t.uint32());break;case 7:o.ack=$root.Ack.decode(t,t.uint32());break;case 8:o.checkpointResponse=$root.CheckpointResponse.decode(t,t.uint32());break;default:t.skipType(a&7);break}}return o},s.decodeDelimited=function(t){return t instanceof $Reader||(t=new $Reader(t)),this.decode(t,t.uint32())},s.verify=function(t){if(typeof t!="object"||t===null)return"object expected";let r={};if(t.subscribe!=null&&t.hasOwnProperty("subscribe")){r.type=1;{let l=$root.Subscribe.verify(t.subscribe);if(l)return"subscribe."+l}}if(t.unsubscribe!=null&&t.hasOwnProperty("unsubscribe")){if(r.type===1)return"type: multiple values";r.type=1;{let l=$root.Unsubscribe.verify(t.unsubscribe);if(l)return"unsubscribe."+l}}if(t.welcome!=null&&t.hasOwnProperty("welcome")){if(r.type===1)return"type: multiple values";r.type=1;{let l=$root.Welcome.verify(t.welcome);if(l)return"welcome."+l}}if(t.subscribeDenied!=null&&t.hasOwnProperty("subscribeDenied")){if(r.type===1)return"type: multiple values";r.type=1;{let l=$root.SubscribeDenied.verify(t.subscribeDenied);if(l)return"subscribeDenied."+l}}if(t.send!=null&&t.hasOwnProperty("send")){if(r.type===1)return"type: multiple values";r.type=1;{let l=$root.Send.verify(t.send);if(l)return"send."+l}}if(t.receive!=null&&t.hasOwnProperty("receive")){if(r.type===1)return"type: multiple values";r.type=1;{let l=$root.Receive.verify(t.receive);if(l)return"receive."+l}}if(t.ack!=null&&t.hasOwnProperty("ack")){if(r.type===1)return"type: multiple values";r.type=1;{let l=$root.Ack.verify(t.ack);if(l)return"ack."+l}}if(t.checkpointResponse!=null&&t.hasOwnProperty("checkpointResponse")){if(r.type===1)return"type: multiple values";r.type=1;{let l=$root.CheckpointResponse.verify(t.checkpointResponse);if(l)return"checkpointResponse."+l}}return null},s.fromObject=function(t){if(t instanceof $root.WSMessage)return t;let r=new $root.WSMessage;if(t.subscribe!=null){if(typeof t.subscribe!="object")throw TypeError(".WSMessage.subscribe: object expected");r.subscribe=$root.Subscribe.fromObject(t.subscribe)}if(t.unsubscribe!=null){if(typeof t.unsubscribe!="object")throw TypeError(".WSMessage.unsubscribe: object expected");r.unsubscribe=$root.Unsubscribe.fromObject(t.unsubscribe)}if(t.welcome!=null){if(typeof t.welcome!="object")throw TypeError(".WSMessage.welcome: object expected");r.welcome=$root.Welcome.fromObject(t.welcome)}if(t.subscribeDenied!=null){if(typeof t.subscribeDenied!="object")throw TypeError(".WSMessage.subscribeDenied: object expected");r.subscribeDenied=$root.SubscribeDenied.fromObject(t.subscribeDenied)}if(t.send!=null){if(typeof t.send!="object")throw TypeError(".WSMessage.send: object expected");r.send=$root.Send.fromObject(t.send)}if(t.receive!=null){if(typeof t.receive!="object")throw TypeError(".WSMessage.receive: object expected");r.receive=$root.Receive.fromObject(t.receive)}if(t.ack!=null){if(typeof t.ack!="object")throw TypeError(".WSMessage.ack: object expected");r.ack=$root.Ack.fromObject(t.ack)}if(t.checkpointResponse!=null){if(typeof t.checkpointResponse!="object")throw TypeError(".WSMessage.checkpointResponse: object expected");r.checkpointResponse=$root.CheckpointResponse.fromObject(t.checkpointResponse)}return r},s.toObject=function(t,r){r||(r={});let l={};return t.subscribe!=null&&t.hasOwnProperty("subscribe")&&(l.subscribe=$root.Subscribe.toObject(t.subscribe,r),r.oneofs&&(l.type="subscribe")),t.unsubscribe!=null&&t.hasOwnProperty("unsubscribe")&&(l.unsubscribe=$root.Unsubscribe.toObject(t.unsubscribe,r),r.oneofs&&(l.type="unsubscribe")),t.welcome!=null&&t.hasOwnProperty("welcome")&&(l.welcome=$root.Welcome.toObject(t.welcome,r),r.oneofs&&(l.type="welcome")),t.subscribeDenied!=null&&t.hasOwnProperty("subscribeDenied")&&(l.subscribeDenied=$root.SubscribeDenied.toObject(t.subscribeDenied,r),r.oneofs&&(l.type="subscribeDenied")),t.send!=null&&t.hasOwnProperty("send")&&(l.send=$root.Send.toObject(t.send,r),r.oneofs&&(l.type="send")),t.receive!=null&&t.hasOwnProperty("receive")&&(l.receive=$root.Receive.toObject(t.receive,r),r.oneofs&&(l.type="receive")),t.ack!=null&&t.hasOwnProperty("ack")&&(l.ack=$root.Ack.toObject(t.ack,r),r.oneofs&&(l.type="ack")),t.checkpointResponse!=null&&t.hasOwnProperty("checkpointResponse")&&(l.checkpointResponse=$root.CheckpointResponse.toObject(t.checkpointResponse,r),r.oneofs&&(l.type="checkpointResponse")),l},s.prototype.toJSON=function(){return this.constructor.toObject(this,minimal.util.toJSONOptions)},s})();var UpdateType;(function(s){s[s.Message=1]="Message",s[s.SavedState=2]="SavedState"})(UpdateType||(UpdateType={}));function stringToEnum(s){return s==="message"?UpdateType.Message:UpdateType.SavedState}class WebSocketNetwork extends EventEmitter$1{constructor(n,e={}){var t;super(),this.url=n,this.ws=null,this.localCounter=0,this.subs=new Map,this.docsByID=new Map,this.closed=!1,(!((t=e.connect)!==null&&t!==void 0)||t)&&this.connect()}connect(){if(this.closed)throw new Error("Already closed");if(this.connected)return;const n=new WebSocket(this.url);n.binaryType="arraybuffer",this.ws=n,n.addEventListener("open",()=>{n===this.ws&&(this.docsByID.size!==0&&this.sendInternal({subscribe:{docIDs:[...this.docsByID.keys()]}}),this.emit("Connect",{}))}),n.addEventListener("message",e=>this.wsReceive(e.data)),n.addEventListener("close",e=>this.wsDisconnect(n,"close",e)),n.addEventListener("error",e=>this.wsDisconnect(n,"error",e))}wsDisconnect(n,e,t){n===this.ws&&(this.ws=null,this.emit("Disconnect",{cause:e,wsEvent:t}))}disconnect(){var n;(n=this.ws)===null||n===void 0||n.close(),this.ws=null,this.emit("Disconnect",{cause:"manual",wsEvent:null})}get connected(){return this.ws!==null&&this.ws.readyState===WebSocket.OPEN}sendInternal(n){this.ws!=null&&this.ws.readyState==WebSocket.OPEN&&this.ws.send(WSMessage.encode(n).finish())}subscribe(n,e,t={}){var r,l;if(this.closed)throw new Error("Already closed");if(this.subs.has(n))throw new Error("doc is already subscribed to a docID");if(this.docsByID.has(e))throw new Error("Unsupported: multiple docs with same docID");this.subs.set(n,{docID:e,lastSent:0,nextRemoteBatch:[],nextSendBatch:[],batchRemoteMS:(r=t.batchRemoteMS)!==null&&r!==void 0?r:null,batchSendMS:(l=t.batchSendMS)!==null&&l!==void 0?l:null}),this.docsByID.set(e,n),this.sendInternal({subscribe:{docIDs:[e]}})}setBatchSendMS(n,e){var t;const r=this.subs.get(n);r!==void 0&&((e===null||e<((t=r.batchSendMS)!==null&&t!==void 0?t:0))&&(r.sendBatchTimeout!==void 0&&clearTimeout(r.sendBatchTimeout),this.sendBatch(r)),r.batchSendMS=e)}sendBatch(n){if(n.unsubscribed||n.nextSendBatch.length===0)return;const e=mergeMessages(n.nextSendBatch);n.nextSendBatch=[],n.sendBatchTimeout=void 0,this.sendInternal({send:{docID:n.docID,update:e,updateType:UpdateType.Message,localCounter:++this.localCounter}}),n.lastSent=this.localCounter}unsubscribe(n){const e=this.subs.get(n);e===void 0||e.unsubscribed||(this.sendBatch(e),e.unsubscribed=!0,this.subs.delete(n),this.docsByID.delete(e.docID),e.off!==void 0&&e.off(),this.sendInternal({unsubscribe:{docID:e.docID}}))}wsReceive(n){const e=WSMessage.decode(new Uint8Array(n));switch(e.type){case"welcome":this.onWelcome(e.welcome);break;case"subscribeDenied":this.onSubscribeDenied(e.subscribeDenied);break;case"receive":this.onReceive(e.receive);break;case"ack":{this.onAck(e.ack);break}default:throw new Error("Unexpected WebSocketNetwork message type: "+e.type)}}onWelcome(n){const e=this.docsByID.get(n.docID);if(e===void 0)return;const t=nonNull(this.subs.get(e)),r=e.save();if(t.off===void 0){const l=n.docID;t.off=e.on("Update",o=>{if(o.caller!==this&&!(typeof o.caller=="object"&&o.caller.isTabSyncNetwork===!0)){if(t.batchSendMS!==null)if(o.updateType==="message"){t.nextSendBatch.length===0&&(t.sendBatchTimeout=setTimeout(()=>this.sendBatch(t),t.batchSendMS)),t.nextSendBatch.push(o.update);return}else this.sendBatch(t);this.sendInternal({send:{docID:l,update:o.update,updateType:stringToEnum(o.updateType),localCounter:++this.localCounter}}),t.lastSent=this.localCounter}})}setTimeout(()=>{t.unsubscribed||(e.batchRemoteUpdates(()=>{protobufHas(n,"savedState")&&e.load(n.savedState,this);for(let l=0;l<n.updates.length;l++){const o=n.updates[l],a=n.updateTypes[l];switch(a){case UpdateType.Message:e.receive(o,this);break;case UpdateType.SavedState:e.load(o,this);break;default:throw new Error("Unrecognized UpdateType: "+a)}}}),this.emit("Load",{doc:e,docID:n.docID}),this.sendInternal({send:{docID:n.docID,update:r,updateType:UpdateType.SavedState,localCounter:++this.localCounter}}),t.lastSent=this.localCounter)},0)}onSubscribeDenied(n){const e=this.docsByID.get(n.docID);if(e===void 0)return;const t=nonNull(this.subs.get(e));t.subscribeDenied===void 0&&(this.emit("SubscribeDenied",{doc:e,docID:n.docID}),t.subscribeDenied=!0)}onReceive(n){const e=this.docsByID.get(n.docID);if(e===void 0)return;const t=nonNull(this.subs.get(e));t.batchRemoteMS===null?this.deliver(e,n):(t.nextRemoteBatch.length===0&&setTimeout(()=>this.deliverRemoteBatch(e,t),t.batchRemoteMS),t.nextRemoteBatch.push(n))}deliverRemoteBatch(n,e){e.unsubscribed||(n.batchRemoteUpdates(()=>{for(const t of e.nextRemoteBatch)try{this.deliver(n,t)}catch(r){console.error(r)}}),e.nextRemoteBatch=[])}deliver(n,e){switch(e.updateType){case UpdateType.Message:n.receive(e.update,this);break;case UpdateType.SavedState:n.load(e.update,this);break;default:throw new Error("Unrecognized UpdateType: "+e.updateType)}}onAck(n){const e=this.docsByID.get(n.docID);if(e===void 0)return;const t=nonNull(this.subs.get(e));n.localCounter===t.lastSent&&this.emit("Save",{doc:e,docID:n.docID}),protobufHas(n,"checkpointRequest")&&this.sendInternal({checkpointResponse:{docID:n.docID,savedState:e.save(),checkpointRequest:n.checkpointRequest}})}close(){if(!this.closed){this.closed=!0;for(const n of this.subs.keys())this.unsubscribe(n);this.disconnect()}}}const Collabs={collabs,IndexedDBDocStore,LocalStorageDocStore,TabSyncNetwork,WebSocketNetwork};window.collabs=Collabs;document.dispatchEvent(new CustomEvent("collabs",{detail:Collabs}));
//# sourceMappingURL=index.js.map
